<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Hokkaido 2026 Family Trip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f4f8ff;
      color: #123456;
    }
    .app {
      max-width: 430px;
      margin: 0 auto;
      background: #f4f8ff;
      min-height: 100vh;
    }

    /* é ‚éƒ¨ banner */
    .hero {
      background: linear-gradient(135deg, #bde3ff, #e5f4ff);
      padding: 16px 16px 20px;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    .hero-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 2px;
    }
    .hero-sub {
      margin-top: 4px;
      font-size: 14px;
      opacity: 0.85;
    }
    .hero-tabs {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      overflow-x: auto;
    }
    .day-tab {
      min-width: 64px;
      padding: 8px 10px;
      border-radius: 14px;
      text-align: center;
      font-size: 12px;
      background: rgba(255,255,255,0.6);
      cursor: pointer;
      white-space: nowrap;
    }
    .day-tab.active {
      background: #0b67ff;
      color: #fff;
      font-weight: 600;
    }

    .top-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 8px;
    }
    .top-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    /* å…§å®¹å¡ç‰‡å…±ç”¨ */
    .content {
      padding: 16px;
      padding-bottom: 40px;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    .card-subtitle {
      font-size: 12px;
      opacity: 0.7;
    }
    .icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: #e6f0ff;
    }

    /* å¤©æ°£å¡ç‰‡ */
    .weather-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }
    .weather-temp {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    .weather-temp span:nth-child(1) {
      font-size: 28px;
      font-weight: 700;
    }
    .weather-temp span:nth-child(2) {
      font-size: 12px;
      opacity: 0.7;
    }
    .weather-extra {
      font-size: 12px;
      text-align: right;
    }

    /* è¡Œç¨‹åˆ—è¡¨ */
    .timeline-item {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .timeline-time {
      font-size: 12px;
      font-weight: 600;
      width: 46px;
    }
    .timeline-body {
      flex: 1;
    }
    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f0f3ff;
      margin-bottom: 2px;
    }
    .timeline-title {
      font-size: 13px;
      font-weight: 600;
    }
    .timeline-sub {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }
    .timeline-note {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 2px;
    }

    /* åŒ¯ç‡ */
    .rate-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 13px;
    }
    .rate-row input,
    .rate-row select {
      width: 45%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #d0ddff;
      font-size: 13px;
    }
    .rate-meta {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    /* è³¼ç‰©æ¸…å–® */
    .shopping-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .shopping-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-size: 12px;
    }
    .shopping-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .shopping-note {
      opacity: 0.75;
      font-size: 11px;
      margin-top: 2px;
    }
    .shopping-img {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
      margin-top: 6px;
      max-height: 120px;
    }

    /* è²»ç”¨ç´€éŒ„ */
    .total-card-main {
      font-size: 18px;
      font-weight: 700;
    }
    .total-card-sub {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.85;
    }
    .expense-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f2ff;
    }
    .expense-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .expense-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #c5d8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #fff;
      flex-shrink: 0;
    }
    .expense-text-main {
      font-size: 13px;
      font-weight: 600;
    }
    .expense-text-sub {
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }
    .expense-right {
      text-align: right;
      font-size: 13px;
    }
    .expense-delete {
      color: #ff4d4f;
      font-size: 14px;
      cursor: pointer;
      margin-left: 8px;
    }

    /* æµ®å‹•æ–°å¢æŒ‰éˆ• */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #ffd54f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      cursor: pointer;
      z-index: 20;
    }

    /* modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      width: 90%;
      max-width: 360px;
      background: #fff;
      border-radius: 18px;
      padding: 16px 16px 14px;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 8px;
      font-size: 12px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d0ddff;
      padding: 6px 8px;
      font-size: 13px;
      resize: vertical;
    }
    .upload-box {
      border: 1px dashed #c2ccee;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      font-size: 12px;
      color: #7683a8;
      margin-top: 4px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
    }
    .btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      border: none;
      cursor: pointer;
    }
    .btn-secondary {
      background: #f3f5ff;
      color: #333;
    }
    .btn-primary {
      background: #0b67ff;
      color: #fff;
    }

    .footer-space { height: 80px; }
    @media (min-width: 768px) {
      .fab { right: calc(50% - 215px); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- é ‚éƒ¨ Banner -->
    <header class="hero">
      <div>
        <div class="hero-title">Hokkaido</div>
        [ ç·¨è¼¯è¡Œç¨‹ âœï¸ ]    [ æ›´æ›èƒŒæ™¯ ğŸ–¼ ]    [ åŒ¯å‡º/åŒ¯å…¥è¡Œç¨‹ ğŸ“¦ ]
      </div>

      <!-- æ¨¡æ“¬å³ä¸‹ä¸‰å€‹å°åœ–ç¤º -->
      <div class="top-buttons">
        <div class="top-btn">ğŸ“</div>
        <div class="top-btn">ğŸ§º</div>
        <div class="top-btn">ğŸ’°</div>
      </div>

      <div class="hero-tabs" id="dayTabs"></div>
    </header>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="content">
      <!-- æ¯æ—¥è¡Œç¨‹ + å¤©æ°£ -->
      <section id="dayContent"></section>

      <!-- åŒ¯ç‡å¡ -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">ğŸ’±</span>
            åŒ¯ç‡æ›ç®—
          </div>
          <div class="card-subtitle">JPY â†” TWD</div>
        </div>
        <div class="rate-row">
          <input id="jpyInput" type="number" value="50000" />
          <span>â‡„</span>
          <input id="twdInput" type="number" value="10750" />
        </div>
        <div class="rate-meta" id="rateText"></div>
      </section>

      <!-- è³¼ç‰©æ¸…å–® -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">ğŸ§º</span>
            è³¼ç‰©æ¸…å–®
          </div>
          <div class="card-subtitle">ä¼´æ‰‹ç¦® & å¿…è²·æ¸…å–®</div>
        </div>
        <div class="shopping-grid" id="shoppingGrid"></div>
      </section>

      <!-- è²»ç”¨ç´€éŒ„ -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">ğŸ’³</span>
            è²»ç”¨ç´€éŒ„
          </div>
          <div class="card-subtitle">ä½å®¿ / äº¤é€š / é–€ç¥¨ / é¤é£²</div>
        </div>
        <div class="total-card-main" id="totalJPY">Â¥0</div>
        <div class="total-card-sub" id="totalTWD">ç´„ NT$0</div>

        <div id="expenseList" style="margin-top:10px;"></div>
      </section>

      <div class="footer-space"></div>
    </main>
  </div>

  <!-- æµ®å‹•æ–°å¢æŒ‰éˆ•ï¼šé»ä¸€ä¸‹æœƒå•ä½ è¦æ–°å¢ã€Œè³¼ç‰©ã€é‚„æ˜¯ã€Œè²»ç”¨ã€ -->
  <div class="fab" id="fabBtn">ï¼‹</div>

  <!-- é¸æ“‡æ–°å¢é¡å‹çš„å°å°è©±æ¡† -->
  <div class="modal-overlay" id="typeModal">
    <div class="modal">
      <div class="modal-title">è¦æ–°å¢ä»€éº¼ï¼Ÿ</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="typeCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="addShoppingBtn">è³¼ç‰©æ¸…å–®</button>
        <button class="btn btn-primary" id="addExpenseBtn">è²»ç”¨</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢è³¼ç‰©æ¸…å–® Modal -->
  <div class="modal-overlay" id="shoppingModal">
    <div class="modal">
      <div class="modal-title">æ–°å¢è³¼ç‰©æ¸…å–®</div>
      <div class="form-group">
        <label>å•†å“åç¨±</label>
        <input type="text" id="shoppingName" placeholder="ä¾‹ï¼šå…­èŠ±äº­ å¥¶æ²¹è‘¡è„å¤¾å¿ƒé¤…" />
      </div>
      <div class="form-group">
        <label>å‚™è¨» / å“ªè£¡è²·</label>
        <textarea id="shoppingNote" rows="2" placeholder="ä¾‹ï¼šæ–°åƒæ­²æ©Ÿå ´ / æœ­å¹Œæœ¬åº—"></textarea>
      </div>
      <div class="form-group">
        <label>ä¸Šå‚³ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
        <div class="upload-box">
          <input type="file" id="shoppingImageInput" accept="image/*" />
          <div style="margin-top:4px;">é¸ä¸€å¼µå•†å“åœ–ç‰‡ï¼ˆæœƒå­˜åœ¨é€™å°è£ç½®çš„ç€è¦½å™¨ï¼‰</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="shoppingCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="shoppingSave">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢è²»ç”¨ Modal -->
  <div class="modal-overlay" id="expenseModal">
    <div class="modal">
      <div class="modal-title">æ–°å¢è²»ç”¨ç´€éŒ„</div>
      <div class="form-group">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="expenseTitle" placeholder="ä¾‹ï¼šç™»åˆ¥æº«æ³‰é£¯åº—" />
      </div>
      <div class="form-group">
        <label>é¡åˆ¥</label>
        <select id="expenseCategory">
          <option value="ä½å®¿">ä½å®¿</option>
          <option value="äº¤é€š">äº¤é€š</option>
          <option value="é–€ç¥¨">é–€ç¥¨</option>
          <option value="é¤é£²">é¤é£²</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="expenseDate" />
      </div>
      <div class="form-group">
        <label>ä»˜æ¬¾æ–¹å¼ï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="expenseMethod" placeholder="ä¾‹ï¼šä¿¡ç”¨å¡ / ç¾é‡‘" />
      </div>
      <div class="form-group">
        <label>é‡‘é¡ + å¹£åˆ¥</label>
        <div style="display:flex;gap:8px;">
          <input type="number" id="expenseAmount" placeholder="é‡‘é¡" />
          <select id="expenseCurrency">
            <option value="JPY">JPY</option>
            <option value="TWD">TWD</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="expenseCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="expenseSave">æ–°å¢</button>
      </div>
    </div>
  </div>

  <script>
    // ========= 1. åŸºæœ¬æ—…éŠè³‡æ–™ï¼ˆä½ è¦æ”¹è¡Œç¨‹æ–‡å­—å°±æ”¹é€™è£¡ï¼‰ =========
    const tripData = {
      days: [
        {
          id: "2026-03-06",
          label: "äº” 3/6",
          weather: {
            temp: 0,
            low: -5,
            feels: -8,
            status: "å¤§é›ª / é™é›ª",
            note: "æœ¬æ—¥æ­¥è¡Œ / å¤§çœ¾é‹è¼¸"
          },
          schedule: [
            {
              time: "06:00",
              tag: "æ¡ƒåœ’æ©Ÿå ´å ±åˆ°",
              title: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)",
              sub: "Check-in Â· èˆªç­ CI0130",
              note: "ä¸­è¯èˆªç©º CI0130 08:35 èµ·é£›"
            },
            {
              time: "13:15",
              tag: "æŠµé”åŒ—æµ·é“",
              title: "æ–°åƒæ­²æ©Ÿå ´ (CTS)",
              sub: "å…¥å¢ƒã€é ˜è¡Œæã€æ­ä¹˜å‰å¾€æœ­å¹Œçš„äº¤é€š",
              note: "é ä¼° 15:30 æŠµé”æœ­å¹Œé£¯åº—é™„è¿‘"
            },
            {
              time: "17:30",
              tag: "å…¥ä½é£¯åº—",
              title: "æœ­å¹Œå¤§é€šæ±æ€¥STAYé£¯åº—",
              sub: "3/6 - 3/7 Â· å«æ—©é¤",
              note: "æ”¾è¡Œæå¾Œå¯åˆ°å¤§é€šå…¬åœ’ / ç‹¸å°è·¯æ•£æ­¥"
            }
          ]
        },
        {
          id: "2026-03-07",
          label: "å…­ 3/7",
          weather: {
            temp: -1,
            low: -6,
            feels: -9,
            status: "é™° / å°é›ª",
            note: "å»ºè­°å¤šç©¿ä¸€å±¤ã€é˜²é¢¨å¤–å¥—"
          },
          schedule: [
            {
              time: "09:00",
              tag: "æœ­å¹Œå¸‚å€",
              title: "æœ­å¹Œå¸‚å€æ•£æ­¥ & å’–å•¡",
              sub: "å¤§é€šå…¬åœ’ / æ™‚è¨ˆå° / ç‹¸å°è·¯",
              note: "æ¨è–¦ï¼šé™„è¿‘å’–å•¡åº— & åŒ—è“æ¨“ / å…­èŠ±äº­æœ¬åº—"
            },
            {
              time: "18:00",
              tag: "æ™šé¤",
              title: "æ¹¯å’–å“© / æˆå‰æ€æ±—çƒ¤è‚‰",
              sub: "ä¾å¿ƒæƒ…é¸ä¸€é–“æ’éšŠååº—",
              note: "å¯æå‰æ’éšŠæˆ–ç·šä¸Šç™»è¨˜å€™ä½"
            }
          ]
        }
      ],
      fx: {
        rate: 0.215 // 1 JPY â‰ˆ 0.215 TWDï¼ˆè‡ªå·±æ”¹ï¼‰
      },
      defaultShopping: [
        {
          id: "s1",
          name: "å…­èŠ±äº­ å¥¶æ²¹è‘¡è„å¤¾å¿ƒé¤…",
          note: "æœ­å¹Œæœ¬åº— & æ–°åƒæ­²æ©Ÿå ´"
        },
        {
          id: "s2",
          name: "LeTAO é›™å±¤èµ·å¸è›‹ç³•",
          note: "å°æ¨½æœ¬åº— / æ©Ÿå ´åˆ†åº—"
        },
        {
          id: "s3",
          name: "è–¯æ¢ä¸‰å…„å¼Ÿ",
          note: "Calbee+ / æ–°åƒæ­²æ©Ÿå ´é™å®š"
        }
      ],
      defaultExpenses: [
        {
          id: "e1",
          title: "ç™»åˆ¥æº«æ³‰é£¯åº—",
          category: "ä½å®¿",
          date: "2026-03-09",
          method: "ä¿¡ç”¨å¡",
          amount: 80000,
          currency: "JPY"
        },
        {
          id: "e2",
          title: "å°æ¨½æ°´æ—é¤¨é–€ç¥¨",
          category: "é–€ç¥¨",
          date: "2026-03-07",
          method: "ä¿¡ç”¨å¡",
          amount: 3600,
          currency: "JPY"
        }
      ]
    };

    // ========= 2. è®€å– / å„²å­˜ localStorage =========
    const SHOP_KEY = "hokkaidoShopping";
    const EXP_KEY = "hokkaidoExpenses";

    function loadShopping() {
      const data = localStorage.getItem(SHOP_KEY);
      if (data) return JSON.parse(data);
      return tripData.defaultShopping;
    }
    function saveShopping(list) {
      localStorage.setItem(SHOP_KEY, JSON.stringify(list));
    }

    function loadExpenses() {
      const data = localStorage.getItem(EXP_KEY);
      if (data) return JSON.parse(data);
      return tripData.defaultExpenses;
    }
    function saveExpenses(list) {
      localStorage.setItem(EXP_KEY, JSON.stringify(list));
    }

    let shoppingList = loadShopping();
    let expenseList = loadExpenses();

    // ========= 3. Render è¡Œç¨‹ =========
    const dayTabsEl = document.getElementById("dayTabs");
    const dayContentEl = document.getElementById("dayContent");
    let currentDayIndex = 0;

    function renderTabs() {
      dayTabsEl.innerHTML = "";
      tripData.days.forEach((day, idx) => {
        const tab = document.createElement("div");
        tab.className = "day-tab" + (idx === currentDayIndex ? " active" : "");
        tab.textContent = day.label;
        tab.onclick = () => {
          currentDayIndex = idx;
          renderTabs();
          renderDayContent();
        };
        dayTabsEl.appendChild(tab);
      });
    }

    function renderDayContent() {
      const day = tripData.days[currentDayIndex];
      if (!day) return;
      let html = "";

      html += `
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">â„ï¸</span>
              ${day.weather.temp}â„ƒ / ${day.weather.low}â„ƒ
            </div>
            <div class="card-subtitle">${day.weather.status}</div>
          </div>
          <div class="weather-main">
            <div class="weather-temp">
              <span>${day.weather.temp}Â°</span>
              <span>é«”æ„Ÿ ${day.weather.feels}Â°C</span>
            </div>
            <div class="weather-extra">
              <div>${day.weather.status}</div>
              <div>${day.weather.note}</div>
            </div>
          </div>
        </section>
      `;

      html += `
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">ğŸ—“</span>
              ä»Šæ—¥è¡Œç¨‹
            </div>
            <div class="card-subtitle">${day.label}</div>
          </div>
          ${day.schedule.map(item => `
            <div class="timeline-item">
              <div class="timeline-time">${item.time}</div>
              <div class="timeline-body">
                <div class="tag">${item.tag}</div>
                <div class="timeline-title">${item.title}</div>
                <div class="timeline-sub">${item.sub || ""}</div>
                ${item.note ? `<div class="timeline-note">${item.note}</div>` : ""}
              </div>
            </div>
          `).join("")}
        </section>
      `;

      dayContentEl.innerHTML = html;
    }

    // ========= 4. åŒ¯ç‡æ›ç®— =========
    const jpyInput = document.getElementById("jpyInput");
    const twdInput = document.getElementById("twdInput");
    const rateText = document.getElementById("rateText");

    function updateFromJPY() {
      const jpy = parseFloat(jpyInput.value || "0");
      const twd = Math.round(jpy * tripData.fx.rate);
      twdInput.value = twd;
    }
    function updateFromTWD() {
      const twd = parseFloat(twdInput.value || "0");
      const jpy = Math.round(twd / tripData.fx.rate);
      jpyInput.value = jpy;
    }

    jpyInput.addEventListener("input", updateFromJPY);
    twdInput.addEventListener("input", updateFromTWD);

    function initRate() {
      rateText.textContent = `ç¤ºæ„åŒ¯ç‡ï¼š1 JPY â‰ˆ ${tripData.fx.rate} TWD`;
      updateFromJPY();
    }

    // ========= 5. è³¼ç‰©æ¸…å–® =========
    const shoppingGridEl = document.getElementById("shoppingGrid");

    function renderShopping() {
      shoppingGridEl.innerHTML = shoppingList.map(item => `
        <div class="shopping-card">
          <div class="shopping-name">${item.name}</div>
          ${item.note ? `<div class="shopping-note">${item.note}</div>` : ""}
          ${item.imageData ? `<img class="shopping-img" src="${item.imageData}" alt="">` : ""}
        </div>
      `).join("");
    }

    // ========= 6. è²»ç”¨ç´€éŒ„ =========
    const expenseListEl = document.getElementById("expenseList");
    const totalJPYEl = document.getElementById("totalJPY");
    const totalTWDEl = document.getElementById("totalTWD");

    function calcTotals() {
      let totalJPY = 0;
      expenseList.forEach(item => {
        if (item.currency === "JPY") {
          totalJPY += item.amount;
        } else if (item.currency === "TWD") {
          totalJPY += item.amount / tripData.fx.rate;
        }
      });
      const totalTWD = Math.round(totalJPY * tripData.fx.rate);
      totalJPYEl.textContent = "Â¥" + totalJPY.toLocaleString();
      totalTWDEl.textContent = "ç´„ NT$" + totalTWD.toLocaleString();
    }

    function categoryColor(cat) {
      switch (cat) {
        case "ä½å®¿": return "#ab47bc";
        case "äº¤é€š": return "#29b6f6";
        case "é–€ç¥¨": return "#26a69a";
        case "é¤é£²": return "#ff7043";
        default: return "#78909c";
      }
    }

    function renderExpenses() {
      expenseListEl.innerHTML = expenseList.map(item => `
        <div class="expense-item">
          <div class="expense-left">
            <div class="expense-icon" style="background:${categoryColor(item.category)};">
              ${item.category}
            </div>
            <div>
              <div class="expense-text-main">${item.title}</div>
              <div class="expense-text-sub">
                ${item.date || ""} ${item.method ? " Â· " + item.method : ""}
              </div>
            </div>
          </div>
          <div class="expense-right">
            <div>${item.currency === "JPY" ? "Â¥" : "NT$"}${item.amount.toLocaleString()}</div>
            <span class="expense-delete" data-id="${item.id}">âœ•</span>
          </div>
        </div>
      `).join("");

      // ç¶å®šåˆªé™¤æŒ‰éˆ•
      document.querySelectorAll(".expense-delete").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          expenseList = expenseList.filter(e => e.id !== id);
          saveExpenses(expenseList);
          renderExpenses();
          calcTotals();
        });
      });

      calcTotals();
    }

    // ========= 7. å„ç¨® Modal æ§åˆ¶ =========
    const fabBtn = document.getElementById("fabBtn");
    const typeModal = document.getElementById("typeModal");
    const typeCancel = document.getElementById("typeCancel");
    const addShoppingBtn = document.getElementById("addShoppingBtn");
    const addExpenseBtn = document.getElementById("addExpenseBtn");

    const shoppingModal = document.getElementById("shoppingModal");
    const shoppingCancel = document.getElementById("shoppingCancel");
    const shoppingSave = document.getElementById("shoppingSave");
    const shoppingName = document.getElementById("shoppingName");
    const shoppingNote = document.getElementById("shoppingNote");
    const shoppingImageInput = document.getElementById("shoppingImageInput");

    const expenseModal = document.getElementById("expenseModal");
    const expenseCancel = document.getElementById("expenseCancel");
    const expenseSave = document.getElementById("expenseSave");
    const expenseTitle = document.getElementById("expenseTitle");
    const expenseCategory = document.getElementById("expenseCategory");
    const expenseDate = document.getElementById("expenseDate");
    const expenseMethod = document.getElementById("expenseMethod");
    const expenseAmount = document.getElementById("expenseAmount");
    const expenseCurrency = document.getElementById("expenseCurrency");

    function openModal(m) { m.classList.add("show"); }
    function closeModal(m) { m.classList.remove("show"); }

    fabBtn.addEventListener("click", () => openModal(typeModal));
    typeCancel.addEventListener("click", () => closeModal(typeModal));

    addShoppingBtn.addEventListener("click", () => {
      closeModal(typeModal);
      shoppingName.value = "";
      shoppingNote.value = "";
      shoppingImageInput.value = "";
      openModal(shoppingModal);
    });

    addExpenseBtn.addEventListener("click", () => {
      closeModal(typeModal);
      expenseTitle.value = "";
      expenseMethod.value = "";
      expenseAmount.value = "";
      expenseCurrency.value = "JPY";
      openModal(expenseModal);
    });

    shoppingCancel.addEventListener("click", () => closeModal(shoppingModal));
    expenseCancel.addEventListener("click", () => closeModal(expenseModal));

    // æ–°å¢è³¼ç‰©
    shoppingSave.addEventListener("click", () => {
      const name = shoppingName.value.trim();
      if (!name) {
        alert("è«‹è¼¸å…¥å•†å“åç¨±");
        return;
      }
      const note = shoppingNote.value.trim();

      const file = shoppingImageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageData = e.target.result;
          shoppingList.push({
            id: "s" + Date.now(),
            name,
            note,
            imageData
          });
          saveShopping(shoppingList);
          renderShopping();
        };
        reader.readAsDataURL(file);
      } else {
        shoppingList.push({
          id: "s" + Date.now(),
          name,
          note
        });
        saveShopping(shoppingList);
        renderShopping();
      }

      closeModal(shoppingModal);
    });

    // æ–°å¢è²»ç”¨
    expenseSave.addEventListener("click", () => {
      const title = expenseTitle.value.trim();
      if (!title) {
        alert("è«‹è¼¸å…¥é …ç›®åç¨±");
        return;
      }
      const amount = parseFloat(expenseAmount.value || "0");
      if (!amount || amount <= 0) {
        alert("è«‹è¼¸å…¥é‡‘é¡");
        return;
      }
      const data = {
        id: "e" + Date.now(),
        title,
        category: expenseCategory.value,
        date: expenseDate.value,
        method: expenseMethod.value.trim(),
        amount,
        currency: expenseCurrency.value
      };
      expenseList.push(data);
      saveExpenses(expenseList);
      renderExpenses();
      closeModal(expenseModal);
    });

    // ========= 8. åˆå§‹åŒ– =========
    function init() {
      renderTabs();
      renderDayContent();
      initRate();
      renderShopping();
      renderExpenses();
    }
    init();
  </script>
</body>
</html>
