<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Hokkaido 2025ï½œç›¸è¦ªç›¸æ„›åˆä¸€å¹´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="Hokkaido 2025ï½œç›¸è¦ªç›¸æ„›åˆä¸€å¹´" />
  <meta property="og:description" content="Luna & Jen çš„åŒ—æµ·é“æ»‘é›ªæ—…éŠå°æœ¬ğŸ§£â„ï¸" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://images.pexels.com/photos/792381/pexels-photo-792381.jpeg?auto=compress&cs=tinysrgb&w=1200" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f4f8ff;
      color: #123456;
    }
    .app {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      background: #f4f8ff;
    }

    /* ---------- Header ---------- */
    .hero {
      position: relative;
      padding: 16px 16px 20px;
      background: linear-gradient(135deg, #c7e3ff, #f8fbff);
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      overflow: hidden;
    }
    .hero-bg {
      position: absolute;
      inset: 0;
      background-image: url("https://images.pexels.com/photos/792381/pexels-photo-792381.jpeg?auto=compress&cs=tinysrgb&w=800");
      background-size: cover;
      background-position: center;
      opacity: 0.18;
      pointer-events: none;
    }
    .hero-inner {
      position: relative;
      z-index: 1;
    }
    .hero-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .hero-title-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .hero-icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .hero-title-texts {
      display: flex;
      flex-direction: column;
    }
    .hero-title-texts h1 {
      font-size: 20px;
      letter-spacing: 1px;
    }
    .hero-title-texts span {
      font-size: 12px;
      opacity: 0.9;
    }
    .hero-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pill-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      color: #123456;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .pill-btn.primary {
      background: #4b7cfb;
      color: #fff;
    }

    /* ---------- Common card ---------- */
    .page {
      padding: 12px 16px 24px;
    }
    .card {
      background: #fff;
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(15,30,70,0.08);
      margin-bottom: 16px;
    }
    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-title span.icon {
      font-size: 16px;
    }
    .subtext {
      font-size: 11px;
      color: #788;
    }

    .small-pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: none;
      background: #eef3ff;
      color: #345;
      font-size: 11px;
      cursor: pointer;
    }

    /* ---------- Day selector ---------- */
    .day-scroll {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 4px 0 8px;
    }
    .day-pill {
      flex: 0 0 auto;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid transparent;
      background: #e3ecff;
      color: #345;
      cursor: pointer;
      white-space: nowrap;
    }
    .day-pill.active {
      background: #4b7cfb;
      color: #fff;
    }

    /* ---------- Weather ---------- */
    .weather-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .weather-main {
      font-size: 24px;
      font-weight: 600;
    }
    .weather-sub {
      font-size: 12px;
      color: #456;
      text-align: right;
    }
    .weather-note-input {
      width: 120px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.8);
      padding: 3px 8px;
      font-size: 11px;
      background: rgba(255,255,255,0.9);
      text-align: right;
    }

    /* ---------- Itinerary ---------- */
    .timeline {
      margin-top: 10px;
    }
    .timeline-item {
      display: grid;
      grid-template-columns: 50px 1fr;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px dashed #e2e6f0;
    }
    .timeline-item:last-child {
      border-bottom: none;
    }
    .timeline-time {
      font-size: 12px;
      color: #567;
      padding-top: 4px;
    }
    .timeline-content-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .timeline-content-note {
      font-size: 11px;
      color: #667;
      margin-bottom: 2px;
    }
    .timeline-map-link {
      font-size: 11px;
      color: #4b7cfb;
      text-decoration: none;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #eef3ff;
      color: #456;
    }

    .icon-btn {
      border: none;
      background: transparent;
      font-size: 14px;
      cursor: pointer;
      padding: 0 3px;
    }

    /* ---------- Shopping ---------- */
    .shopping-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .shopping-toolbar select {
      flex: 1;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #dde3f2;
      font-size: 12px;
      background: #f6f8ff;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .shopping-card {
      border-radius: 16px;
      background: #f9fbff;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }
    .shopping-thumb-wrap {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #dde5ff;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .shopping-thumb-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .shopping-name {
      font-size: 12px;
      font-weight: 600;
    }
    .shopping-store {
      font-size: 11px;
      color: #567;
    }
    .shopping-note {
      font-size: 11px;
      color: #789;
    }

    /* image preview overlay */
    #imagePreviewOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    #imagePreviewOverlay img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }

    /* ---------- Expenses ---------- */
    .expense-group-title {
      font-size: 12px;
      font-weight: 600;
      margin: 10px 0 4px;
      color: #567;
    }
    .expense-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 6px 0;
      border-bottom: 1px dashed #e2e6f0;
      font-size: 12px;
    }
    .expense-item:last-child { border-bottom: none; }
    .expense-left {
      max-width: 65%;
    }
    .expense-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .expense-meta {
      font-size: 11px;
      color: #567;
    }
    .expense-amount {
      font-weight: 600;
      color: #e24343;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 4px;
    }

    /* ---------- Modal ---------- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 900;
      padding: 16px;
    }
    .modal {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 18px;
      padding: 14px 14px 16px;
      max-height: 100%;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 8px;
    }
    .form-group label {
      font-size: 12px;
      display: block;
      margin-bottom: 2px;
    }
    .form-group input[type="text"],
    .form-group input[type="time"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #dde3f2;
      background: #f7f8fd;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }
    .btn.secondary {
      background: #e5e7f5;
      color: #345;
    }
    .btn.primary {
      background: #4b7cfb;
      color: #fff;
    }
    .btn.danger {
      background: #ff5c5c;
      color: #fff;
    }

    /* utility */
    .mt-6 { margin-top: 6px; }
    .mt-10 { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="hero">
      <div class="hero-bg"></div>
      <div class="hero-inner">
        <div class="hero-top">
          <div class="hero-title-group">
            <div class="hero-icon">â›·ï¸</div>
            <div class="hero-title-texts">
              <h1>Hokkaido Trip</h1>
              <span>2025 ç›¸è¦ªç›¸æ„›åˆä¸€å¹´</span>
            </div>
          </div>
          <div class="hero-actions">
            <button class="pill-btn" onclick="editTitle()">æ¨™é¡Œ</button>
            <button class="pill-btn primary" onclick="openSyncModal()">è³‡æ–™åŒæ­¥</button>
          </div>
        </div>

        <!-- top quick buttons -->
        <div style="display:flex;gap:10px;margin-bottom:10px;">
          <button class="pill-btn" onclick="scrollToSection('itineraryPage')">è¡Œç¨‹</button>
          <button class="pill-btn" onclick="scrollToSection('shoppingPage')">è³¼ç‰©</button>
          <button class="pill-btn" onclick="scrollToSection('expensePage')">èŠ±è²»</button>
        </div>

        <!-- Day tabs -->
        <div class="day-scroll" id="dayScroll"></div>
      </div>
    </header>

    <!-- Main pages -->
    <main class="page">

      <!-- è¡Œç¨‹ -->
      <section id="itineraryPage">
        <div class="card">
          <div class="card-header-row">
            <div class="card-title">
              <span class="icon">â„ï¸</span> ä»Šæ—¥å¤©æ°£ & è¡Œç¨‹
            </div>
            <div class="subtext" id="todayDayLabel"></div>
          </div>

          <div class="weather-row">
            <div>
              <div style="font-size:12px;margin-bottom:2px;" id="weatherRangeText">-3Â°C / -8Â°C</div>
              <div class="weather-main" id="weatherMainText">-3Â°</div>
              <div class="subtext" id="weatherFeelText">é«”æ„Ÿ -10Â°C</div>
            </div>
            <div class="weather-sub">
              <div style="margin-bottom:4px;">å³å´å°æ¨™é¡Œå¯æ”¹ï¼š</div>
              <input id="weatherNoteInput" class="weather-note-input" type="text" placeholder="ä¾‹å¦‚ï¼šå¸‚å€ & æ›é£¯åº—" />
            </div>
          </div>

          <div class="card-header-row mt-10">
            <div class="card-title">
              <span class="icon">ğŸ—“ï¸</span> ä»Šæ—¥è¡Œç¨‹
            </div>
            <div style="display:flex;gap:6px;">
              <button class="small-pill" onclick="openItineraryModal()">æ–°å¢è¡Œç¨‹</button>
            </div>
          </div>

          <div id="itineraryList" class="timeline"></div>
        </div>
      </section>

      <!-- è³¼ç‰©æ¸…å–® -->
      <section id="shoppingPage">
        <div class="card">
          <div class="card-header-row">
            <div class="card-title">
              <span class="icon">ğŸ§º</span> è³¼ç‰©æ¸…å–®
            </div>
            <button class="small-pill" onclick="openShoppingModal()">æ–°å¢å•†å“</button>
          </div>
          <div class="shopping-toolbar">
            <select id="shoppingStoreFilter" onchange="renderShopping()">
              <option value="ALL">å…¨éƒ¨åº—å®¶</option>
              <option value="ç„¡å°è‰¯å“">ç„¡å°è‰¯å“</option>
              <option value="å¤§å‰µ">å¤§å‰µ</option>
              <option value="3COINS">3COINS</option>
              <option value="Hands">Hands</option>
              <option value="è¶…å•†">è¶…å•†ï¼ˆå…±ç”¨ï¼‰</option>
              <option value="7-11">7-11</option>
              <option value="Lawson">Lawson</option>
              <option value="å…¨å®¶">å…¨å®¶</option>
              <option value="è—¥å¦åº—">è—¥å¦åº—</option>
              <option value="Uniqlo">Uniqlo</option>
              <option value="æ©Ÿå ´/ä¼´æ‰‹ç¦®">æ©Ÿå ´ / ä¼´æ‰‹ç¦®</option>
            </select>
          </div>
          <div id="shoppingGrid" class="grid"></div>
        </div>
      </section>

      <!-- èŠ±è²»ç´€éŒ„ -->
      <section id="expensePage">
        <div class="card">
          <div class="card-header-row">
            <div class="card-title">
              <span class="icon">ğŸ’°</span> èŠ±è²»ç´€éŒ„
            </div>
            <button class="small-pill" onclick="openExpenseModal()">æ–°å¢èŠ±è²»</button>
          </div>
          <div id="expenseList"></div>

          <div class="mt-10" style="border-top:1px solid #eef1fb;padding-top:8px;">
            <div class="card-title" style="font-size:13px;">ç¸½çµ</div>
            <div class="summary-row">
              <span>Luna ç¸½é¡ (NT)ï¼š</span>
              <span id="summaryLuna">-</span>
            </div>
            <div class="summary-row">
              <span>Jen ç¸½é¡ (NT)ï¼š</span>
              <span id="summaryJen">-</span>
            </div>
            <div class="summary-row">
              <span>å…±åŒèŠ±è²» (NT)ï¼š</span>
              <span id="summaryShared">-</span>
            </div>
            <div class="summary-row" style="margin-top:6px;font-weight:600;">
              <span>çµç®—çµæœï¼š</span>
              <span id="settlementText">-</span>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- è¡Œç¨‹ Modal -->
  <div class="modal-overlay" id="itineraryModal">
    <div class="modal">
      <div class="modal-title" id="itineraryModalTitle">æ–°å¢è¡Œç¨‹</div>
      <div class="form-group">
        <label>æ™‚é–“</label>
        <input type="time" id="itineraryTime" />
      </div>
      <div class="form-group">
        <label>æ¨™é¡Œ</label>
        <input type="text" id="itineraryTitle" placeholder="ä¾‹å¦‚ï¼šåŒ—æµ·é“ç¥å®®" />
      </div>
      <div class="form-group">
        <label>èªªæ˜</label>
        <textarea id="itineraryNote" placeholder="é¤å»³ / è¡Œç¨‹å‚™è¨»"></textarea>
      </div>
      <div class="form-group">
        <label>Google Map é€£çµï¼ˆå¯é¸ï¼‰</label>
        <input type="text" id="itineraryMap" placeholder="è²¼ä¸Š Google Map é€£çµ" />
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeItineraryModal()">å–æ¶ˆ</button>
        <button class="btn danger" id="itineraryDeleteBtn" style="display:none;" onclick="deleteItinerary()">åˆªé™¤</button>
        <button class="btn primary" onclick="saveItinerary()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- è³¼ç‰© Modal -->
  <div class="modal-overlay" id="shoppingModal">
    <div class="modal">
      <div class="modal-title" id="shoppingModalTitle">æ–°å¢ / ç·¨è¼¯è³¼ç‰©æ¸…å–®</div>
      <div class="form-group">
        <label>å•†å“åç¨±</label>
        <input type="text" id="shoppingName" placeholder="ä¾‹ï¼šå…­èŠ±äº­ å¥¶æ²¹è‘¡è„å¤¾å¿ƒé¤…" />
      </div>
      <div class="form-group">
        <label>åœ¨å“ªè£¡è²·å¾—åˆ°ï¼ˆåº—å®¶ï¼‰</label>
        <select id="shoppingStore">
          <option value="">æœªæŒ‡å®š</option>
          <option value="ç„¡å°è‰¯å“">ç„¡å°è‰¯å“</option>
          <option value="å¤§å‰µ">å¤§å‰µ</option>
          <option value="3COINS">3COINS</option>
          <option value="Hands">Hands</option>
          <option value="è¶…å•†">è¶…å•†ï¼ˆå…±ç”¨ï¼‰</option>
          <option value="7-11">7-11</option>
          <option value="Lawson">Lawson</option>
          <option value="å…¨å®¶">å…¨å®¶</option>
          <option value="è—¥å¦åº—">è—¥å¦åº—</option>
          <option value="Uniqlo">Uniqlo</option>
          <option value="æ©Ÿå ´/ä¼´æ‰‹ç¦®">æ©Ÿå ´ï¼ä¼´æ‰‹ç¦®</option>
        </select>
      </div>
      <div class="form-group">
        <label>å‚™è¨» / æ¬²è²·æ•¸é‡</label>
        <textarea id="shoppingNote" placeholder="ä¾‹å¦‚ï¼šè‡ªç”¨ 2 ç›’ã€é€äºº 3 ç›’"></textarea>
      </div>
      <div class="form-group">
        <label>å•†å“åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
        <input type="file" accept="image/*" id="shoppingImageInput" />
        <div class="subtext">åœ–ç‰‡æœƒè‡ªå‹•ç¸®å°å¡«æ»¿æ–¹æ ¼ï¼Œé»æ“Šå¡ç‰‡åœ–ç‰‡å¯ä»¥æ”¾å¤§ã€‚</div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeShoppingModal()">å–æ¶ˆ</button>
        <button class="btn danger" id="shoppingDeleteBtn" style="display:none;" onclick="deleteShopping()">åˆªé™¤</button>
        <button class="btn primary" onclick="saveShopping()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- èŠ±è²» Modal -->
  <div class="modal-overlay" id="expenseModal">
    <div class="modal">
      <div class="modal-title" id="expenseModalTitle">æ–°å¢èŠ±è²»</div>
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="expenseDate" />
      </div>
      <div class="form-group">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="expenseName" placeholder="ä¾‹ï¼šKlook ä¸€æ—¥éŠ" />
      </div>
      <div class="form-group">
        <label>ä»˜æ¬¾äºº</label>
        <div style="display:flex;gap:8px;">
          <button id="payerLuna" class="btn secondary" type="button" onclick="setPayer('Luna')">Luna</button>
          <button id="payerJen" class="btn secondary" type="button" onclick="setPayer('Jen')">Jen</button>
          <button id="payerShared" class="btn secondary" type="button" onclick="setPayer('Shared')">å…±åŒ</button>
        </div>
      </div>
      <div class="form-group">
        <label>é‡‘é¡</label>
        <input type="number" id="expenseAmount" step="0.5" placeholder="ä¾‹å¦‚ 7000" />
      </div>
      <div class="form-group">
        <label>å¹£åˆ¥</label>
        <select id="expenseCurrency">
          <option value="TWD">NTD</option>
          <option value="JPY">JPY</option>
        </select>
      </div>
      <div class="form-group">
        <label>å‚™è¨»ï¼ˆå¯å¯«èª°å…ˆä»˜ã€åŒ¯ç‡ç­‰ï¼‰</label>
        <textarea id="expenseNote"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeExpenseModal()">å–æ¶ˆ</button>
        <button class="btn danger" id="expenseDeleteBtn" style="display:none;" onclick="deleteExpense()">åˆªé™¤</button>
        <button class="btn primary" onclick="saveExpense()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- è³‡æ–™åŒæ­¥ Modal -->
  <div class="modal-overlay" id="syncModal">
    <div class="modal" style="max-width:640px;">
      <div class="modal-title">è³‡æ–™åŒæ­¥</div>
      <p style="font-size:12px;line-height:1.6;margin-bottom:8px;">
        é€™è£¡å¯ä»¥åŒ¯å‡ºï¼åŒ¯å…¥æœ¬é æ‰€æœ‰è³‡æ–™ï¼ˆè¡Œç¨‹ã€è³¼ç‰©æ¸…å–®ã€èŠ±è²»ç´€éŒ„ï¼‰ã€‚<br>
        ï¼œåŒ¯å‡ºï¼ åœ¨ä¸»è¦è£ç½®æŒ‰ã€ŒåŒ¯å‡ºã€ï¼Œè¤‡è£½ä¸‹é¢çš„æ–‡å­—ã€‚<br>
        ï¼œåŒ¯å…¥ï¼ åœ¨å¦ä¸€å°è£ç½®é–‹å•ŸåŒä¸€ç¶²å€ï¼Œè²¼ä¸Šæ–‡å­—å¾ŒæŒ‰ã€ŒåŒ¯å…¥ã€ï¼Œå³å¯è¦†è“‹æœ¬è£ç½®çš„è³‡æ–™ã€‚
      </p>
      <textarea
        id="syncTextarea"
        placeholder="æŒ‰ä¸‹ã€ŒåŒ¯å‡ºã€å¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä¸€å¤§æ®µæ–‡å­—ã€‚è«‹å…¨é¸è¤‡è£½ï¼Œåˆ°å¦ä¸€å€‹è£ç½®è²¼ä¸Šå†æŒ‰ã€ŒåŒ¯å…¥ã€ã€‚"
        style="width:100%;height:200px;font-size:11px;white-space:pre;resize:vertical;border-radius:8px;border:1px solid #ddd;padding:6px;box-sizing:border-box;"
      ></textarea>
      <div class="modal-footer">
        <button class="btn secondary" type="button" onclick="exportAllData()">åŒ¯å‡º</button>
        <button class="btn primary" type="button" onclick="importAllData()">åŒ¯å…¥</button>
        <button class="btn secondary" type="button" onclick="closeSyncModal()">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- åœ–ç‰‡æ”¾å¤§ overlay -->
  <div id="imagePreviewOverlay" onclick="hideImagePreview()">
    <img id="imagePreviewImg" src="" alt="preview" />
  </div>

  <script>
    // ====== åŸºæœ¬è¨­å®š ======
    const STORAGE_KEYS = {
      itinerary: "hk_itinerary_v1",
      shopping: "hk_shopping_v3",
      expenses: "hk_expenses_v3",
      header: "hk_header_v1"
    };

    const defaultDays = [
      { id: "d1", label: "Day1 12/24", date: "2025-12-24" },
      { id: "d2", label: "Day2 12/25", date: "2025-12-25" },
      { id: "d3", label: "Day3 12/26", date: "2025-12-26" },
      { id: "d4", label: "Day4 12/27", date: "2025-12-27" },
      { id: "d5", label: "Day5 12/28", date: "2025-12-28" },
      { id: "d6", label: "Day6 12/29", date: "2025-12-29" }
    ];

    let itineraryData = loadJSON(STORAGE_KEYS.itinerary, {
      selectedDayId: "d1",
      days: defaultDays.map(d => ({ ...d, weatherNote: "", items: [] }))
    });

    let shoppingData = loadJSON(STORAGE_KEYS.shopping, {
      items: []
    });

    let expenseData = loadJSON(STORAGE_KEYS.expenses, {
      items: [],
      fxJPY: 0.215 // é è¨­åŒ¯ç‡ï¼Œå¯ä¹‹å¾Œä¾å¯¦éš›ç‹€æ³ä¿®æ”¹
    });

    let headerData = loadJSON(STORAGE_KEYS.header, {
      title: "Hokkaido Trip",
      subtitle: "2025 ç›¸è¦ªç›¸æ„›åˆä¸€å¹´"
    });

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("loadJSON error for key", key, e);
        return fallback;
      }
    }

    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function genId() {
      return "id_" + Math.random().toString(36).slice(2, 9);
    }

    // ====== Header ======
    function renderHeader() {
      document.querySelector(".hero-title-texts h1").textContent = headerData.title;
      document.querySelector(".hero-title-texts span").textContent = headerData.subtitle;
    }

    function editTitle() {
      const newTitle = prompt("ä¸»æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šHokkaido Tripï¼‰", headerData.title);
      if (newTitle !== null && newTitle.trim() !== "") headerData.title = newTitle.trim();
      const newSub = prompt("å‰¯æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼š2025 ç›¸è¦ªç›¸æ„›åˆä¸€å¹´ï¼‰", headerData.subtitle);
      if (newSub !== null && newSub.trim() !== "") headerData.subtitle = newSub.trim();
      renderHeader();
      saveJSON(STORAGE_KEYS.header, headerData);
    }

    function scrollToSection(id) {
      const el = document.getElementById(id);
      if (!el) return;
      window.scrollTo({
        top: el.offsetTop - 70,
        behavior: "smooth"
      });
    }

    // ====== Day Tabs & Itinerary ======
    let currentEditingItineraryId = null;

    function getCurrentDay() {
      return itineraryData.days.find(d => d.id === itineraryData.selectedDayId) || itineraryData.days[0];
    }

    function renderDayTabs() {
      const wrap = document.getElementById("dayScroll");
      wrap.innerHTML = "";
      itineraryData.days.forEach(day => {
        const btn = document.createElement("button");
        btn.className = "day-pill" + (day.id === itineraryData.selectedDayId ? " active" : "");
        btn.textContent = day.label;
        btn.onclick = () => {
          itineraryData.selectedDayId = day.id;
          saveJSON(STORAGE_KEYS.itinerary, itineraryData);
          renderDayTabs();
          renderItinerary();
        };
        wrap.appendChild(btn);
      });
    }

    function renderItinerary() {
      const day = getCurrentDay();
      document.getElementById("todayDayLabel").textContent = day.label;
      document.getElementById("weatherNoteInput").value = day.weatherNote || "";

      // ä¾æ™‚é–“è‡ªå‹•æ’åº
      const sorted = [...(day.items || [])].sort((a, b) => {
        if (!a.time && !b.time) return 0;
        if (!a.time) return 1;
        if (!b.time) return -1;
        return a.time.localeCompare(b.time);
      });

      const list = document.getElementById("itineraryList");
      list.innerHTML = "";
      if (sorted.length === 0) {
        list.innerHTML = '<div class="subtext">é‚„æ²’æœ‰è¡Œç¨‹ï¼Œé»å³ä¸Šã€Œæ–°å¢è¡Œç¨‹ã€ä¾†æ’ä¸€ä¸‹å§ã€‚</div>';
        return;
      }

      sorted.forEach(item => {
        const row = document.createElement("div");
        row.className = "timeline-item";

        const timeDiv = document.createElement("div");
        timeDiv.className = "timeline-time";
        timeDiv.textContent = item.time || "--:--";

        const content = document.createElement("div");
        const titleRow = document.createElement("div");
        titleRow.className = "timeline-content-title";

        const t = document.createElement("div");
        t.textContent = item.title || "(æœªå‘½åè¡Œç¨‹)";
        const r = document.createElement("div");
        r.innerHTML = '<button class="icon-btn" onclick="editItinerary(\'' + item.id + '\')">âœï¸</button>';
        titleRow.appendChild(t);
        titleRow.appendChild(r);

        const note = document.createElement("div");
        note.className = "timeline-content-note";
        note.textContent = item.note || "";

        content.appendChild(titleRow);
        if (item.note) content.appendChild(note);
        if (item.map) {
          const map = document.createElement("a");
          map.className = "timeline-map-link";
          map.href = item.map;
          map.target = "_blank";
          map.textContent = "Google Map";
          content.appendChild(map);
        }

        row.appendChild(timeDiv);
        row.appendChild(content);
        list.appendChild(row);
      });
    }

    function openItineraryModal() {
      currentEditingItineraryId = null;
      document.getElementById("itineraryModalTitle").textContent = "æ–°å¢è¡Œç¨‹";
      document.getElementById("itineraryTime").value = "";
      document.getElementById("itineraryTitle").value = "";
      document.getElementById("itineraryNote").value = "";
      document.getElementById("itineraryMap").value = "";
      document.getElementById("itineraryDeleteBtn").style.display = "none";
      document.getElementById("itineraryModal").style.display = "flex";
    }

    function editItinerary(id) {
      const day = getCurrentDay();
      const item = day.items.find(x => x.id === id);
      if (!item) return;
      currentEditingItineraryId = id;
      document.getElementById("itineraryModalTitle").textContent = "ç·¨è¼¯è¡Œç¨‹";
      document.getElementById("itineraryTime").value = item.time || "";
      document.getElementById("itineraryTitle").value = item.title || "";
      document.getElementById("itineraryNote").value = item.note || "";
      document.getElementById("itineraryMap").value = item.map || "";
      document.getElementById("itineraryDeleteBtn").style.display = "inline-block";
      document.getElementById("itineraryModal").style.display = "flex";
    }

    function closeItineraryModal() {
      document.getElementById("itineraryModal").style.display = "none";
    }

    function saveItinerary() {
      const time = document.getElementById("itineraryTime").value;
      const title = document.getElementById("itineraryTitle").value.trim();
      const note = document.getElementById("itineraryNote").value.trim();
      const map = document.getElementById("itineraryMap").value.trim();
      const day = getCurrentDay();

      if (currentEditingItineraryId) {
        const item = day.items.find(x => x.id === currentEditingItineraryId);
        if (item) {
          item.time = time;
          item.title = title || "(æœªå‘½åè¡Œç¨‹)";
          item.note = note;
          item.map = map;
        }
      } else {
        day.items.push({
          id: genId(),
          time,
          title: title || "(æœªå‘½åè¡Œç¨‹)",
          note,
          map
        });
      }

      saveJSON(STORAGE_KEYS.itinerary, itineraryData);
      closeItineraryModal();
      renderItinerary();
    }

    function deleteItinerary() {
      const day = getCurrentDay();
      if (!currentEditingItineraryId) return;
      const idx = day.items.findIndex(x => x.id === currentEditingItineraryId);
      if (idx >= 0 && confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ")) {
        day.items.splice(idx, 1);
        saveJSON(STORAGE_KEYS.itinerary, itineraryData);
        closeItineraryModal();
        renderItinerary();
      }
    }

    // å¤©æ°£å³é‚Šå°æ¨™é¡Œ
    document.getElementById("weatherNoteInput").addEventListener("change", () => {
      const day = getCurrentDay();
      day.weatherNote = document.getElementById("weatherNoteInput").value.trim();
      saveJSON(STORAGE_KEYS.itinerary, itineraryData);
    });

    // ====== Shopping ======
    let currentEditingShoppingId = null;
    let tempShoppingImageData = null;

    function renderShopping() {
      const grid = document.getElementById("shoppingGrid");
      const filter = document.getElementById("shoppingStoreFilter").value;
      let items = shoppingData.items || [];
      if (filter !== "ALL") {
        items = items.filter(i => i.store === filter);
      }
      grid.innerHTML = "";
      if (items.length === 0) {
        grid.innerHTML = '<div class="subtext">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“ã€‚</div>';
        return;
      }

      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "shopping-card";

        const imgWrap = document.createElement("div");
        imgWrap.className = "shopping-thumb-wrap";
        if (item.image) {
          const img = document.createElement("img");
          img.src = item.image;
          img.alt = item.name || "";
          img.onclick = () => showImagePreview(item.image);
          imgWrap.appendChild(img);
        } else {
          imgWrap.textContent = "ç„¡åœ–ç‰‡";
        }

        const nameDiv = document.createElement("div");
        nameDiv.className = "shopping-name";
        nameDiv.textContent = item.name || "(æœªå‘½åå•†å“)";

        const storeDiv = document.createElement("div");
        storeDiv.className = "shopping-store";
        storeDiv.textContent = item.store || "åº—å®¶æœªæŒ‡å®š";

        const noteDiv = document.createElement("div");
        noteDiv.className = "shopping-note";
        noteDiv.textContent = item.note || "";

        const actions = document.createElement("div");
        actions.style.display = "flex";
        actions.style.justifyContent = "flex-end";
        actions.innerHTML = '<button class="icon-btn" onclick="editShopping(\'' + item.id + '\')">âœï¸</button>';

        card.appendChild(imgWrap);
        card.appendChild(nameDiv);
        card.appendChild(storeDiv);
        if (item.note) card.appendChild(noteDiv);
        card.appendChild(actions);
        grid.appendChild(card);
      });
    }

    function openShoppingModal() {
      currentEditingShoppingId = null;
      tempShoppingImageData = null;
      document.getElementById("shoppingModalTitle").textContent = "æ–°å¢è³¼ç‰©æ¸…å–®";
      document.getElementById("shoppingName").value = "";
      document.getElementById("shoppingStore").value = "";
      document.getElementById("shoppingNote").value = "";
      document.getElementById("shoppingImageInput").value = "";
      document.getElementById("shoppingDeleteBtn").style.display = "none";
      document.getElementById("shoppingModal").style.display = "flex";
    }

    function editShopping(id) {
      const item = (shoppingData.items || []).find(i => i.id === id);
      if (!item) return;
      currentEditingShoppingId = id;
      tempShoppingImageData = item.image || null;
      document.getElementById("shoppingModalTitle").textContent = "ç·¨è¼¯è³¼ç‰©æ¸…å–®";
      document.getElementById("shoppingName").value = item.name || "";
      document.getElementById("shoppingStore").value = item.store || "";
      document.getElementById("shoppingNote").value = item.note || "";
      document.getElementById("shoppingImageInput").value = "";
      document.getElementById("shoppingDeleteBtn").style.display = "inline-block";
      document.getElementById("shoppingModal").style.display = "flex";
    }

    function closeShoppingModal() {
      document.getElementById("shoppingModal").style.display = "none";
      tempShoppingImageData = null;
    }

    document.getElementById("shoppingImageInput").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        tempShoppingImageData = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    function saveShopping() {
      const name = document.getElementById("shoppingName").value.trim();
      const store = document.getElementById("shoppingStore").value;
      const note = document.getElementById("shoppingNote").value.trim();

      if (currentEditingShoppingId) {
        const item = shoppingData.items.find(i => i.id === currentEditingShoppingId);
        if (item) {
          item.name = name || "(æœªå‘½åå•†å“)";
          item.store = store;
          item.note = note;
          if (tempShoppingImageData) item.image = tempShoppingImageData;
        }
      } else {
        shoppingData.items.push({
          id: genId(),
          name: name || "(æœªå‘½åå•†å“)",
          store,
          note,
          image: tempShoppingImageData
        });
      }

      saveJSON(STORAGE_KEYS.shopping, shoppingData);
      closeShoppingModal();
      renderShopping();
    }

    function deleteShopping() {
      if (!currentEditingShoppingId) return;
      if (!confirm("ç¢ºå®šåˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ")) return;
      const idx = shoppingData.items.findIndex(i => i.id === currentEditingShoppingId);
      if (idx >= 0) shoppingData.items.splice(idx, 1);
      saveJSON(STORAGE_KEYS.shopping, shoppingData);
      closeShoppingModal();
      renderShopping();
    }

    function showImagePreview(src) {
      const overlay = document.getElementById("imagePreviewOverlay");
      const img = document.getElementById("imagePreviewImg");
      img.src = src;
      overlay.style.display = "flex";
    }

    function hideImagePreview() {
      document.getElementById("imagePreviewOverlay").style.display = "none";
    }

    // ====== Expenses ======
    let currentEditingExpenseId = null;
    let currentPayer = "Luna";

    function setPayer(payer) {
      currentPayer = payer;
      ["Luna","Jen","Shared"].forEach(p => {
        const btn = document.getElementById("payer" + p);
        if (!btn) return;
        if (p === payer) {
          btn.classList.remove("secondary");
          btn.classList.add("primary");
        } else {
          btn.classList.add("secondary");
          btn.classList.remove("primary");
        }
      });
    }

    function renderExpenses() {
      const wrap = document.getElementById("expenseList");
      const items = (expenseData.items || []).slice().sort((a,b) => (a.date || "").localeCompare(b.date || ""));
      wrap.innerHTML = "";
      if (items.length === 0) {
        wrap.innerHTML = '<div class="subtext">å°šæœªæ–°å¢ä»»ä½•èŠ±è²»ã€‚</div>';
      } else {
        let currentDate = "";
        items.forEach(item => {
          if (item.date !== currentDate) {
            currentDate = item.date;
            const dt = document.createElement("div");
            dt.className = "expense-group-title";
            dt.textContent = item.date || "(æœªå¡«æ—¥æœŸ)";
            wrap.appendChild(dt);
          }
          const row = document.createElement("div");
          row.className = "expense-item";

          const left = document.createElement("div");
          left.className = "expense-left";
          const name = document.createElement("div");
          name.className = "expense-name";
          name.textContent = item.name || "(æœªå‘½åèŠ±è²»)";
          const meta = document.createElement("div");
          meta.className = "expense-meta";
          meta.textContent = (item.payer || "") + " å…ˆä»˜ / " + (item.currency || "NTD");
          if (item.note) {
            meta.textContent += " ï½œ " + item.note;
          }
          left.appendChild(name);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.style.textAlign = "right";
          const amt = document.createElement("div");
          amt.className = "expense-amount";
          amt.textContent = (item.currency || "NTD") + " " + (item.amount || 0);
          const editBtn = document.createElement("button");
          editBtn.className = "icon-btn";
          editBtn.textContent = "âœï¸";
          editBtn.onclick = () => editExpense(item.id);
          right.appendChild(amt);
          right.appendChild(editBtn);

          row.appendChild(left);
          row.appendChild(right);
          wrap.appendChild(row);
        });
      }

      updateExpenseSummary();
    }

    function openExpenseModal() {
      currentEditingExpenseId = null;
      document.getElementById("expenseModalTitle").textContent = "æ–°å¢èŠ±è²»";
      document.getElementById("expenseDate").value = "";
      document.getElementById("expenseName").value = "";
      document.getElementById("expenseAmount").value = "";
      document.getElementById("expenseNote").value = "";
      document.getElementById("expenseCurrency").value = "TWD";
      document.getElementById("expenseDeleteBtn").style.display = "none";
      setPayer("Luna");
      document.getElementById("expenseModal").style.display = "flex";
    }

    function editExpense(id) {
      const item = (expenseData.items || []).find(i => i.id === id);
      if (!item) return;
      currentEditingExpenseId = id;
      document.getElementById("expenseModalTitle").textContent = "ç·¨è¼¯èŠ±è²»";
      document.getElementById("expenseDate").value = item.date || "";
      document.getElementById("expenseName").value = item.name || "";
      document.getElementById("expenseAmount").value = item.amount || "";
      document.getElementById("expenseNote").value = item.note || "";
      document.getElementById("expenseCurrency").value = item.currency || "TWD";
      setPayer(item.payer || "Luna");
      document.getElementById("expenseDeleteBtn").style.display = "inline-block";
      document.getElementById("expenseModal").style.display = "flex";
    }

    function closeExpenseModal() {
      document.getElementById("expenseModal").style.display = "none";
    }

    function saveExpense() {
      const date = document.getElementById("expenseDate").value;
      const name = document.getElementById("expenseName").value.trim();
      const amount = parseFloat(document.getElementById("expenseAmount").value || "0");
      const note = document.getElementById("expenseNote").value.trim();
      const currency = document.getElementById("expenseCurrency").value;

      if (isNaN(amount) || amount <= 0) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
        return;
      }

      const obj = {
        id: currentEditingExpenseId || genId(),
        date,
        name: name || "(æœªå‘½åèŠ±è²»)",
        payer: currentPayer,
        amount,
        currency,
        note
      };

      if (currentEditingExpenseId) {
        const idx = expenseData.items.findIndex(i => i.id === currentEditingExpenseId);
        if (idx >= 0) expenseData.items[idx] = obj;
      } else {
        expenseData.items.push(obj);
      }

      saveJSON(STORAGE_KEYS.expenses, expenseData);
      closeExpenseModal();
      renderExpenses();
    }

    function deleteExpense() {
      if (!currentEditingExpenseId) return;
      if (!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†èŠ±è²»ï¼Ÿ")) return;
      const idx = expenseData.items.findIndex(i => i.id === currentEditingExpenseId);
      if (idx >= 0) expenseData.items.splice(idx, 1);
      saveJSON(STORAGE_KEYS.expenses, expenseData);
      closeExpenseModal();
      renderExpenses();
    }

    function updateExpenseSummary() {
      const fx = expenseData.fxJPY || 0.215;
      let lunaNT = 0, jenNT = 0, sharedNT = 0;
      (expenseData.items || []).forEach(item => {
        let nt = item.amount || 0;
        if (item.currency === "JPY") nt = nt * fx;
        if (item.payer === "Luna") lunaNT += nt;
        else if (item.payer === "Jen") jenNT += nt;
        else sharedNT += nt;
      });
      document.getElementById("summaryLuna").textContent = "NT$ " + lunaNT.toFixed(0);
      document.getElementById("summaryJen").textContent = "NT$ " + jenNT.toFixed(0);
      document.getElementById("summaryShared").textContent = "NT$ " + sharedNT.toFixed(0);

      const halfShared = sharedNT / 2;
      const lunaTotal = lunaNT + halfShared;
      const jenTotal = jenNT + halfShared;
      const diff = lunaTotal - jenTotal;
      let text;
      if (Math.abs(diff) < 1) {
        text = "ç›®å‰é›™æ–¹å·²å¤§è‡´å¹³è¡¡";
      } else if (diff > 0) {
        text = "æœ€å¾Œ Jen éœ€è¦çµ¦ Luna ç´„ NT$ " + diff.toFixed(0);
      } else {
        text = "æœ€å¾Œ Luna éœ€è¦çµ¦ Jen ç´„ NT$ " + Math.abs(diff).toFixed(0);
      }
      document.getElementById("settlementText").textContent = text;
    }

    // ====== è³‡æ–™åŒæ­¥ ======
    function openSyncModal() {
      document.getElementById("syncModal").style.display = "flex";
    }
    function closeSyncModal() {
      document.getElementById("syncModal").style.display = "none";
    }

    function exportAllData() {
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key) continue;
        if (key.startsWith("hk_")) {
          data[key] = localStorage.getItem(key);
        }
      }
      const textarea = document.getElementById("syncTextarea");
      textarea.value = JSON.stringify(data, null, 2);
      if (Object.keys(data).length === 0) {
        alert("ç›®å‰æ²’æœ‰æ‰¾åˆ°ä»»ä½• hk_ é–‹é ­çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");
      } else {
        alert("åŒ¯å‡ºå®Œæˆï¼Œè«‹å…¨é¸ä¸Šæ–¹æ–‡å­—ä¸¦è¤‡è£½ï¼Œè²¼åˆ°å¦ä¸€å€‹è£ç½®çš„è³‡æ–™åŒæ­¥è¦–çª—ä¸­ã€‚");
      }
    }

    function importAllData() {
      const textarea = document.getElementById("syncTextarea");
      const raw = (textarea.value || "").trim();
      if (!raw) {
        alert("è«‹å…ˆè²¼ä¸Šå¾å¦ä¸€å€‹è£ç½®åŒ¯å‡ºçš„è³‡æ–™ã€‚");
        return;
      }
      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch (e) {
        alert("åŒ¯å…¥å¤±æ•—ï¼šå…§å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚");
        return;
      }
      if (!parsed || typeof parsed !== "object") {
        alert("åŒ¯å…¥å¤±æ•—ï¼šè³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
        return;
      }
      const keys = Object.keys(parsed).filter(k => k.startsWith("hk_"));
      if (keys.length === 0) {
        alert("åŒ¯å…¥è³‡æ–™ä¸­æ²’æœ‰ hk_ é–‹é ­çš„é …ç›®ã€‚");
        return;
      }
      const ok = confirm(
        "åŒ¯å…¥å¾Œæœƒè¦†è“‹æœ¬è£ç½®åŸæœ¬çš„è¡Œç¨‹ / è³¼ç‰©æ¸…å–® / èŠ±è²»ç­‰è³‡æ–™ã€‚\n\n" +
        "å»ºè­°å…ˆåœ¨æœ¬è£ç½®æŒ‰ä¸€æ¬¡ã€ŒåŒ¯å‡ºã€å‚™ä»½ï¼Œå†é€²è¡ŒåŒ¯å…¥ã€‚\n\nç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ"
      );
      if (!ok) return;
      keys.forEach(key => {
        localStorage.setItem(key, String(parsed[key]));
      });
      alert("åŒ¯å…¥å®Œæˆï¼Œé é¢å°‡é‡æ–°æ•´ç†ã€‚");
      location.reload();
    }

    // ====== åˆå§‹åŒ– ======
    function init() {
      renderHeader();
      renderDayTabs();
      renderItinerary();
      renderShopping();
      renderExpenses();
    }

    init();
  </script>
</body>
</html>
