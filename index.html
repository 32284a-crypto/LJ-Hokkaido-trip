<script type="module">
  // ========= 0. Firebase è¨­å®š (å·²å°å…¥æ‚¨çš„å°ˆæ¡ˆé…ç½®) =========
  // å¼•å…¥ Firebase SDK æ¨¡çµ„ (æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ CDN é€£çµï¼Œéœ€åœ¨æ”¯æ´æ¨¡çµ„çš„ç’°å¢ƒä¸‹åŸ·è¡Œï¼Œä¾‹å¦‚éƒ¨ç½²åˆ° GitHub Pages)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  
  // æ‚¨çš„ web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCBHcwkKj7GcC4HVzzbTYe3Qtpi2UNawc8",
    authDomain: "hokkaido-eaeb1.firebaseapp.com",
    databaseURL: "https://hokkaido-eaeb1-default-rtdb.firebaseio.com",
    projectId: "hokkaido-eaeb1",
    storageBucket: "hokkaido-eaeb1.firebasestorage.app",
    messagingSenderId: "977559624676",
    appId: "1:977559624676:web:65437df8bfa11f895005f1",
    measurementId: "G-QPHE9JZ8HS"
  };

  // åˆå§‹åŒ– Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  // å®šç¾©è³‡æ–™åº«è·¯å¾‘ (æ‰€æœ‰è³‡æ–™éƒ½æœƒå­˜åœ¨é€™å€‹ç¯€é»ä¸‹)
  const DB_PATH = "hokkaido_2025"; 

  // ========= 1. é è¨­æ—…éŠè³‡æ–™ (è‹¥è³‡æ–™åº«å…¨ç©ºæ™‚ä½¿ç”¨) =========
  const defaultTripData = {
      days: [
        {
          id: "2025-12-24",
          label: "Day1 12/24",
          weather: { temp: -1, low: -6, feels: -8, status: "æŠµé”æ—¥", note: "é…·èˆª TR892 Â· æŠµé”æœ­å¹Œ & ä½ VESSEL" },
          schedule: [
            { time: "09:30", tag: "å»ç¨‹", title: "æ¡ƒåœ’æ©Ÿå ´å ±åˆ°", sub: "TPE Â· é…·èˆª TR892", note: "å»ºè­°èµ·é£›å‰ 3 å°æ™‚åˆ°æ©Ÿå ´", map: "", image: "" },
            { time: "12:30", tag: "å»ç¨‹", title: "TR892 TPE â†’ CTS", sub: "é…·èˆª TR892 12:30 èµ·é£›ï¼Œé è¨ˆ 17:20 æŠµé”", note: "", map: "", image: "" },
            { time: "17:20", tag: "æŠµé”", title: "æ–°åƒæ­²æ©Ÿå ´ (CTS)", sub: "å…¥å¢ƒã€é ˜è¡Œæã€å‰å¾€æœ­å¹Œ", note: "å¯åœ¨æ©Ÿå ´å…ˆè²·äº¤é€šå¡ / ä¸Šå»æ‰€ / å°è£œçµ¦", map: "https://maps.app.goo.gl/", image: "" },
            { time: "19:30", tag: "å…¥ä½", title: "VESSEL HOTEL ä¸­å³¶å…¬åœ’", sub: "12/24â€“12/26 Â· 14:00 å…¥ä½ / 11:00 é€€æˆ¿", note: "æ”¾å¥½è¡Œæï¼Œå¯å»é™„è¿‘é€›é€› / è¶…å¸‚ / ä¾¿åˆ©å•†åº—", map: "", image: "" },
            { time: "21:00", tag: "TBD", title: "æœ­å¹Œå¤œæ•£æ­¥ï¼ˆå¾…æ±ºå®šï¼‰", sub: "å¤§é€šå…¬åœ’ / ç‹¸å°è·¯ or å…¶ä»–", note: "", map: "", image: "" }
          ]
        },
        {
          id: "2025-12-25",
          label: "Day2 12/25",
          weather: { temp: -5, low: -10, feels: -12, status: "Klook ä¸€æ—¥éŠ", note: "æ—­å±±å‹•ç‰©åœ’ + é’æ±  + ç™½é¬šç€‘å¸ƒ + ç²¾éˆéœ²è‡º" },
          schedule: [
            { time: "07:50", tag: "å»ç¨‹", title: "é›†åˆå‡ºç™¼", sub: "æœ­å¹Œ â†’ æ—­å·æ–¹å‘ï¼ˆä¾æ†‘è­‰é›†åˆé»ï¼‰", note: "", map: "", image: "" },
            { time: "10:30", tag: "æ™¯é»", title: "æ—­å±±å‹•ç‰©åœ’", sub: "ç´„ 1 å°æ™‚ 40 åˆ† Â· è‡ªç”±æ´»å‹•", note: "è¡Œç¨‹å«æ—­å±±å‹•ç‰©åœ’é–€ç¥¨", map: "", image: "" },
            { time: "13:10", tag: "æ™¯é»", title: "ç™½é‡‘é’æ± ", sub: "ç´„ 15 åˆ†é˜ Â· è‡ªç”±æ´»å‹•", note: "", map: "", image: "" },
            { time: "13:30", tag: "æ™¯é»", title: "ç™½é¬šç€‘å¸ƒ", sub: "ç´„ 25 åˆ†é˜ Â· è‡ªç”±æ´»å‹•", note: "", map: "", image: "" },
            { time: "15:00", tag: "æ™¯é»", title: "æ£®æ—ç²¾éˆéœ²è‡º", sub: "ç´„ 1 å°æ™‚ 20 åˆ† Â· è‡ªç”±æ´»å‹•", note: "æ‹ç…§ã€æ•£æ­¥ã€å–æ±è¥¿", map: "", image: "" },
            { time: "18:30", tag: "å›ç¨‹", title: "è¿”å›æœ­å¹Œ", sub: "å›åˆ°é›†åˆåœ°é»é™„è¿‘è§£æ•£", note: "æ™šé¤ / å¤œæ™šè¡Œç¨‹ TBD", map: "", image: "" }
          ]
        },
        {
          id: "2025-12-26",
          label: "Day3 12/26",
          weather: { temp: -3, low: -8, feels: -10, status: "å¸‚å€æ—¥ & æ›é£¯åº—", note: "ç™½å¤©æœ­å¹Œå¸‚å€ & ä½ç›¸éµè–„é‡" },
          schedule: [
            { time: "08:00", tag: "æ™¯é»", title: "åŒ—æµ·é“ç¥å®®", sub: "æ—©ä¸Šæ•£æ­¥ Â· åƒæ¸…é¤… / æŠ•å¹£æ±‚ç±¤", note: "", map: "", image: "" },
            { time: "12:00", tag: "æ™¯é»", title: "åŒ—æµ·é“å»³æœ¬å»³èˆ", sub: "ç´…ç£šå»ºç¯‰ Â· æ‹ç…§æ•£æ­¥", note: "", map: "", image: "" },
            { time: "15:00", tag: "æ›é£¯åº—", title: "ç›¸éµ FRESA INN è–„é‡", sub: "12/26â€“12/29 Â· 15:00 å…¥ä½ / 11:00 é€€æˆ¿", note: "", map: "", image: "" }
          ]
        },
        {
          id: "2025-12-27",
          label: "Day4 12/27",
          weather: { temp: -6, low: -12, feels: -15, status: "æ»‘é›ªæ—¥", note: "é›ªé•·å§ Â· æ‰‹ç¨»æ»‘é›ªå ´" },
          schedule: [
            { time: "07:00", tag: "å‡ºç™¼", title: "æœ­å¹Œ â†’ æ‰‹ç¨»æ»‘é›ªå ´", sub: "æ­ JR / å·´å£«ï¼ˆä¾å¯¦éš›å®‰æ’ï¼‰", note: "å‰ä¸€å¤©å…ˆç¢ºèªè»Šç­æ™‚é–“", map: "", image: "" },
            { time: "09:00", tag: "æ»‘é›ª", title: "é›†åˆ & ç§Ÿè£å‚™", sub: "æ‰‹ç¨»æ»‘é›ªå ´ Â· èˆ‡é›ªé•·å§æœƒåˆ", note: "", map: "", image: "" },
            { time: "10:00", tag: "æ»‘é›ª", title: "æ»‘é›ªæ•™å­¸ & è‡ªç”±æ»‘", sub: "ä¸­åˆå¯åœ¨é›ªå ´ç”¨é¤", note: "", map: "", image: "" },
            { time: "16:00", tag: "å›ç¨‹", title: "é›¢é–‹æ‰‹ç¨»æ»‘é›ªå ´", sub: "æ­è»Šè¿”å›æœ­å¹Œ", note: "å›åˆ°è–„é‡é™„è¿‘åƒæ™šé¤ / æ³¡æ¹¯ TBD", map: "", image: "" }
          ]
        },
        {
          id: "2025-12-28",
          label: "Day5 12/28",
          weather: { temp: -6, low: -12, feels: -15, status: "è‡ªç”±æ»‘é›ª / è‡ªç”±è¡Œ", note: "çœ‹ç‹€æ³å†æ±ºå®šè¦å»å“ªè£¡ç©é›ªæˆ–å¸‚å€é€›è¡—" },
          schedule: [
            { time: "TBD", tag: "TBD", title: "è‡ªç”±æ»‘é›ª or å¸‚å€è¡Œç¨‹", sub: "ä¹‹å¾Œå†è‡ªå·±æ±ºå®šç´°ç¯€", note: "", map: "", image: "" }
          ]
        },
        {
          id: "2025-12-29",
          label: "Day6 12/29",
          weather: { temp: -3, low: -8, feels: -10, status: "å›ç¨‹æ—¥", note: "æ”¶æ‹¾è¡Œæ + æ©Ÿå ´æ¡è²·" },
          schedule: [
            { time: "11:00", tag: "é€€æˆ¿", title: "é€€æˆ¿ Â· ç›¸éµ FRESA INN è–„é‡", sub: "æœ€æ™š 11:00 é€€æˆ¿ï¼Œå¯å…ˆå¸¶è¡Œæå»æœ­å¹Œç«™å¯„ç‰©", note: "", map: "", image: "" },
            { time: "12:00", tag: "å‰å¾€æ©Ÿå ´", title: "æœ­å¹Œ â†’ æ–°åƒæ­²æ©Ÿå ´", sub: "æ­ JR / å·´å£«å‰å¾€ CTS", note: "é ç•™æ™‚é–“é€›æ©Ÿå ´ & è²·ä¼´æ‰‹ç¦®", map: "", image: "" },
            { time: "13:55", tag: "å›ç¨‹", title: "FD243 CTS â†’ TPE", sub: "Airasia FD243 13:55 èµ·é£›ï¼Œé è¨ˆ 17:55 æŠµé”", note: "", map: "", image: "" }
          ]
        }
      ],
      fx: { rate: 0.215 },
      shopping: [
        { id: "s-muji-01", owner: "Luna", store: "ç„¡å°è‰¯å“", name: "ç¦å‰èŒ¶", note: "" },
        { id: "s-3c-01", owner: "Luna", store: "3COINS", name: "æ—…è¡Œæ”¶ç´è¢‹", note: "" },
        { id: "s-3c-02", owner: "Luna", store: "3COINS", name: "å¤šåŠŸèƒ½å¾®æ³¢èª¿ç†çƒ¤ç›¤", note: "" },
        { id: "s-3c-03", owner: "Luna", store: "3COINS", name: "æ¯›æ¯›æ‰‹å¥—", note: "" },
        { id: "s-3c-04", owner: "Luna", store: "3COINS", name: "ç‹—ç‹—è£", note: "" },
        { id: "s-cvs-01", owner: "Luna", store: "è¶…å•†", name: "å¥é”å‡ºå¥‡è›‹ çš®å…‹æ•", note: "" },
        { id: "s-711-01", owner: "Luna", store: "7-11", name: "å¸¶çš®è–¯æ¢", note: "" },
        { id: "s-711-02", owner: "Luna", store: "7-11", name: "è‘¡è„é¤…ä¹¾", note: "" },
        { id: "s-lawson-01", owner: "Luna", store: "Lawson", name: "é»ƒè±†ç²‰ç¶œåˆå …æœ", note: "" },
        { id: "s-family-01", owner: "Luna", store: "å…¨å®¶", name: "Calvesè’œé¦™ç¾ä¹ƒæ»‹æ´‹èŠ‹ç‰‡", note: "" },
        { id: "s-family-02", owner: "Luna", store: "å…¨å®¶", name: "åŠç”Ÿæ°´èœœæ¡ƒä¹¾", note: "" },
        { id: "s-family-03", owner: "Luna", store: "å…¨å®¶", name: "é®­é­šè‚‰ä¹¾", note: "" }
      ],
      expenses: [
        { id: "e-hand-rent", title: "æ‰‹ç¨»é›ªå…·ç§Ÿå€Ÿ", date: "2025-11-17", method: "Jen å…ˆä»˜ NT$5,086", amount: 5086, currency: "TWD", payer: "Jen" },
        { id: "e-klook-day", title: "Klook ä¸€æ—¥", date: "2025-10-05", method: "Luna å…ˆä»˜ NT$3,423", amount: 3423, currency: "TWD", payer: "Luna" },
        { id: "e-hotel-1226-27", title: "12/26â€“12/27ï¼ˆ1æ™šï¼‰", date: "2025-09-06", method: "Jen å…ˆä»˜ NT$3,659", amount: 3659, currency: "TWD", payer: "Jen" },
        { id: "e-yuki-class", title: "é›ªé•·å§ä¸€æ—¥èª²", date: "2025-09-04", method: "Jen å…ˆä»˜ NT$14,000", amount: 14000, currency: "TWD", payer: "Jen" },
        { id: "e-hotel-1227-29", title: "12/27â€“12/29ï¼ˆ2æ™šï¼‰", date: "2025-09-04", method: "Luna å…ˆä»˜ NT$6,193", amount: 6193, currency: "TWD", payer: "Luna" },
        { id: "e-hotel-1224-26", title: "12/24â€“12/26ï¼ˆ2æ™šï¼‰", date: "2025-09-04", method: "Luna å…ˆä»˜ NT$7,903", amount: 7903, currency: "TWD", payer: "Luna" },
        { id: "e-flight", title: "æ©Ÿç¥¨", date: "2025-09-01", method: "Luna å…ˆä»˜ NT$28,296", amount: 28296, currency: "TWD", payer: "Luna" }
      ]
    };

    // ========= 2. å…¨åŸŸè®Šæ•¸ & Firebase åŒæ­¥é‚è¼¯ =========
    let tripData = defaultTripData; // é è¨­å€¼ï¼Œä¹‹å¾Œæœƒè¢« Firebase è¦†è“‹
    let shoppingList = defaultTripData.shopping;
    let expenseList = defaultTripData.expenses;
    let heroBg = null;

    // ç›£è½ Firebase è³‡æ–™è®Šæ›´ï¼šåªè¦é›²ç«¯æœ‰æ›´æ–°ï¼Œé€™è£¡é¦¬ä¸Šæœƒæ”¶åˆ°ä¸¦é‡ç¹ª (å³æ™‚åŒæ­¥æ ¸å¿ƒ)
    onValue(ref(db, DB_PATH), (snapshot) => {
      const data = snapshot.val();
      
      if (data) {
        // é›²ç«¯æœ‰è³‡æ–™ï¼Œä½¿ç”¨é›²ç«¯è³‡æ–™
        tripData = data.tripData || defaultTripData;
        shoppingList = data.shoppingList || [];
        expenseList = data.expenseList || [];
        heroBg = data.heroBg || null;
      } else {
        // é›²ç«¯æ²’è³‡æ–™ (ç¬¬ä¸€æ¬¡åŸ·è¡Œ)ï¼ŒæŠŠé è¨­å€¼æ¨ä¸Šå»
        saveAllToFirebase();
      }

      // é‡ç¹ªä»‹é¢
      initView();
    });

    // å°‡æ‰€æœ‰è³‡æ–™å¯«å…¥ Firebase 
    function saveAllToFirebase() {
      set(ref(db, DB_PATH), {
        tripData: tripData,
        shoppingList: shoppingList,
        expenseList: expenseList,
        heroBg: heroBg
      }).catch(err => {
        console.error("åŒæ­¥å¤±æ•—:", err);
        // ä¸éœ€è·³ alertï¼Œå› ç‚ºä½¿ç”¨è€…å¯èƒ½ä¸çŸ¥é“ä½•æ™‚ç™¼ç”Ÿ
      });
    }

    // ========= 3. ä»‹é¢æ“ä½œé‚è¼¯ (ä¿®æ”¹ç‚ºå‘¼å« saveAllToFirebase) =========
    
    // -- è¡Œç¨‹ & Tabs --
    const dayTabsEl = document.getElementById("dayTabs");
    const dayContentEl = document.getElementById("dayContent");
    let currentDayIndex = 0;

    function getTimeValue(t) {
      if (!t) return 24 * 60 + 59;
      const m = /^(\d{1,2}):(\d{2})$/.exec(t.trim());
      if (!m) return 24 * 60 + 59;
      const h = parseInt(m[1], 10), min = parseInt(m[2], 10);
      if (h < 0 || h > 23 || min < 0 || min > 59) return 24 * 60 + 59;
      return h * 60 + min;
    }

    function sortScheduleForDay(dayIdx) {
      const day = tripData.days[dayIdx];
      if (!day || !day.schedule) return;
      day.schedule.sort((a, b) => getTimeValue(a.time) - getTimeValue(b.time));
    }

    function renderTabs() {
      dayTabsEl.innerHTML = "";
      tripData.days.forEach((day, idx) => {
        const tab = document.createElement("div");
        tab.className = "day-tab" + (idx === currentDayIndex ? " active" : "");
        tab.textContent = day.label;
        tab.onclick = () => {
          currentDayIndex = idx;
          renderTabs();
          renderDayContent();
        };
        dayTabsEl.appendChild(tab);
      });
    }

    function renderDayContent() {
      const day = tripData.days[currentDayIndex];
      if (!day) return;
      sortScheduleForDay(currentDayIndex);

      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">â„ï¸</span> ${day.weather.temp}â„ƒ / ${day.weather.low}â„ƒ</div>
            <div style="text-align:right;">
              <div class="card-subtitle">${day.weather.status}</div>
              <span class="timeline-edit weather-edit" data-day="${currentDayIndex}">âœï¸</span>
            </div>
          </div>
          <div class="weather-main">
            <div class="weather-temp">
              <span>${day.weather.temp}Â°</span><span>é«”æ„Ÿ ${day.weather.feels}Â°C</span>
            </div>
            <div class="weather-extra"><div>${day.weather.status}</div><div>${day.weather.note}</div></div>
          </div>
        </section>
        <section class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">ğŸ—“</span> ä»Šæ—¥è¡Œç¨‹</div>
            <div class="card-subtitle">${day.label}</div>
          </div>
          ${day.schedule.map((item, idx) => `
            <div class="timeline-item">
              <div class="timeline-time">${item.time}</div>
              <div class="timeline-body">
                <div><span class="tag">${item.tag}</span><span class="timeline-edit" data-day="${currentDayIndex}" data-idx="${idx}">âœï¸</span></div>
                <div class="timeline-title">${item.title}</div>
                <div class="timeline-sub">${item.sub || ""}</div>
                ${item.note ? `<div class="timeline-note">${item.note}</div>` : ""}
                ${item.map ? `<a href="${item.map}" target="_blank" class="timeline-map-link">ğŸ—ºï¸ Google åœ°åœ–</a>` : ""}
                ${item.image ? `<img class="timeline-img" src="${item.image}" alt="">` : ""}
              </div>
            </div>
          `).join("")}
        </section>
      `;
      dayContentEl.innerHTML = html;

      // Bind edit buttons
      document.querySelectorAll(".timeline-edit:not(.weather-edit)").forEach(btn => {
        btn.addEventListener("click", () => openScheduleModal(parseInt(btn.dataset.day), parseInt(btn.dataset.idx)));
      });
      document.querySelectorAll(".weather-edit").forEach(btn => {
        btn.addEventListener("click", () => openWeatherModal(parseInt(btn.dataset.day)));
      });
    }

    // -- åŒ¯ç‡ --
    const jpyInput = document.getElementById("jpyInput");
    const twdInput = document.getElementById("twdInput");
    const rateText = document.getElementById("rateText");
    function updateFromJPY() {
      const jpy = parseFloat(jpyInput.value || "0");
      const twd = Math.round(jpy * tripData.fx.rate);
      twdInput.value = twd;
    }
    function updateFromTWD() {
      const twd = parseFloat(twdInput.value || "0");
      const jpy = Math.round(twd / tripData.fx.rate);
      jpyInput.value = jpy;
    }
    function initRate() {
      if (!rateText) return;
      rateText.textContent = `ç¤ºæ„åŒ¯ç‡ï¼š1 JPY â‰ˆ ${tripData.fx.rate} TWD`;
      jpyInput.addEventListener("input", updateFromJPY);
      twdInput.addEventListener("input", updateFromTWD);
      updateFromJPY();
    }

    // -- è³¼ç‰© --
    const shoppingGridAllEl = document.getElementById("shoppingGridAll");
    const shoppingStoreFilter = document.getElementById("shoppingStoreFilter");
    let editingShoppingId = null;

    function renderShopping() {
      if (!shoppingGridAllEl) return;
      const storeFilter = shoppingStoreFilter ? shoppingStoreFilter.value : "ALL";
      let items = shoppingList || [];
      if (storeFilter !== "ALL") items = items.filter(i => i.store === storeFilter);

      shoppingGridAllEl.innerHTML = items.map(item => `
        <div class="shopping-card">
          <div class="shopping-name-row">
            <div class="shopping-name">${item.name}</div>
            <span class="shopping-edit" data-id="${item.id}">âœï¸</span>
          </div>
          <div class="shopping-note">${item.store ? `ğŸª ${item.store}` : ""}${item.owner ? ` Â· ğŸ‘¤ ${item.owner}` : ""}</div>
          ${item.note ? `<div class="shopping-note">${item.note}</div>` : ""}
          ${item.imageData ? `<img class="shopping-img" src="${item.imageData}" alt="">` : ""}
        </div>
      `).join("");

      document.querySelectorAll(".shopping-edit").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const item = shoppingList.find(i => i.id === id);
          if (!item) return;
          editingShoppingId = id;
          shoppingName.value = item.name || "";
          shoppingNote.value = item.note || "";
          shoppingOwner.value = item.owner || "Luna";
          shoppingStore.value = item.store || "";
          shoppingImageInput.value = "";
          openModal(modalMap.shopping);
        });
      });
    }
    if (shoppingStoreFilter) shoppingStoreFilter.addEventListener("change", renderShopping);

    // -- è²»ç”¨ --
    const expenseListEl = document.getElementById("expenseList");
    const totalJPYEl = document.getElementById("totalJPY");
    const totalTWDEl = document.getElementById("totalTWD");
    
    function payerColor(p) {
      if(p==="Luna") return "#ffb6c1";
      if(p==="Jen") return "#90caf9";
      if(p==="å…¬åŸºé‡‘") return "#a5d6a7";
      return "#78909c";
    }

    function calcTotalsAndSettlement() {
      let totalJPY = 0;
      const rate = tripData.fx.rate;
      const people = ["Luna", "Jen"];
      const balances = { Luna: { paid: 0, should: 0 }, Jen: { paid: 0, should: 0 } };

      (expenseList || []).forEach(item => {
        let amountTWD = item.currency === "JPY" ? item.amount * rate : item.amount;
        if (item.currency === "JPY") totalJPY += item.amount;
        else totalJPY += amountTWD / rate;

        const share = amountTWD / people.length;
        people.forEach(p => balances[p].should += share);
        if (item.payer === "Luna") balances.Luna.paid += amountTWD;
        if (item.payer === "Jen") balances.Jen.paid += amountTWD;
      });

      const totalTWD = Math.round(totalJPY * rate);
      totalJPYEl.textContent = "Â¥" + Math.round(totalJPY).toLocaleString();
      totalTWDEl.textContent = "ç´„ NT$" + totalTWD.toLocaleString();

      const settleEl = document.getElementById("settleSummary");
      if (settleEl) {
        const netLuna = balances.Luna.paid - balances.Luna.should;
        let settleLine = Math.abs(netLuna) < 10 ? "ç›®å‰å¹¾ä¹å¹³æ‰‹ï¼Œä¸ç”¨äº’ç›¸è½‰å¸³ï½" : 
                         netLuna > 0 ? `Jen å¤§ç´„éœ€è¦çµ¦ Luna NT$${Math.round(netLuna).toLocaleString()}` : 
                                       `Luna å¤§ç´„éœ€è¦çµ¦ Jen NT$${Math.round(Math.abs(netLuna)).toLocaleString()}`;
        settleEl.innerHTML = `
          Lunaï¼šå¯¦ä»˜ NT$${Math.round(balances.Luna.paid).toLocaleString()} / æ‡‰ä»˜ NT$${Math.round(balances.Luna.should).toLocaleString()}<br>
          Jenï¼šå¯¦ä»˜ NT$${Math.round(balances.Jen.paid).toLocaleString()} / æ‡‰ä»˜ NT$${Math.round(balances.Jen.should).toLocaleString()}<br>
          <b>${settleLine}</b>
        `;
      }
    }

    function renderExpenses() {
      if (!expenseListEl) return;
      expenseListEl.innerHTML = (expenseList || []).map(item => `
        <div class="expense-item">
          <div class="expense-left">
            <div class="expense-icon" style="background:${payerColor(item.payer)};">${item.payer || ""}</div>
            <div>
              <div class="expense-text-main">${item.title}</div>
              <div class="expense-text-sub">${item.date || ""}${item.method ? " Â· " + item.method : ""}</div>
            </div>
          </div>
          <div class="expense-right">
            <div>${item.currency === "JPY" ? "Â¥" : "NT$"}${item.amount.toLocaleString()}</div>
            <span class="expense-delete" data-id="${item.id}">âœ•</span>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".expense-delete").forEach(btn => {
        btn.addEventListener("click", () => {
          if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è²»ç”¨å—ï¼Ÿ")) return;
          const id = btn.dataset.id;
          expenseList = expenseList.filter(e => e.id !== id);
          saveAllToFirebase(); // åŒæ­¥åˆªé™¤
        });
      });
      calcTotalsAndSettlement();
    }

    // -- Hero èƒŒæ™¯ --
    const heroEl = document.getElementById("hero");
    const changeBgBtn = document.getElementById("changeBgBtn");
    const bgFileInput = document.getElementById("bgFileInput");
    
    if (changeBgBtn && bgFileInput) {
      changeBgBtn.addEventListener("click", () => bgFileInput.click());
      bgFileInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          heroBg = ev.target.result; // å°‡åœ–ç‰‡è³‡æ–™å­˜å…¥è®Šæ•¸
          saveAllToFirebase(); // ä¸Šå‚³é›²ç«¯ (æ‰€æœ‰è£ç½®éƒ½æœƒæ›èƒŒæ™¯)
        };
        reader.readAsDataURL(file);
      });
    }

    // ========= 4. Modal & æ–°å¢ (å·²ç§»é™¤è³‡æ–™åŒæ­¥ç›¸é—œ) =========
    const fabBtn = document.getElementById("fabBtn");
    const typeModal = document.getElementById("typeModal");
    const typeCancel = document.getElementById("typeCancel");
    const addShoppingBtn = document.getElementById("addShoppingBtn");
    const addExpenseBtn = document.getElementById("addExpenseBtn");

    const shoppingModal = document.getElementById("shoppingModal");
    const shoppingCancel = document.getElementById("shoppingCancel");
    const shoppingSave = document.getElementById("shoppingSave");
    const shoppingName = document.getElementById("shoppingName");
    const shoppingNote = document.getElementById("shoppingNote");
    const shoppingOwner = document.getElementById("shoppingOwner");
    const shoppingStore = document.getElementById("shoppingStore");
    const shoppingImageInput = document.getElementById("shoppingImageInput");

    const expenseModal = document.getElementById("expenseModal");
    const expenseCancel = document.getElementById("expenseCancel");
    const expenseSave = document.getElementById("expenseSave");
    const expenseTitle = document.getElementById("expenseTitle");
    const expenseDate = document.getElementById("expenseDate");
    const expenseMethod = document.getElementById("expenseMethod");
    const expenseAmount = document.getElementById("expenseAmount");
    const expenseCurrency = document.getElementById("expenseCurrency");
    const expensePayerGroup = document.getElementById("expensePayerGroup");

    const scheduleModal = document.getElementById("scheduleModal");
    const scheduleCancel = document.getElementById("scheduleCancel");
    const scheduleSave = document.getElementById("scheduleSave");
    const scheduleTime = document.getElementById("scheduleTime"); 
    const scheduleTag = document.getElementById("scheduleTag");
    const scheduleTitle = document.getElementById("scheduleTitle");
    const scheduleSub = document.getElementById("scheduleSub");
    const scheduleNote = document.getElementById("scheduleNote");
    const scheduleMap = document.getElementById("scheduleMap");
    const scheduleImageInput = document.getElementById("scheduleImageInput");
    const editTodayBtn = document.getElementById("editTodayBtn");

    const weatherModal = document.getElementById("weatherModal");
    const weatherCancel = document.getElementById("weatherCancel");
    const weatherSave = document.getElementById("weatherSave");
    const weatherStatusInput = document.getElementById("weatherStatus");
    const weatherNoteInput = document.getElementById("weatherNote");

    let currentExpensePayer = "Luna";
    let editingDayIndex = null;
    let editingScheduleIndex = null;
    let editingWeatherDayIndex = null;
    
    const modalMap = {
      type: typeModal,
      shopping: shoppingModal,
      expense: expenseModal,
      schedule: scheduleModal,
      weather: weatherModal,
    };

    // é–‹å•Ÿ / é—œé–‰ modal æ™‚è¨˜éŒ„èˆ‡é‚„åŸæ²å‹•ä½ç½®
    let lastScrollY = 0;
    const openModal = m => {
      lastScrollY = window.scrollY || window.pageYOffset || 0;
      m.classList.add("show");
      document.body.style.overflow = "hidden";
    };
    const closeModal = m => {
      m.classList.remove("show");
      document.body.style.overflow = "";
      window.scrollTo({ top: lastScrollY, behavior: "auto" });
    };

    if (fabBtn) fabBtn.addEventListener("click", () => openModal(typeModal));
    if (typeCancel) typeCancel.addEventListener("click", () => closeModal(typeModal));
    if (addShoppingBtn) {
      addShoppingBtn.addEventListener("click", () => {
        closeModal(typeModal);
        editingShoppingId = null;
        shoppingName.value = ""; shoppingNote.value = ""; shoppingOwner.value = "Luna"; shoppingStore.value = ""; shoppingImageInput.value = "";
        openModal(shoppingModal);
      });
    }
    if (addExpenseBtn) {
      addExpenseBtn.addEventListener("click", () => {
        closeModal(typeModal);
        expenseTitle.value = ""; expenseMethod.value = ""; expenseAmount.value = ""; expenseCurrency.value = "JPY";
        currentExpensePayer = "Luna";
        expenseDate.value = new Date().toISOString().slice(0,10);
        Array.from(expensePayerGroup.querySelectorAll(".pill-btn")).forEach(btn => btn.classList.toggle("active", btn.dataset.payer === "Luna"));
        openModal(expenseModal);
      });
    }

    if (shoppingCancel) shoppingCancel.addEventListener("click", () => closeModal(shoppingModal));
    if (expenseCancel) expenseCancel.addEventListener("click", () => closeModal(expenseModal));
    if (scheduleCancel) scheduleCancel.addEventListener("click", () => closeModal(scheduleModal));
    if (weatherCancel) weatherCancel.addEventListener("click", () => closeModal(weatherModal));

    // ä»˜æ¬¾äºº pill
    if (expensePayerGroup) {
      expensePayerGroup.addEventListener("click", e => {
        const btn = e.target.closest(".pill-btn");
        if (!btn) return;
        currentExpensePayer = btn.dataset.payer;
        Array.from(expensePayerGroup.querySelectorAll(".pill-btn")).forEach(b => b.classList.toggle("active", b === btn));
      });
    }

    // æ–°å¢ / ç·¨è¼¯è³¼ç‰©
    if (shoppingSave) {
      shoppingSave.addEventListener("click", () => {
        const name = shoppingName.value.trim();
        if (!name) { alert("è«‹è¼¸å…¥å•†å“åç¨±"); return; }
        const note = shoppingNote.value.trim();
        const owner = shoppingOwner.value || "Luna";
        const store = shoppingStore.value || "";
        const file = shoppingImageInput.files[0];

        const existingItem = editingShoppingId ? shoppingList.find(i => i.id === editingShoppingId) : null;
        const existingImageData = existingItem ? existingItem.imageData : undefined;

        const applyUpdate = (fileData) => {
          const imageData = fileData !== undefined ? fileData : existingImageData;
          const newItem = {
            id: editingShoppingId || "s" + Date.now(),
            owner, store, name, note, imageData
          };
          
          if (editingShoppingId && existingItem) {
            Object.assign(existingItem, newItem); // Update existing item
          } else {
            shoppingList.push(newItem);
          }
          saveAllToFirebase(); // åŒæ­¥åˆ°é›²ç«¯
          closeModal(shoppingModal);
        };

        if (file) {
          const reader = new FileReader();
          reader.onload = ev => applyUpdate(ev.target.result);
          reader.readAsDataURL(file);
        } else {
          applyUpdate(undefined);
        }
      });
    }

    // æ–°å¢è²»ç”¨
    if (expenseSave) {
      expenseSave.addEventListener("click", () => {
        const title = expenseTitle.value.trim();
        if (!title) { alert("è«‹è¼¸å…¥é …ç›®åç¨±"); return; }
        const amount = parseFloat(expenseAmount.value || "0");
        if (!amount || amount <= 0) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; }

        expenseList.push({
          id: "e" + Date.now(),
          title,
          date: expenseDate.value,
          method: expenseMethod.value.trim(),
          amount,
          currency: expenseCurrency.value,
          payer: currentExpensePayer
        });
        saveAllToFirebase(); // åŒæ­¥åˆ°é›²ç«¯
        closeModal(expenseModal);
      });
    }

    // ========= 5. è¡Œç¨‹ç·¨è¼¯èˆ‡å¤©æ°£ç·¨è¼¯ =========

    function openScheduleModal(dayIdx, schedIdx) {
      editingDayIndex = dayIdx;
      editingScheduleIndex = schedIdx;
      const item = tripData.days[dayIdx].schedule[schedIdx];

      scheduleTime.value = item.time || ""; scheduleTag.value = item.tag || "";
      scheduleTitle.value = item.title || ""; scheduleSub.value = item.sub || "";
      scheduleNote.value = item.note || ""; scheduleMap.value = item.map || "";
      if (scheduleImageInput) scheduleImageInput.value = "";

      openModal(scheduleModal);
    }

    if (editTodayBtn) {
      editTodayBtn.addEventListener("click", () => {
        if (!tripData.days[currentDayIndex] || !tripData.days[currentDayIndex].schedule.length) {
          alert("é€™ä¸€å¤©é‚„æ²’æœ‰è¡Œç¨‹å¯ä»¥ç·¨è¼¯ã€‚");
          return;
        }
        openScheduleModal(currentDayIndex, 0);
      });
    }

    if (scheduleSave) {
      scheduleSave.addEventListener("click", () => {
        if (editingDayIndex === null || editingScheduleIndex === null) {
          closeModal(scheduleModal);
          return;
        }
        const item = tripData.days[editingDayIndex].schedule[editingScheduleIndex];
        item.time = scheduleTime.value.trim() || "TBD";
        item.tag = scheduleTag.value.trim() || "TBD";
        item.title = scheduleTitle.value.trim() || "æœªå‘½åè¡Œç¨‹";
        item.sub = scheduleSub.value.trim();
        item.note = scheduleNote.value.trim();
        item.map = scheduleMap.value.trim();

        const afterSave = () => {
          sortScheduleForDay(editingDayIndex);
          saveAllToFirebase(); // åŒæ­¥åˆ°é›²ç«¯
          closeModal(scheduleModal);
        };

        const file = scheduleImageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            item.image = ev.target.result;
            afterSave();
          };
          reader.readAsDataURL(file);
        } else {
          afterSave();
        }
      });
    }

    function openWeatherModal(dayIdx) {
      editingWeatherDayIndex = dayIdx;
      const w = tripData.days[dayIdx].weather;
      weatherStatusInput.value = w.status || "";
      weatherNoteInput.value = w.note || "";
      openModal(weatherModal);
    }

    if (weatherSave) {
      weatherSave.addEventListener("click", () => {
        if (editingWeatherDayIndex === null) {
          closeModal(weatherModal);
          return;
        }
        const w = tripData.days[editingWeatherDayIndex].weather;
        w.status = weatherStatusInput.value.trim() || w.status;
        w.note = weatherNoteInput.value.trim() || w.note;
        saveAllToFirebase(); // åŒæ­¥åˆ°é›²ç«¯
        closeModal(weatherModal);
      });
    }
    
    // Image Viewer
    const imageViewer = document.getElementById("imageViewer");
    const imageViewerImg = document.getElementById("imageViewerImg");
    if (shoppingGridAllEl && imageViewer && imageViewerImg) {
      shoppingGridAllEl.addEventListener("click", e => {
        const img = e.target.closest(".shopping-img");
        if (!img) return;
        imageViewerImg.src = img.src;
        imageViewer.classList.add("show");
      });
      imageViewer.addEventListener("click", () => {
        imageViewer.classList.remove("show");
      });
    }
    
    // View Navigation
    const navBtns = document.querySelectorAll(".hero-nav-btn");
    const viewPlan = document.getElementById("view-plan");
    const viewFx = document.getElementById("view-fx");
    const viewShopping = document.getElementById("view-shopping");
    const viewExpense = document.getElementById("view-expense");
    
    const viewMap = { plan: viewPlan, fx: viewFx, shopping: viewShopping, expense: viewExpense };

    function setView(view) {
      Object.entries(viewMap).forEach(([key, el]) => {
        if (!el) return;
        el.style.display = key === view ? "block" : "none";
      });
      navBtns.forEach(btn => btn.classList.toggle("active", btn.dataset.view === view));
    }

    navBtns.forEach(btn => {
      btn.addEventListener("click", () => setView(btn.dataset.view));
    });

    // ========= 6. åˆå§‹åŒ– (è³‡æ–™å¾ Firebase è¼‰å…¥å¾Œå‘¼å«) =========
    function initView() {
      tripData.days.forEach((_, idx) => sortScheduleForDay(idx)); // æ’åºè¡Œç¨‹
      if (heroBg && heroEl) heroEl.style.backgroundImage = `url(${heroBg})`; // è¨­å®šèƒŒæ™¯åœ–
      renderTabs(); // æ¸²æŸ“åˆ†é 
      renderDayContent(); // æ¸²æŸ“è¡Œç¨‹å…§å®¹
      initRate(); // åŒ¯ç‡åŠŸèƒ½
      renderShopping(); // è³¼ç‰©æ¸…å–®
      renderExpenses(); // è²»ç”¨æ¸…å–®
      setView("plan"); // é è¨­é¡¯ç¤ºè¡Œç¨‹é 
    }
</script>
