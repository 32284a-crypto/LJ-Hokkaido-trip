<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Hokkaido 2025ï½œç›¸è¦ªç›¸æ„›åˆä¸€å¹´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="Hokkaido 2025ï½œç›¸è¦ªç›¸æ„›åˆä¸€å¹´" />
  <meta property="og:description" content="Luna & Jen çš„åŒ—æµ·é“æ»‘é›ªæ—…éŠå°æœ¬ğŸ§£â„ï¸" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f4f8ff;
      color: #123456;
    }
    .app {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      background: #f4f8ff;
    }

    /* é ‚éƒ¨ banner */
    .hero {
      position: relative;
      padding: 16px 16px 20px;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      background: linear-gradient(135deg, #bde3ff, #e5f4ff);
      background-size: cover;
      background-position: center;
      color: #123456;
      overflow: hidden;
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(189,227,255,0.9), rgba(229,244,255,0.9));
      pointer-events: none;
    }
    .hero-inner {
      position: relative;
      z-index: 1;
    }
    .hero-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 2px;
    }
    .hero-sub {
      margin-top: 4px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* å³ä¸Šè§’ iconï¼ˆå¯æ›èƒŒæ™¯ï¼‰ */
    .hero-bg-icon {
      position: absolute;
      top: 10px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      z-index: 2;
    }

    /* åœ“å½¢ icon å°è¦½ */
    .hero-nav {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }
    .hero-nav-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
    }
    .hero-nav-btn.active {
      background: #0b67ff;
      color: #fff;
    }

    .hero-toolbar {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .hero-btn {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .hero-btn span {
      font-size: 14px;
    }

    .hero-tabs {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .day-tab {
      min-width: 80px;
      padding: 8px 10px;
      border-radius: 14px;
      text-align: center;
      font-size: 12px;
      background: rgba(255,255,255,0.8);
      cursor: pointer;
      white-space: nowrap;
    }
    .day-tab.active {
      background: #0b67ff;
      color: #fff;
      font-weight: 600;
    }

    .content {
      padding: 16px;
      padding-bottom: 40px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    .card-subtitle {
      font-size: 12px;
      opacity: 0.7;
    }
    .icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: #e6f0ff;
    }

    /* å¤©æ°£å¡ */
    .weather-main {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }
    .weather-temp {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }
    .weather-temp span:nth-child(1) {
      font-size: 28px;
      font-weight: 700;
    }
    .weather-temp span:nth-child(2) {
      font-size: 12px;
      opacity: 0.7;
    }
    .weather-extra {
      font-size: 12px;
      text-align: right;
    }

    /* è¡Œç¨‹ timeline */
    .timeline-item {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: flex-start;
    }
    .timeline-time {
      font-size: 12px;
      font-weight: 600;
      width: 46px;
      flex-shrink: 0;
    }
    .timeline-body {
      flex: 1;
    }
    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f0f3ff;
      margin-bottom: 2px;
    }
    .timeline-title {
      font-size: 13px;
      font-weight: 600;
    }
    .timeline-sub {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }
    .timeline-note {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 2px;
    }
    .timeline-edit {
      margin-left: 6px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0.7;
    }
    .timeline-map-link {
      display: inline-block;
      font-size: 11px;
      margin-top: 2px;
      color: #0b67ff;
      text-decoration: none;
    }
    .timeline-map-link::after {
      content: " â†—";
      font-size: 10px;
    }
    .timeline-img {
      width: 100%;
      max-height: 160px;
      object-fit: cover;
      border-radius: 12px;
      margin-top: 6px;
    }

    /* åŒ¯ç‡ */
    .rate-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 13px;
    }
    .rate-row input {
      width: 45%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #d0ddff;
      font-size: 13px;
    }
    .rate-meta {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    /* è³¼ç‰©æ¸…å–® */
    .shopping-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    .shopping-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-size: 12px;
    }
    .shopping-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .shopping-note {
      opacity: 0.75;
      font-size: 11px;
      margin-top: 2px;
    }
    .shopping-img {
      width: 100%;
      border-radius: 12px;
      object-fit: cover;
      margin-top: 6px;
      max-height: 120px;
    }

    /* è²»ç”¨ç´€éŒ„ */
    .total-card-main {
      font-size: 18px;
      font-weight: 700;
    }
    .total-card-sub {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.85;
    }
    .expense-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f2ff;
    }
    .expense-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .expense-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #c5d8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #fff;
      flex-shrink: 0;
    }
    .expense-text-main {
      font-size: 13px;
      font-weight: 600;
    }
    .expense-text-sub {
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }
    .expense-right {
      text-align: right;
      font-size: 13px;
    }
    .expense-delete {
      color: #ff4d4f;
      font-size: 14px;
      cursor: pointer;
      margin-left: 8px;
    }

    /* æ”¯ä»˜äºº pill æŒ‰éˆ• */
    .pill-group {
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .pill-btn {
      border-radius: 999px;
      border: 1px solid #d0ddff;
      padding: 4px 10px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
    }
    .pill-btn.active {
      background: #0b67ff;
      color: #fff;
      border-color: #0b67ff;
    }

    /* åªåœ¨åˆ‡æ›çš„ view ä¸Šé¡¯ç¤º */
    .view-section {
      display: none;
    }

    /* æµ®å‹•æ–°å¢æŒ‰éˆ• */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #ffd54f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      cursor: pointer;
      z-index: 20;
    }

    /* Modal é€šç”¨ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      width: 90%;
      max-width: 360px;
      background: #fff;
      border-radius: 18px;
      padding: 16px 16px 14px;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .form-group {
      margin-bottom: 8px;
      font-size: 12px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d0ddff;
      padding: 6px 8px;
      font-size: 13px;
      resize: vertical;
    }
    .upload-box {
      border: 1px dashed #c2ccee;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      font-size: 12px;
      color: #7683a8;
      margin-top: 4px;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
    }
    .btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      border: none;
      cursor: pointer;
    }
    .btn-secondary {
      background: #f3f5ff;
      color: #333;
    }
    .btn-primary {
      background: #0b67ff;
      color: #fff;
    }

    .footer-space { height: 80px; }
    @media (min-width: 768px) {
      .fab { right: calc(50% - 215px); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- é ‚éƒ¨ Banner -->
    <header class="hero" id="hero">
      <div class="hero-overlay"></div>
      <div class="hero-inner">
        <button class="hero-bg-icon" id="changeBgBtn" title="æ›´æ›èƒŒæ™¯">ğŸ¿</button>

        <div class="hero-title">Hokkaido</div>
        <div class="hero-sub">2025 ç›¸è¦ªç›¸æ„›åˆä¸€å¹´</div>

        <!-- åœ“å½¢ icon å°è¦½ -->
        <div class="hero-nav">
          <button class="hero-nav-btn active" data-view="plan" title="è¡Œç¨‹">ğŸ—ºï¸</button>
          <button class="hero-nav-btn" data-view="fx" title="åŒ¯ç‡">ğŸ’±</button>
          <button class="hero-nav-btn" data-view="shopping" title="è³¼ç‰©æ¸…å–®">ğŸ§º</button>
          <button class="hero-nav-btn" data-view="expense" title="è²»ç”¨ç´€éŒ„">ğŸ’³</button>
        </div>

        <!-- ç·¨è¼¯è¡Œç¨‹ -->
        <div class="hero-toolbar">
          <button class="hero-btn" id="editTodayBtn">
            <span>âœï¸</span> ç·¨è¼¯ä»Šæ—¥è¡Œç¨‹
          </button>
        </div>

        <input type="file" id="bgFileInput" accept="image/*" style="display:none" />

        <!-- Day Tabs -->
        <div class="hero-tabs" id="dayTabs"></div>
      </div>
    </header>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="content">
      <!-- è¡Œç¨‹ view -->
      <section id="view-plan">
        <section id="dayContent"></section>
      </section>

      <!-- åŒ¯ç‡ view -->
      <section id="view-fx" class="view-section">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">ğŸ’±</span>
              åŒ¯ç‡æ›ç®—
            </div>
            <div class="card-subtitle">JPY â†” TWD</div>
          </div>
          <div class="rate-row">
            <input id="jpyInput" type="number" value="50000" />
            <span>â‡„</span>
            <input id="twdInput" type="number" value="10750" />
          </div>
          <div class="rate-meta" id="rateText"></div>
        </section>
      </section>

      <!-- è³¼ç‰© viewï¼šåº—å®¶ç¯©é¸ï¼‹å¡ç‰‡ -->
      <section id="view-shopping" class="view-section">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">ğŸ§º</span>
              è³¼ç‰©æ¸…å–®
            </div>
            <div class="card-subtitle">å¯ä¾åº—å®¶æˆ–äººä¾†ç®¡ç†</div>
          </div>

          <div class="form-group" style="margin-top:4px;">
            <label style="font-size:12px;">ä¾åº—å®¶ç¯©é¸</label>
            <select id="shoppingStoreFilter" style="width:100%;border-radius:10px;border:1px solid #d0ddff;padding:4px 8px;font-size:13px;">
              <option value="ALL">å…¨éƒ¨åº—å®¶</option>
              <option value="ç„¡å°è‰¯å“">ç„¡å°è‰¯å“</option>
              <option value="å¤§å‰µ">å¤§å‰µ</option>
              <option value="3COINS">3COINS</option>
              <option value="Hands">Hands</option>
              <option value="è¶…å•†">è¶…å•†ï¼ˆå…±ç”¨ï¼‰</option>
              <option value="7-11">7-11</option>
              <option value="Lawson">Lawson</option>
              <option value="å…¨å®¶">å…¨å®¶</option>
              <option value="è—¥å¦åº—">è—¥å¦åº—</option>
            </select>
          </div>

          <div class="shopping-grid" id="shoppingGridAll"></div>
        </section>
      </section>

      <!-- è²»ç”¨ view -->
      <section id="view-expense" class="view-section">
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">ğŸ’³</span>
              è²»ç”¨ç´€éŒ„
            </div>
            <div class="card-subtitle">å¯è¨»è¨˜ä»˜æ¬¾äººï¼šLuna / Jen / å…¬åŸºé‡‘</div>
          </div>
          <div class="total-card-main" id="totalJPY">Â¥0</div>
          <div class="total-card-sub" id="totalTWD">ç´„ NT$0</div>
          <div class="total-card-sub" id="settleSummary"></div>

          <div id="expenseList" style="margin-top:10px;"></div>
        </section>
      </section>

      <div class="footer-space"></div>
    </main>
  </div>

  <!-- æµ®å‹•æ–°å¢æŒ‰éˆ• -->
  <div class="fab" id="fabBtn">ï¼‹</div>

  <!-- æ–°å¢é¡å‹é¸æ“‡ Modal -->
  <div class="modal-overlay" id="typeModal">
    <div class="modal">
      <div class="modal-title">è¦æ–°å¢ä»€éº¼ï¼Ÿ</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="typeCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="addShoppingBtn">è³¼ç‰©æ¸…å–®</button>
        <button class="btn btn-primary" id="addExpenseBtn">è²»ç”¨</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢è³¼ç‰©æ¸…å–® Modal -->
  <div class="modal-overlay" id="shoppingModal">
    <div class="modal">
      <div class="modal-title">æ–°å¢è³¼ç‰©æ¸…å–®</div>
      <div class="form-group">
        <label>å•†å“åç¨±</label>
        <input type="text" id="shoppingName" placeholder="ä¾‹ï¼šå…­èŠ±äº­ å¥¶æ²¹è‘¡è„å¤¾å¿ƒé¤…" />
      </div>
      <div class="form-group">
        <label>åœ¨å“ªè£¡è²·å¾—åˆ°ï¼ˆåº—å®¶ï¼‰</label>
        <select id="shoppingStore">
          <option value="">æœªæŒ‡å®š</option>
          <option value="ç„¡å°è‰¯å“">ç„¡å°è‰¯å“</option>
          <option value="å¤§å‰µ">å¤§å‰µ</option>
          <option value="3COINS">3COINS</option>
          <option value="Hands">Hands</option>
          <option value="è¶…å•†">è¶…å•†ï¼ˆå…±ç”¨ï¼‰</option>
          <option value="7-11">7-11</option>
          <option value="Lawson">Lawson</option>
          <option value="å…¨å®¶">å…¨å®¶</option>
          <option value="è—¥å¦åº—">è—¥å¦åº—</option>
        </select>
      </div>
      <div class="form-group">
        <label>å‚™è¨» / å“ªå®¶åˆ†åº—</label>
        <textarea id="shoppingNote" rows="2" placeholder="ä¾‹ï¼šæ–°åƒæ­²æ©Ÿå ´ / æœ­å¹Œæœ¬åº— / å¤šå®¶è—¥å¦åº—éƒ½æœ‰"></textarea>
      </div>
      <div class="form-group">
        <label>èª°è¦è²·ï¼Ÿ</label>
        <select id="shoppingOwner">
          <option value="Luna">Luna</option>
          <option value="Jen">Jen</option>
        </select>
      </div>
      <div class="form-group">
        <label>ä¸Šå‚³ç…§ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
        <div class="upload-box">
          <input type="file" id="shoppingImageInput" accept="image/*" />
          <div style="margin-top:4px;">é¸ä¸€å¼µå•†å“åœ–ç‰‡ï¼ˆæœƒå­˜åœ¨é€™å°è£ç½®çš„ç€è¦½å™¨ï¼‰</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="shoppingCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="shoppingSave">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢è²»ç”¨ Modalï¼ˆç„¡é¡åˆ¥ï¼Œæœ‰ä»˜æ¬¾äºº pillï¼‰ -->
  <div class="modal-overlay" id="expenseModal">
    <div class="modal">
      <div class="modal-title">æ–°å¢è²»ç”¨ç´€éŒ„</div>
      <div class="form-group">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="expenseTitle" placeholder="ä¾‹ï¼šç™»åˆ¥æº«æ³‰é£¯åº—" />
      </div>
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="expenseDate" />
      </div>
      <div class="form-group">
        <label>ä»˜æ¬¾æ–¹å¼ï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="expenseMethod" placeholder="ä¾‹ï¼šä¿¡ç”¨å¡ / ç¾é‡‘ / ç·šä¸Šä»˜æ¬¾" />
      </div>
      <div class="form-group">
        <label>ä»˜æ¬¾äºº</label>
        <div class="pill-group" id="expensePayerGroup">
          <button type="button" class="pill-btn active" data-payer="Luna">Luna</button>
          <button type="button" class="pill-btn" data-payer="Jen">Jen</button>
          <button type="button" class="pill-btn" data-payer="å…¬åŸºé‡‘">å…¬åŸºé‡‘</button>
        </div>
      </div>
      <div class="form-group">
        <label>é‡‘é¡ + å¹£åˆ¥ï¼ˆè¨˜ã€Œç¸½é¡ã€ï¼Œç³»çµ±æœƒå¹«å¿™å¹³åˆ†ï¼‰</label>
        <div style="display:flex;gap:8px;">
          <input type="number" id="expenseAmount" placeholder="é‡‘é¡" />
          <select id="expenseCurrency">
            <option value="JPY">JPY</option>
            <option value="TWD">TWD</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="expenseCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="expenseSave">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å¤©æ°£ Modal -->
  <div class="modal-overlay" id="weatherModal">
    <div class="modal">
      <div class="modal-title">ç·¨è¼¯ä»Šæ—¥å¤©æ°£æ–‡å­—</div>
      <div class="form-group">
        <label>å¤©æ°£ç‹€æ…‹ï¼ˆå³ä¸Šé‚£è¡Œï¼‰</label>
        <input type="text" id="weatherStatus" placeholder="ä¾‹ï¼šå¸‚å€æ—¥ & æ›é£¯åº—" />
      </div>
      <div class="form-group">
        <label>è£œå……èªªæ˜ï¼ˆå³ä¸‹é‚£è¡Œï¼‰</label>
        <textarea id="weatherNote" rows="2" placeholder="ä¾‹ï¼šç™½å¤©æœ­å¹Œå¸‚å€ & ä½ç›¸éµè–„é‡"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="weatherCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="weatherSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯è¡Œç¨‹ Modalï¼ˆå« Google Map é€£çµ + åœ–ç‰‡ï¼‰ -->
  <div class="modal-overlay" id="scheduleModal">
    <div class="modal">
      <div class="modal-title">ç·¨è¼¯è¡Œç¨‹</div>
      <div class="form-group">
        <label>æ™‚é–“</label>
        <input type="text" id="scheduleTime" placeholder="ä¾‹ï¼š07:50 æˆ– TBD" />
      </div>
      <div class="form-group">
        <label>æ¨™ç±¤ï¼ˆtagï¼‰</label>
        <input type="text" id="scheduleTag" placeholder="ä¾‹ï¼šå»ç¨‹ / æ™¯é» / æ»‘é›ª / TBD" />
      </div>
      <div class="form-group">
        <label>æ¨™é¡Œï¼ˆtitleï¼‰</label>
        <input type="text" id="scheduleTitle" placeholder="ä¾‹ï¼šæ—­å±±å‹•ç‰©åœ’" />
      </div>
      <div class="form-group">
        <label>å‰¯æ¨™ï¼ˆsubï¼‰</label>
        <input type="text" id="scheduleSub" placeholder="ä¾‹ï¼šç´„ 1 å°æ™‚ 40 åˆ† Â· è‡ªç”±æ´»å‹•" />
      </div>
      <div class="form-group">
        <label>å‚™è¨»ï¼ˆnoteï¼Œå¯ç•™ç™½ï¼‰</label>
        <textarea id="scheduleNote" rows="2" placeholder="ä¾‹ï¼šæœ¬è¡Œç¨‹åŒ…å«é–€ç¥¨"></textarea>
      </div>
      <div class="form-group">
        <label>Google åœ°åœ–é€£çµï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="scheduleMap" placeholder="https://maps.app.goo.gl/..." />
      </div>
      <div class="form-group">
        <label>è¡Œç¨‹åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</label>
        <div class="upload-box">
          <input type="file" id="scheduleImageInput" accept="image/*" />
          <div style="margin-top:4px;">é¸ä¸€å¼µé€™å€‹æ™¯é»çš„ç…§ç‰‡</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="scheduleCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="scheduleSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ========= 1. é è¨­æ—…éŠè³‡æ–™ =========
    const defaultTripData = {
      days: [
        {
          id: "2025-12-24",
          label: "Day1 12/24",
          weather: {
            temp: -1,
            low: -6,
            feels: -8,
            status: "æŠµé”æ—¥",
            note: "é…·èˆª TR892 Â· æŠµé”æœ­å¹Œ & ä½ VESSEL"
          },
          schedule: [
            {
              time: "09:30",
              tag: "å»ç¨‹",
              title: "æ¡ƒåœ’æ©Ÿå ´å ±åˆ°",
              sub: "TPE Â· é…·èˆª TR892",
              note: "å»ºè­°èµ·é£›å‰ 3 å°æ™‚åˆ°æ©Ÿå ´",
              map: "",
              image: ""
            },
            {
              time: "12:30",
              tag: "å»ç¨‹",
              title: "TR892 TPE â†’ CTS",
              sub: "é…·èˆª TR892 12:30 èµ·é£›ï¼Œé è¨ˆ 17:20 æŠµé”",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "17:20",
              tag: "æŠµé”",
              title: "æ–°åƒæ­²æ©Ÿå ´ (CTS)",
              sub: "å…¥å¢ƒã€é ˜è¡Œæã€å‰å¾€æœ­å¹Œ",
              note: "å¯åœ¨æ©Ÿå ´å…ˆè²·äº¤é€šå¡ / ä¸Šå»æ‰€ / å°è£œçµ¦",
              map: "https://maps.app.goo.gl/",
              image: ""
            },
            {
              time: "19:30",
              tag: "å…¥ä½",
              title: "VESSEL HOTEL ä¸­å³¶å…¬åœ’",
              sub: "12/24â€“12/26 Â· 14:00 å…¥ä½ / 11:00 é€€æˆ¿",
              note: "æ”¾å¥½è¡Œæï¼Œå¯å»é™„è¿‘é€›é€› / è¶…å¸‚ / ä¾¿åˆ©å•†åº—",
              map: "",
              image: ""
            },
            {
              time: "21:00",
              tag: "TBD",
              title: "æœ­å¹Œå¤œæ•£æ­¥ï¼ˆå¾…æ±ºå®šï¼‰",
              sub: "å¤§é€šå…¬åœ’ / ç‹¸å°è·¯ or å…¶ä»–",
              note: "",
              map: "",
              image: ""
            }
          ]
        },
        {
          id: "2025-12-25",
          label: "Day2 12/25",
          weather: {
            temp: -5,
            low: -10,
            feels: -12,
            status: "Klook ä¸€æ—¥éŠ",
            note: "æ—­å±±å‹•ç‰©åœ’ + é’æ±  + ç™½é¬šç€‘å¸ƒ + ç²¾éˆéœ²è‡º"
          },
          schedule: [
            {
              time: "07:50",
              tag: "å»ç¨‹",
              title: "é›†åˆå‡ºç™¼",
              sub: "æœ­å¹Œ â†’ æ—­å·æ–¹å‘ï¼ˆä¾æ†‘è­‰é›†åˆé»ï¼‰",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "10:30",
              tag: "æ™¯é»",
              title: "æ—­å±±å‹•ç‰©åœ’",
              sub: "ç´„ 1 å°æ™‚ 40 åˆ† Â· è‡ªç”±æ´»å‹•",
              note: "æœ¬è¡Œç¨‹åŒ…å«æ—­å±±å‹•ç‰©åœ’é–€ç¥¨",
              map: "",
              image: ""
            },
            {
              time: "13:10",
              tag: "æ™¯é»",
              title: "ç™½é‡‘é’æ± ",
              sub: "ç´„ 15 åˆ†é˜ Â· è‡ªç”±æ´»å‹•",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "13:30",
              tag: "æ™¯é»",
              title: "ç™½é¬šç€‘å¸ƒ",
              sub: "ç´„ 25 åˆ†é˜ Â· è‡ªç”±æ´»å‹•",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "15:00",
              tag: "æ™¯é»",
              title: "æ£®æ—ç²¾éˆéœ²è‡º",
              sub: "ç´„ 1 å°æ™‚ 20 åˆ† Â· è‡ªç”±æ´»å‹•",
              note: "æ‹ç…§ã€æ•£æ­¥ã€å–æ±è¥¿",
              map: "",
              image: ""
            },
            {
              time: "18:30",
              tag: "å›ç¨‹",
              title: "è¿”å›æœ­å¹Œ",
              sub: "å›åˆ°é›†åˆåœ°é»é™„è¿‘è§£æ•£",
              note: "æ™šé¤ / å¤œæ™šè¡Œç¨‹ TBD",
              map: "",
              image: ""
            }
          ]
        },
        {
          id: "2025-12-26",
          label: "Day3 12/26",
          weather: {
            temp: -3,
            low: -8,
            feels: -10,
            status: "å¸‚å€æ—¥ & æ›é£¯åº—",
            note: "ç™½å¤©æœ­å¹Œå¸‚å€ & ä½ç›¸éµè–„é‡"
          },
          schedule: [
            {
              time: "08:00",
              tag: "æ™¯é»",
              title: "åŒ—æµ·é“ç¥å®®",
              sub: "æ—©ä¸Šæ•£æ­¥ Â· åƒæ¸…é¤… / æŠ•å¹£æ±‚ç±¤",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "12:00",
              tag: "æ™¯é»",
              title: "åŒ—æµ·é“å»³æœ¬å»³èˆ",
              sub: "ç´…ç£šå»ºç¯‰ Â· æ‹ç…§æ•£æ­¥",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "15:00",
              tag: "æ›é£¯åº—",
              title: "ç›¸éµ FRESA INN è–„é‡",
              sub: "12/26â€“12/29 Â· 15:00 å…¥ä½ / 11:00 é€€æˆ¿",
              note: "",
              map: "",
              image: ""
            }
          ]
        },
        {
          id: "2025-12-27",
          label: "Day4 12/27",
          weather: {
            temp: -6,
            low: -12,
            feels: -15,
            status: "æ»‘é›ªæ—¥",
            note: "é›ªé•·å§ Â· æ‰‹ç¨»æ»‘é›ªå ´"
          },
          schedule: [
            {
              time: "07:00",
              tag: "å‡ºç™¼",
              title: "æœ­å¹Œ â†’ æ‰‹ç¨»æ»‘é›ªå ´",
              sub: "æ­ JR / å·´å£«ï¼ˆä¾å¯¦éš›å®‰æ’ï¼‰",
              note: "å‰ä¸€å¤©å…ˆç¢ºèªè»Šç­æ™‚é–“",
              map: "",
              image: ""
            },
            {
              time: "09:00",
              tag: "æ»‘é›ª",
              title: "é›†åˆ & ç§Ÿè£å‚™",
              sub: "æ‰‹ç¨»æ»‘é›ªå ´ Â· èˆ‡é›ªé•·å§æœƒåˆ",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "10:00",
              tag: "æ»‘é›ª",
              title: "æ»‘é›ªæ•™å­¸ & è‡ªç”±æ»‘",
              sub: "ä¸­åˆå¯åœ¨é›ªå ´ç”¨é¤",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "16:00",
              tag: "å›ç¨‹",
              title: "é›¢é–‹æ‰‹ç¨»æ»‘é›ªå ´",
              sub: "æ­è»Šè¿”å›æœ­å¹Œ",
              note: "å›åˆ°è–„é‡é™„è¿‘åƒæ™šé¤ / æ³¡æ¹¯ TBD",
              map: "",
              image: ""
            }
          ]
        },
        {
          id: "2025-12-28",
          label: "Day5 12/28",
          weather: {
            temp: -6,
            low: -12,
            feels: -15,
            status: "è‡ªç”±æ»‘é›ª / è‡ªç”±è¡Œ",
            note: "çœ‹ç‹€æ³å†æ±ºå®šè¦å»å“ªè£¡ç©é›ªæˆ–å¸‚å€é€›è¡—"
          },
          schedule: [
            {
              time: "TBD",
              tag: "TBD",
              title: "è‡ªç”±æ»‘é›ª or å¸‚å€è¡Œç¨‹",
              sub: "ä¹‹å¾Œå†è‡ªå·±æ±ºå®šç´°ç¯€",
              note: "",
              map: "",
              image: ""
            }
          ]
        },
        {
          id: "2025-12-29",
          label: "Day6 12/29",
          weather: {
            temp: -3,
            low: -8,
            feels: -10,
            status: "å›ç¨‹æ—¥",
            note: "æ”¶æ‹¾è¡Œæ + æ©Ÿå ´æ¡è²·"
          },
          schedule: [
            {
              time: "11:00",
              tag: "é€€æˆ¿",
              title: "é€€æˆ¿ Â· ç›¸éµ FRESA INN è–„é‡",
              sub: "æœ€æ™š 11:00 é€€æˆ¿ï¼Œå¯å…ˆå¸¶è¡Œæå»æœ­å¹Œç«™å¯„ç‰©",
              note: "",
              map: "",
              image: ""
            },
            {
              time: "12:00",
              tag: "å‰å¾€æ©Ÿå ´",
              title: "æœ­å¹Œ â†’ æ–°åƒæ­²æ©Ÿå ´",
              sub: "æ­ JR / å·´å£«å‰å¾€ CTS",
              note: "é ç•™æ™‚é–“é€›æ©Ÿå ´ & è²·ä¼´æ‰‹ç¦®",
              map: "",
              image: ""
            },
            {
              time: "13:55",
              tag: "å›ç¨‹",
              title: "FD243 CTS â†’ TPE",
              sub: "Airasia FD243 13:55 èµ·é£›ï¼Œé è¨ˆ 17:55 æŠµé”",
              note: "",
              map: "",
              image: ""
            }
          ]
        }
      ],
      fx: { rate: 0.215 },
      // åˆå§‹è³¼ç‰©æ¸…å–®ï¼ˆæ–‡å­—ç‰ˆï¼Œå¯å†è‡ªå·±æ–°å¢ï¼‰
      defaultShopping: [
        // ç„¡å°è‰¯å“
        { id: "s-muji-01", owner: "Luna", store: "ç„¡å°è‰¯å“", name: "ç¦å‰èŒ¶", note: "" },

        // å¤§å‰µ
        { id: "s-daiso-01", owner: "Luna", store: "å¤§å‰µ", name: "æŠ˜ç–Šæ¢³å­", note: "" },
        { id: "s-daiso-02", owner: "Luna", store: "å¤§å‰µ", name: "é‹ç½ï¼ˆæ”¶ç´ç”¨ï¼‰", note: "" },

        // 3COINS
        { id: "s-3c-01", owner: "Luna", store: "3COINS", name: "æ—…è¡Œæ”¶ç´è¢‹", note: "" },
        { id: "s-3c-02", owner: "Luna", store: "3COINS", name: "å¤šåŠŸèƒ½å¾®æ³¢èª¿ç†çƒ¤ç›¤", note: "" },
        { id: "s-3c-03", owner: "Luna", store: "3COINS", name: "æ¯›å·¾æ‰‹å¥—", note: "" },
        { id: "s-3c-04", owner: "Luna", store: "3COINS", name: "æ©˜è‰²é›œç‰©è¢‹", note: "" },

        // Hands
        { id: "s-hands-01", owner: "Luna", store: "Hands", name: "Pincha å³é£²æŠ¹èŒ¶å¡Š", note: "" },

        // è¶…å•†é€šç”¨
        { id: "s-cvs-01", owner: "Luna", store: "è¶…å•†", name: "å¥é”å‡ºå¥‡è›‹ çš®å…‹æ•", note: "" },

        // 7-11
        { id: "s-711-01", owner: "Luna", store: "7-11", name: "å¸¶çš®è–¯æ¢", note: "" },
        { id: "s-711-02", owner: "Luna", store: "7-11", name: "è‘¡è„é¤…ä¹¾", note: "" },

        // Lawson
        { id: "s-lawson-01", owner: "Luna", store: "Lawson", name: "é»ƒè±†ç²‰ç¶œåˆå …æœ", note: "" },

        // å…¨å®¶
        { id: "s-family-01", owner: "Luna", store: "å…¨å®¶", name: "Calbee æ£®æ°¸7æ¿€æ´‹èŠ‹ç‰‡ï¼ˆæš«åï¼‰", note: "" },
        { id: "s-family-02", owner: "Luna", store: "å…¨å®¶", name: "åŠç”Ÿæ°´èœœæ¡ƒä¹¾", note: "" },
        { id: "s-family-03", owner: "Luna", store: "å…¨å®¶", name: "é±ˆé­šè‚‰è…¸", note: "" },

        // å¯ä»¥å†æ…¢æ…¢è‡ªå·±åŠ ï¼šè—¥å¦ã€ç¾å¦ã€é¢è†œç­‰ç­‰
      ],
      // åˆå§‹è²»ç”¨ï¼ˆç”¨ç¸½é¡ï¼Œç³»çµ±æœƒå¹«å¿™å¹³åˆ†ï¼‰
      defaultExpenses: [
        {
          id: "e-hand-rent",
          title: "æ‰‹ç¨»é›ªå…·ç§Ÿå€Ÿ",
          date: "2025-11-17",
          method: "Jen å…ˆä»˜ NT$5,086",
          amount: 5086,
          currency: "TWD",
          payer: "Jen"
        },
        {
          id: "e-klook-day",
          title: "Klook ä¸€æ—¥",
          date: "2025-10-05",
          method: "Luna å…ˆä»˜ NT$3,423",
          amount: 3423,
          currency: "TWD",
          payer: "Luna"
        },
        {
          id: "e-hotel-1226-27",
          title: "12/26â€“12/27ï¼ˆ1æ™šï¼‰",
          date: "2025-09-06",
          method: "Jen å…ˆä»˜ NT$3,659",
          amount: 3659,
          currency: "TWD",
          payer: "Jen"
        },
        {
          id: "e-yuki-class",
          title: "é›ªé•·å§ä¸€æ—¥èª²",
          date: "2025-09-04",
          method: "Jen å…ˆä»˜ NT$14,000",
          amount: 14000,
          currency: "TWD",
          payer: "Jen"
        },
        {
          id: "e-hotel-1227-29",
          title: "12/27â€“12/29ï¼ˆ2æ™šï¼‰",
          date: "2025-09-04",
          method: "Luna å…ˆä»˜ NT$6,193",
          amount: 6193,
          currency: "TWD",
          payer: "Luna"
        },
        {
          id: "e-hotel-1224-26",
          title: "12/24â€“12/26ï¼ˆ2æ™šï¼‰",
          date: "2025-09-04",
          method: "Luna å…ˆä»˜ NT$7,903",
          amount: 7903,
          currency: "TWD",
          payer: "Luna"
        },
        {
          id: "e-flight",
          title: "æ©Ÿç¥¨",
          date: "2025-09-01",
          method: "Luna å…ˆä»˜ NT$28,296",
          amount: 28296,
          currency: "TWD",
          payer: "Luna"
        }
      ]
    };

    // ========= 2. localStorage =========
    const TRIP_KEY = "hk_trip_data_v3";
    const SHOP_KEY = "hk_shopping_v3";
    const EXP_KEY  = "hk_expenses_v4";
    const HERO_BG_KEY = "hk_hero_bg_v2";

    const safeParse = str => {
      try { return JSON.parse(str); } catch { return null; }
    };

    function loadTripData() {
      const data = localStorage.getItem(TRIP_KEY);
      return data ? safeParse(data) : null;
    }
    function saveTripData() {
      localStorage.setItem(TRIP_KEY, JSON.stringify(tripData));
    }
    function loadShopping() {
      const data = localStorage.getItem(SHOP_KEY);
      if (data) return safeParse(data) || defaultTripData.defaultShopping;
      return defaultTripData.defaultShopping;
    }
    function saveShopping() {
      localStorage.setItem(SHOP_KEY, JSON.stringify(shoppingList));
    }
    function loadExpenses() {
      const data = localStorage.getItem(EXP_KEY);
      if (data) return safeParse(data) || defaultTripData.defaultExpenses;
      return defaultTripData.defaultExpenses;
    }
    function saveExpenses() {
      localStorage.setItem(EXP_KEY, JSON.stringify(expenseList));
    }

    let tripData = loadTripData() || defaultTripData;
    let shoppingList = loadShopping();
    let expenseList = loadExpenses();

    // ========= 3. è¡Œç¨‹ & Tabs =========
    const dayTabsEl = document.getElementById("dayTabs");
    const dayContentEl = document.getElementById("dayContent");
    let currentDayIndex = 0;

    // æŠŠæ™‚é–“å­—ä¸²è½‰æˆåˆ†é˜ï¼Œéæ™‚é–“æ ¼å¼æ’æœ€å¾Œ
    function getTimeValue(t) {
      if (!t) return 24 * 60 + 59;
      const m = /^(\d{1,2}):(\d{2})$/.exec(t.trim());
      if (!m) return 24 * 60 + 59;
      const h = parseInt(m[1], 10), min = parseInt(m[2], 10);
      if (h < 0 || h > 23 || min < 0 || min > 59) return 24 * 60 + 59;
      return h * 60 + min;
    }

    function sortScheduleForDay(dayIdx) {
      const day = tripData.days[dayIdx];
      if (!day || !day.schedule) return;
      day.schedule.sort((a, b) => getTimeValue(a.time) - getTimeValue(b.time));
    }

    function renderTabs() {
      dayTabsEl.innerHTML = "";
      tripData.days.forEach((day, idx) => {
        const tab = document.createElement("div");
        tab.className = "day-tab" + (idx === currentDayIndex ? " active" : "");
        tab.textContent = day.label;
        tab.onclick = () => {
          currentDayIndex = idx;
          renderTabs();
          renderDayContent();
        };
        dayTabsEl.appendChild(tab);
      });
    }

    function renderDayContent() {
      const day = tripData.days[currentDayIndex];
      if (!day) return;

      // render å‰å…ˆæ’åº
      sortScheduleForDay(currentDayIndex);

      let html = `
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">â„ï¸</span>
              ${day.weather.temp}â„ƒ / ${day.weather.low}â„ƒ
            </div>
            <div style="text-align:right;">
              <div class="card-subtitle">${day.weather.status}</div>
              <span class="timeline-edit weather-edit" data-day="${currentDayIndex}">âœï¸</span>
            </div>
          </div>
          <div class="weather-main">
            <div class="weather-temp">
              <span>${day.weather.temp}Â°</span>
              <span>é«”æ„Ÿ ${day.weather.feels}Â°C</span>
            </div>
            <div class="weather-extra">
              <div>${day.weather.status}</div>
              <div>${day.weather.note}</div>
            </div>
          </div>
        </section>
      `;

      html += `
        <section class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">ğŸ—“</span>
              ä»Šæ—¥è¡Œç¨‹
            </div>
            <div class="card-subtitle">${day.label}</div>
          </div>
          ${day.schedule.map((item, idx) => `
            <div class="timeline-item">
              <div class="timeline-time">${item.time}</div>
              <div class="timeline-body">
                <div>
                  <span class="tag">${item.tag}</span>
                  <span class="timeline-edit" data-day="${currentDayIndex}" data-idx="${idx}">âœï¸</span>
                </div>
                <div class="timeline-title">${item.title}</div>
                <div class="timeline-sub">${item.sub || ""}</div>
                ${item.note ? `<div class="timeline-note">${item.note}</div>` : ""}
                ${item.map ? `<a href="${item.map}" target="_blank" class="timeline-map-link">ğŸ—ºï¸ Google åœ°åœ–</a>` : ""}
                ${item.image ? `<img class="timeline-img" src="${item.image}" alt="">` : ""}
              </div>
            </div>
          `).join("")}
        </section>
      `;

      dayContentEl.innerHTML = html;

      // è¡Œç¨‹ç·¨è¼¯
      document.querySelectorAll(".timeline-edit").forEach(btn => {
        if (btn.classList.contains("weather-edit")) return;
        btn.addEventListener("click", () => {
          const d = parseInt(btn.dataset.day, 10);
          const i = parseInt(btn.dataset.idx, 10);
          openScheduleModal(d, i);
        });
      });

      // å¤©æ°£ç·¨è¼¯
      document.querySelectorAll(".weather-edit").forEach(btn => {
        btn.addEventListener("click", () => {
          const d = parseInt(btn.dataset.day, 10);
          openWeatherModal(d);
        });
      });
    }

    // ========= 4. è³¼ç‰©æ¸…å–® =========
    const shoppingGridAllEl = document.getElementById("shoppingGridAll");
    const shoppingStoreFilter = document.getElementById("shoppingStoreFilter");

    function renderShopping() {
      if (!shoppingGridAllEl) return;

      const storeFilter = shoppingStoreFilter ? shoppingStoreFilter.value : "ALL";
      let items = shoppingList;
      if (storeFilter !== "ALL") {
        items = items.filter(i => i.store === storeFilter);
      }

      shoppingGridAllEl.innerHTML = items.map(item => `
        <div class="shopping-card">
          <div class="shopping-name">${item.name}</div>
          <div class="shopping-note">
            ${item.store ? `ğŸª ${item.store}` : ""}${item.owner ? ` Â· ğŸ‘¤ ${item.owner}` : ""}
          </div>
          ${item.note ? `<div class="shopping-note">${item.note}</div>` : ""}
          ${item.imageData ? `<img class="shopping-img" src="${item.imageData}" alt="">` : ""}
        </div>
      `).join("");
    }

    if (shoppingStoreFilter) {
      shoppingStoreFilter.addEventListener("change", renderShopping);
    }

    // ========= 5. è²»ç”¨ç´€éŒ„ =========
    const expenseListEl = document.getElementById("expenseList");
    const totalJPYEl = document.getElementById("totalJPY");
    const totalTWDEl = document.getElementById("totalTWD");

    function payerColor(p) {
      switch (p) {
        case "Luna": return "#ffb6c1";
        case "Jen": return "#90caf9";
        case "å…¬åŸºé‡‘": return "#a5d6a7";
        default: return "#78909c";
      }
    }

    // è¨ˆç®—ç¸½é¡ & çµç®—ï¼ˆåƒ LINE Splitï¼‰
    function calcTotalsAndSettlement() {
      let totalJPY = 0;
      const rate = tripData.fx.rate;

      const people = ["Luna", "Jen"];
      const balances = {
        Luna: { paid: 0, should: 0 },
        Jen:  { paid: 0, should: 0 }
      };

      expenseList.forEach(item => {
        let amountTWD = item.currency === "JPY"
          ? item.amount * rate
          : item.amount;

        // ç¸½é¡ï¼ˆä»¥ JPY è¡¨ç¤ºåªæ˜¯åƒè€ƒï¼‰
        if (item.currency === "JPY") {
          totalJPY += item.amount;
        } else {
          totalJPY += amountTWD / rate;
        }

        // å…¬åŸºé‡‘ä¸åƒèˆ‡ Luna / Jen åˆ†å¸³
        const share = amountTWD / people.length;
        people.forEach(p => {
          balances[p].should += share;
        });

        if (item.payer === "Luna") {
          balances.Luna.paid += amountTWD;
        } else if (item.payer === "Jen") {
          balances.Jen.paid += amountTWD;
        }
      });

      const totalTWD = Math.round(totalJPY * rate);
      totalJPYEl.textContent = "Â¥" + Math.round(totalJPY).toLocaleString();
      totalTWDEl.textContent = "ç´„ NT$" + totalTWD.toLocaleString();

      const settleEl = document.getElementById("settleSummary");
      if (!settleEl) return;

      const lText = `Lunaï¼šå¯¦ä»˜ NT$${Math.round(balances.Luna.paid).toLocaleString()} / æ‡‰ä»˜ NT$${Math.round(balances.Luna.should).toLocaleString()}`;
      const jText = `Jenï¼šå¯¦ä»˜ NT$${Math.round(balances.Jen.paid).toLocaleString()} / æ‡‰ä»˜ NT$${Math.round(balances.Jen.should).toLocaleString()}`;

      const netLuna = balances.Luna.paid - balances.Luna.should;
      let settleLine = "";
      const diff = Math.round(netLuna);

      if (Math.abs(diff) < 10) {
        settleLine = "ç›®å‰å¹¾ä¹å¹³æ‰‹ï¼Œä¸ç”¨äº’ç›¸è½‰å¸³ï½";
      } else if (diff > 0) {
        settleLine = `Jen å¤§ç´„éœ€è¦çµ¦ Luna NT$${diff.toLocaleString()}`;
      } else {
        settleLine = `Luna å¤§ç´„éœ€è¦çµ¦ Jen NT$${Math.abs(diff).toLocaleString()}`;
      }

      settleEl.innerHTML = `${lText}<br>${jText}<br><b>${settleLine}</b>`;
    }

    function renderExpenses() {
      if (!expenseListEl) return;
      expenseListEl.innerHTML = expenseList.map(item => `
        <div class="expense-item">
          <div class="expense-left">
            <div class="expense-icon" style="background:${payerColor(item.payer)};">
              ${item.payer || ""}
            </div>
            <div>
              <div class="expense-text-main">${item.title}</div>
              <div class="expense-text-sub">
                ${item.date || ""}${item.method ? " Â· " + item.method : ""}${item.payer ? " Â· " + item.payer : ""}
              </div>
            </div>
          </div>
          <div class="expense-right">
            <div>${item.currency === "JPY" ? "Â¥" : "NT$"}${item.amount.toLocaleString()}</div>
            <span class="expense-delete" data-id="${item.id}">âœ•</span>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".expense-delete").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          expenseList = expenseList.filter(e => e.id !== id);
          saveExpenses();
          renderExpenses();
        });
      });

      calcTotalsAndSettlement();
  
    }
    // ========= 6. åŒ¯ç‡ =========
    const jpyInput = document.getElementById("jpyInput");
    const twdInput = document.getElementById("twdInput");
    const rateText = document.getElementById("rateText");

    function updateFromJPY() {
      const jpy = parseFloat(jpyInput.value || "0");
      const twd = Math.round(jpy * tripData.fx.rate);
      twdInput.value = twd;
    }
    function updateFromTWD() {
      const twd = parseFloat(twdInput.value || "0");
      const jpy = Math.round(twd / tripData.fx.rate);
      jpyInput.value = jpy;
    }
    if (jpyInput && twdInput) {
      jpyInput.addEventListener("input", updateFromJPY);
      twdInput.addEventListener("input", updateFromTWD);
    }
    function initRate() {
      if (!rateText) return;
      rateText.textContent = `ç¤ºæ„åŒ¯ç‡ï¼š1 JPY â‰ˆ ${tripData.fx.rate} TWD`;
      updateFromJPY();
    }
    
    // ========= 7. Hero èƒŒæ™¯ =========
    const heroEl = document.getElementById("hero");
    const changeBgBtn = document.getElementById("changeBgBtn");
    const bgFileInput = document.getElementById("bgFileInput");

    function loadHeroBg() {
      const bg = localStorage.getItem(HERO_BG_KEY);
      if (bg && heroEl) {
        heroEl.style.backgroundImage = `url(${bg})`;
      }
    }
    if (changeBgBtn && bgFileInput) {
      changeBgBtn.addEventListener("click", () => bgFileInput.click());
      bgFileInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const dataUrl = ev.target.result;
          heroEl.style.backgroundImage = `url(${dataUrl})`;
          localStorage.setItem(HERO_BG_KEY, dataUrl);
        };
        reader.readAsDataURL(file);
      });
    }

    // ========= 8. View åˆ‡æ› =========
    const viewPlan = document.getElementById("view-plan");
    const viewFx = document.getElementById("view-fx");
    const viewShopping = document.getElementById("view-shopping");
    const viewExpense = document.getElementById("view-expense");
    const heroNavButtons = document.querySelectorAll(".hero-nav-btn");
    let currentView = "plan";

    const viewMap = { plan: viewPlan, fx: viewFx, shopping: viewShopping, expense: viewExpense };

    function setView(view) {
      currentView = view;
      Object.entries(viewMap).forEach(([key, el]) => {
        if (!el) return;
        el.style.display = key === view ? "block" : "none";
      });
      heroNavButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.view === view);
      });
    }

    heroNavButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.view;
        setView(view);
      });
    });

    // ========= 9. Modal & æ–°å¢ =========
    const fabBtn = document.getElementById("fabBtn");
    const typeModal = document.getElementById("typeModal");
    const typeCancel = document.getElementById("typeCancel");
    const addShoppingBtn = document.getElementById("addShoppingBtn");
    const addExpenseBtn = document.getElementById("addExpenseBtn");

    const shoppingModal = document.getElementById("shoppingModal");
    const shoppingCancel = document.getElementById("shoppingCancel");
    const shoppingSave = document.getElementById("shoppingSave");
    const shoppingName = document.getElementById("shoppingName");
    const shoppingNote = document.getElementById("shoppingNote");
    const shoppingOwner = document.getElementById("shoppingOwner");
    const shoppingStore = document.getElementById("shoppingStore");
    const shoppingImageInput = document.getElementById("shoppingImageInput");

    const expenseModal = document.getElementById("expenseModal");
    const expenseCancel = document.getElementById("expenseCancel");
    const expenseSave = document.getElementById("expenseSave");
    const expenseTitle = document.getElementById("expenseTitle");
    const expenseDate = document.getElementById("expenseDate");
    const expenseMethod = document.getElementById("expenseMethod");
    const expenseAmount = document.getElementById("expenseAmount");
    const expenseCurrency = document.getElementById("expenseCurrency");
    const expensePayerGroup = document.getElementById("expensePayerGroup");
    let currentExpensePayer = "Luna";

    const scheduleModal = document.getElementById("scheduleModal");
    const scheduleCancel = document.getElementById("scheduleCancel");
    const scheduleSave = document.getElementById("scheduleSave");
    const scheduleTime = document.getElementById("scheduleTime");
    const scheduleTag = document.getElementById("scheduleTag");
    const scheduleTitle = document.getElementById("scheduleTitle");
    const scheduleSub = document.getElementById("scheduleSub");
    const scheduleNote = document.getElementById("scheduleNote");
    const scheduleMap = document.getElementById("scheduleMap");
    const scheduleImageInput = document.getElementById("scheduleImageInput");
    const editTodayBtn = document.getElementById("editTodayBtn");

    const weatherModal = document.getElementById("weatherModal");
    const weatherCancel = document.getElementById("weatherCancel");
    const weatherSave = document.getElementById("weatherSave");
    const weatherStatusInput = document.getElementById("weatherStatus");
    const weatherNoteInput = document.getElementById("weatherNote");
    let editingWeatherDayIndex = null;

    const openModal = m => m.classList.add("show");
    const closeModal = m => m.classList.remove("show");

    if (fabBtn) {
      fabBtn.addEventListener("click", () => openModal(typeModal));
    }
    if (typeCancel) {
      typeCancel.addEventListener("click", () => closeModal(typeModal));
    }
    if (addShoppingBtn) {
      addShoppingBtn.addEventListener("click", () => {
        closeModal(typeModal);
        shoppingName.value = "";
        shoppingNote.value = "";
        shoppingOwner.value = "Luna";
        shoppingStore.value = "";
        shoppingImageInput.value = "";
        openModal(shoppingModal);
      });
    }
    if (addExpenseBtn) {
      addExpenseBtn.addEventListener("click", () => {
        closeModal(typeModal);
        expenseTitle.value = "";
        expenseMethod.value = "";
        expenseAmount.value = "";
        expenseCurrency.value = "JPY";
        currentExpensePayer = "Luna";
        const today = new Date().toISOString().slice(0,10);
        expenseDate.value = today;
        Array.from(expensePayerGroup.querySelectorAll(".pill-btn")).forEach(btn => {
          btn.classList.toggle("active", btn.dataset.payer === "Luna");
        });
        openModal(expenseModal);
      });
    }

    if (shoppingCancel) shoppingCancel.addEventListener("click", () => closeModal(shoppingModal));
    if (expenseCancel) expenseCancel.addEventListener("click", () => closeModal(expenseModal));
    if (scheduleCancel) scheduleCancel.addEventListener("click", () => closeModal(scheduleModal));
    if (weatherCancel) weatherCancel.addEventListener("click", () => closeModal(weatherModal));

    // ä»˜æ¬¾äºº pill
    if (expensePayerGroup) {
      expensePayerGroup.addEventListener("click", e => {
        const btn = e.target.closest(".pill-btn");
        if (!btn) return;
        currentExpensePayer = btn.dataset.payer;
        Array.from(expensePayerGroup.querySelectorAll(".pill-btn")).forEach(b => {
          b.classList.toggle("active", b === btn);
        });
      });
    }

    // æ–°å¢è³¼ç‰©
    if (shoppingSave) {
      shoppingSave.addEventListener("click", () => {
        const name = shoppingName.value.trim();
        if (!name) { alert("è«‹è¼¸å…¥å•†å“åç¨±"); return; }
        const note = shoppingNote.value.trim();
        const owner = shoppingOwner.value || "Luna";
        const store = shoppingStore.value || "";
        const file = shoppingImageInput.files[0];

        const addItem = imageData => {
          shoppingList.push({ id: "s" + Date.now(), owner, store, name, note, imageData });
          saveShopping();
          renderShopping();
        };

        if (file) {
          const reader = new FileReader();
          reader.onload = ev => addItem(ev.target.result);
          reader.readAsDataURL(file);
        } else {
          addItem(undefined);
        }
        closeModal(shoppingModal);
      });
    }

    // æ–°å¢è²»ç”¨
    if (expenseSave) {
      expenseSave.addEventListener("click", () => {
        const title = expenseTitle.value.trim();
        if (!title) { alert("è«‹è¼¸å…¥é …ç›®åç¨±"); return; }
        const amount = parseFloat(expenseAmount.value || "0");
        if (!amount || amount <= 0) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; }

        const data = {
          id: "e" + Date.now(),
          title,
          date: expenseDate.value,
          method: expenseMethod.value.trim(),
          amount,
          currency: expenseCurrency.value,
          payer: currentExpensePayer
        };
        expenseList.push(data);
        saveExpenses();
        renderExpenses();
        closeModal(expenseModal);
      });
    }

    // ========= 10. è¡Œç¨‹ç·¨è¼¯ =========
    let editingDayIndex = null;
    let editingScheduleIndex = null;

    function openScheduleModal(dayIdx, schedIdx) {
      editingDayIndex = dayIdx;
      editingScheduleIndex = schedIdx;
      const item = tripData.days[dayIdx].schedule[schedIdx];

      scheduleTime.value = item.time || "";
      scheduleTag.value = item.tag || "";
      scheduleTitle.value = item.title || "";
      scheduleSub.value = item.sub || "";
      scheduleNote.value = item.note || "";
      scheduleMap.value = item.map || "";
      if (scheduleImageInput) scheduleImageInput.value = "";

      openModal(scheduleModal);
    }

    if (editTodayBtn) {
      editTodayBtn.addEventListener("click", () => {
        const day = tripData.days[currentDayIndex];
        if (!day || !day.schedule.length) {
          alert("é€™ä¸€å¤©é‚„æ²’æœ‰è¡Œç¨‹å¯ä»¥ç·¨è¼¯ã€‚");
          return;
        }
        openScheduleModal(currentDayIndex, 0);
      });
    }

    if (scheduleSave) {
      scheduleSave.addEventListener("click", () => {
        if (editingDayIndex === null || editingScheduleIndex === null) {
          closeModal(scheduleModal);
          return;
        }
        const item = tripData.days[editingDayIndex].schedule[editingScheduleIndex];
        item.time = scheduleTime.value.trim() || "TBD";
        item.tag = scheduleTag.value.trim() || "TBD";
        item.title = scheduleTitle.value.trim() || "æœªå‘½åè¡Œç¨‹";
        item.sub = scheduleSub.value.trim();
        item.note = scheduleNote.value.trim();
        item.map = scheduleMap.value.trim();

        const afterSave = () => {
          sortScheduleForDay(editingDayIndex);
          saveTripData();
          renderDayContent();
          closeModal(scheduleModal);
        };

        const file = scheduleImageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => {
            item.image = ev.target.result;
            afterSave();
          };
          reader.readAsDataURL(file);
        } else {
          afterSave();
        }
      });
    }

    // ========= 11. å¤©æ°£ç·¨è¼¯ =========
    function openWeatherModal(dayIdx) {
      editingWeatherDayIndex = dayIdx;
      const w = tripData.days[dayIdx].weather;
      weatherStatusInput.value = w.status || "";
      weatherNoteInput.value = w.note || "";
      openModal(weatherModal);
    }

    if (weatherSave) {
      weatherSave.addEventListener("click", () => {
        if (editingWeatherDayIndex === null) {
          closeModal(weatherModal);
          return;
        }
        const w = tripData.days[editingWeatherDayIndex].weather;
        w.status = weatherStatusInput.value.trim() || w.status;
        w.note = weatherNoteInput.value.trim() || w.note;
        saveTripData();
        renderDayContent();
        closeModal(weatherModal);
      });
    }

    // ========= 12. åˆå§‹åŒ– =========
    function init() {
      tripData.days.forEach((_, idx) => sortScheduleForDay(idx));
      renderTabs();
      renderDayContent();
      initRate();
      renderShopping();
      renderExpenses();
      loadHeroBg();
      setView("plan");
    }
    init();
  </script>
</body>
</html>
