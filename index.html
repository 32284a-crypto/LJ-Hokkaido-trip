<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <title>Hokkaido 2025ï½œç›¸è¦ªç›¸æ„›åˆä¸€å¹´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="Hokkaido 2025ï½œç›¸è¦ªç›¸æ„›åˆä¸€å¹´" />
  <meta property="og:description" content="Luna & Jen çš„åŒ—æµ·é“æ»‘é›ªæ—…éŠå°æœ¬ğŸ§£â„ï¸" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f4f8ff;
      color: #123456;
    }
    .app {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      background: #f4f8ff;
    }

    /* ===== è³¼ç‰©æ¸…å–®åœ–ç‰‡ ===== */
    .shopping-img {
      width: 100%;
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 8px;
      border-radius: 10px;
      cursor: zoom-in;
    }
    .shopping-card { overflow: visible; }

    /* é ‚éƒ¨ banner */
    .hero {
      position: relative;
      padding: 16px 16px 20px;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      background-image: url("snowwww.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-color: #e5f1ff;
      color: #123456;
      overflow: hidden;
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(189,227,255,0.9), rgba(229,244,255,0.9));
      pointer-events: none;
    }
    .hero-inner { position: relative; z-index: 1; }
    .hero-title { font-size: 24px; font-weight: 600; letter-spacing: 2px; }
    .hero-sub { margin-top: 4px; font-size: 14px; opacity: 0.9; }

    .hero-bg-icon {
      position: absolute;
      top: 10px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      z-index: 2;
    }

    .hero-nav { display: flex; gap: 10px; margin-top: 14px; }
    .hero-nav-btn {
      width: 42px; height: 42px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
    }
    .hero-nav-btn.active { background: #0b67ff; color: #fff; }

    .hero-toolbar { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .hero-btn {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .hero-btn span { font-size: 14px; }

    .cloud-status { margin-top: 6px; font-size: 11px; }

    .hero-tabs {
      display: flex;
      gap: 8px;
      margin-top: 14px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .day-tab {
      min-width: 80px;
      padding: 8px 10px;
      border-radius: 14px;
      text-align: center;
      font-size: 12px;
      background: rgba(255,255,255,0.8);
      cursor: pointer;
      white-space: nowrap;
    }
    .day-tab.active { background: #0b67ff; color: #fff; font-weight: 600; }

    .content { padding: 16px; padding-bottom: 40px; }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    .card-subtitle { font-size: 12px; opacity: 0.7; }
    .icon {
      width: 20px; height: 20px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: #e6f0ff;
    }

    .weather-main { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
    .weather-temp { display: flex; align-items: baseline; gap: 4px; }
    .weather-temp span:nth-child(1) { font-size: 28px; font-weight: 700; }
    .weather-temp span:nth-child(2) { font-size: 12px; opacity: 0.7; }
    .weather-extra { font-size: 12px; text-align: right; }

    .timeline-item { display: flex; gap: 10px; margin-top: 10px; align-items: flex-start; }
    .timeline-time { font-size: 12px; font-weight: 600; width: 46px; flex-shrink: 0; }
    .timeline-body { flex: 1; }
    .tag { display: inline-block; font-size: 11px; padding: 2px 6px; border-radius: 999px; background: #f0f3ff; margin-bottom: 2px; }
    .timeline-title { font-size: 13px; font-weight: 600; }
    .timeline-sub { font-size: 11px; opacity: 0.8; margin-top: 2px; }
    .timeline-note { font-size: 11px; opacity: 0.7; margin-top: 2px; }
    .timeline-edit { margin-left: 6px; font-size: 12px; cursor: pointer; opacity: 0.7; }
    .timeline-map-link { display: inline-block; font-size: 11px; margin-top: 2px; color: #0b67ff; text-decoration: none; }
    .timeline-map-link::after { content: " â†—"; font-size: 10px; }
    .timeline-img { width: 100%; max-height: 160px; object-fit: cover; border-radius: 12px; margin-top: 6px; cursor: zoom-in; }

    .rate-row { display: flex; align-items: center; justify-content: space-between; margin-top: 6px; font-size: 13px; }
    .rate-row input { width: 45%; padding: 6px 8px; border-radius: 10px; border: 1px solid #d0ddff; font-size: 13px; }
    .rate-meta { font-size: 11px; opacity: 0.7; margin-top: 4px; text-align: right; }

    .shopping-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 8px; }
    .shopping-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-size: 12px;
      position: relative;
    }
    .shopping-name-row { display: flex; justify-content: space-between; align-items: center; gap: 4px; }
    .shopping-name { font-weight: 600; margin-bottom: 4px; }
    .shopping-edit { font-size: 13px; cursor: pointer; opacity: 0.7; }
    .shopping-note { opacity: 0.75; font-size: 11px; margin-top: 2px; }

    .total-card-main { font-size: 18px; font-weight: 700; }
    .total-card-sub { margin-top: 4px; font-size: 12px; opacity: 0.85; }
    .expense-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f2ff; }
    .expense-left { display: flex; align-items: center; gap: 10px; }
    .expense-icon {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: #c5d8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #fff;
      flex-shrink: 0;
    }
    .expense-text-main { font-size: 13px; font-weight: 600; }
    .expense-text-sub { font-size: 11px; opacity: 0.75; margin-top: 2px; }
    .expense-right { text-align: right; font-size: 13px; }
    .expense-delete { color: #ff4d4f; font-size: 14px; cursor: pointer; margin-left: 8px; }

    .pill-group { display: inline-flex; gap: 6px; flex-wrap: wrap; }
    .pill-btn {
      border-radius: 999px;
      border: 1px solid #d0ddff;
      padding: 4px 10px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
    }
    .pill-btn.active { background: #0b67ff; color: #fff; border-color: #0b67ff; }

    .view-section { display: none; }

    .fab {
      position: fixed;
      right: 20px;
      bottom: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #ffd54f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      cursor: pointer;
      z-index: 20;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal-overlay.show { display: flex; }
    .modal { width: 90%; max-width: 360px; background: #fff; border-radius: 18px; padding: 16px 16px 14px; }
    .modal-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; }
    .form-group { margin-bottom: 8px; font-size: 12px; }
    .form-group label { display: block; margin-bottom: 4px; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d0ddff;
      padding: 6px 8px;
      font-size: 13px;
      resize: vertical;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
    .btn { border-radius: 999px; padding: 6px 14px; font-size: 13px; border: none; cursor: pointer; }
    .btn-secondary { background: #f3f5ff; color: #333; }
    .btn-primary { background: #0b67ff; color: #fff; }
    .btn-danger { background: #ffeded; color: #d93025; }

    .footer-space { height: 80px; }
    @media (min-width: 768px) {
      .fab { right: calc(50% - 215px); }
    }

    /* ===== é»åœ–æ”¾å¤§ Viewerï¼ˆä¸€å®šè¦åœ¨ head çš„ styleï¼‰ ===== */
    #imageViewer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #imageViewer.show { display: flex; }
    #imageViewer img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.45);
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="hero" id="hero">
      <div class="hero-overlay"></div>
      <div class="hero-inner">
        <button class="hero-bg-icon" id="changeBgBtn" title="æ›´æ›èƒŒæ™¯">ğŸ¿</button>

        <div class="hero-title">Hokkaido</div>
        <div class="hero-sub">2025 ç›¸è¦ªç›¸æ„›åˆä¸€å¹´</div>

        <div class="hero-nav">
          <button class="hero-nav-btn active" data-view="plan" title="è¡Œç¨‹">ğŸ—ºï¸</button>
          <button class="hero-nav-btn" data-view="fx" title="åŒ¯ç‡">ğŸ’±</button>
          <button class="hero-nav-btn" data-view="shopping" title="è³¼ç‰©æ¸…å–®">ğŸ§º</button>
          <button class="hero-nav-btn" data-view="expense" title="è²»ç”¨ç´€éŒ„">ğŸ’³</button>
        </div>

        <div class="hero-toolbar">
          <button class="hero-btn" id="editTodayBtn">
            <span>âœï¸</span> ç·¨è¼¯ä»Šæ—¥è¡Œç¨‹
          </button>
          <button class="hero-btn" id="syncBtn">
            <span>â˜ï¸</span> é›²ç«¯åŒæ­¥
          </button>
        </div>

        <div class="cloud-status" id="cloudStatusBar">
          é›²ç«¯ç‹€æ…‹ï¼š<span id="cloudStatusText">åˆå§‹åŒ–ä¸­â€¦</span>
        </div>

        <input type="file" id="bgFileInput" accept="image/*" style="display:none" />
        <div class="hero-tabs" id="dayTabs"></div>
      </div>
    </header>

    <main class="content">
      <section id="view-plan">
        <section id="dayContent"></section>
      </section>

      <section id="view-fx" class="view-section">
        <section class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">ğŸ’±</span>åŒ¯ç‡æ›ç®—</div>
            <div class="card-subtitle">JPY â†” TWD</div>
          </div>
          <div class="rate-row">
            <input id="jpyInput" type="number" value="" />
            <span>â‡„</span>
            <input id="twdInput" type="number" value="" />
          </div>
          <div class="rate-meta" id="rateText"></div>
        </section>
      </section>

      <section id="view-shopping" class="view-section">
        <section class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">ğŸ§º</span>è³¼ç‰©æ¸…å–®</div>
            <div class="card-subtitle">å¯ä¾åº—å®¶æˆ–äººä¾†ç®¡ç†</div>
          </div>

          <div class="form-group" style="margin-top:4px;">
            <label style="font-size:12px;">ä¾åº—å®¶ç¯©é¸</label>
            <select id="shoppingStoreFilter" style="width:100%;border-radius:10px;border:1px solid #d0ddff;padding:4px 8px;font-size:13px;">
              <option value="ALL">å…¨éƒ¨åº—å®¶</option>
              <option value="ç„¡å°è‰¯å“">ç„¡å°è‰¯å“</option>
              <option value="Uniqlo">Uniqlo</option>
              <option value="å¤§å‰µ">å¤§å‰µ</option>
              <option value="3COINS">3COINS</option>
              <option value="Hands">Hands</option>
              <option value="è¶…å•†">è¶…å•†ï¼ˆå…±ç”¨ï¼‰</option>
              <option value="7-11">7-11</option>
              <option value="Lawson">Lawson</option>
              <option value="å…¨å®¶">å…¨å®¶</option>
              <option value="è—¥å¦åº—">è—¥å¦åº—</option>
              <option value="æ©Ÿå ´/ä¼´æ‰‹ç¦®">æ©Ÿå ´/ä¼´æ‰‹ç¦®</option>
              <option value="æ»‘é›ªç”¨å“">æ»‘é›ªç”¨å“</option>
              <option value="æœªé¸åˆ†é¡">æœªé¸åˆ†é¡</option>
            </select>
          </div>

          <div class="shopping-grid" id="shoppingGridAll"></div>
        </section>
      </section>

      <section id="view-expense" class="view-section">
        <section class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">ğŸ’³</span>è²»ç”¨ç´€éŒ„</div>
            <div class="card-subtitle">å¯è¨»è¨˜ä»˜æ¬¾äººï¼šLuna / Jen / å…¬åŸºé‡‘</div>
          </div>
          <div class="total-card-main" id="totalJPY">Â¥0</div>
          <div class="total-card-sub" id="totalTWD">ç´„ NT$0</div>
          <div class="total-card-sub" id="settleSummary"></div>
          <div id="expenseList" style="margin-top:10px;"></div>
        </section>
      </section>

      <div class="footer-space"></div>
    </main>
  </div>

  <div class="fab" id="fabBtn">ï¼‹</div>

  <div class="modal-overlay" id="typeModal">
    <div class="modal">
      <div class="modal-title">è¦æ–°å¢ä»€éº¼ï¼Ÿ</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="typeCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="addShoppingBtn">è³¼ç‰©æ¸…å–®</button>
        <button class="btn btn-primary" id="addExpenseBtn">è²»ç”¨</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="shoppingModal">
    <div class="modal">
      <div class="modal-title">æ–°å¢ / ç·¨è¼¯è³¼ç‰©æ¸…å–®</div>
      <div class="form-group">
        <label>å•†å“åç¨±</label>
        <input type="text" id="shoppingName" placeholder="ä¾‹ï¼šå…­èŠ±äº­ å¥¶æ²¹è‘¡è„å¤¾å¿ƒé¤…" />
      </div>
      <div class="form-group">
        <label>åœ¨å“ªè£¡è²·å¾—åˆ°ï¼ˆåº—å®¶ï¼‰</label>
        <select id="shoppingStore">
          <option value="">æœªæŒ‡å®š</option>
          <option value="ç„¡å°è‰¯å“">ç„¡å°è‰¯å“</option>
          <option value="Uniqlo">Uniqlo</option>
          <option value="å¤§å‰µ">å¤§å‰µ</option>
          <option value="3COINS">3COINS</option>
          <option value="Hands">Hands</option>
          <option value="è¶…å•†">è¶…å•†ï¼ˆå…±ç”¨ï¼‰</option>
          <option value="7-11">7-11</option>
          <option value="Lawson">Lawson</option>
          <option value="å…¨å®¶">å…¨å®¶</option>
          <option value="è—¥å¦åº—">è—¥å¦åº—</option>
          <option value="æ©Ÿå ´/ä¼´æ‰‹ç¦®">æ©Ÿå ´/ä¼´æ‰‹ç¦®</option>
          <option value="æ»‘é›ªç”¨å“">æ»‘é›ªç”¨å“</option>
          <option value="æœªé¸åˆ†é¡">æœªé¸åˆ†é¡</option>
        </select>
      </div>
      <div class="form-group">
        <label>å‚™è¨» / å“ªå®¶åˆ†åº—</label>
        <textarea id="shoppingNote" rows="2" placeholder="ä¾‹ï¼šæ–°åƒæ­²æ©Ÿå ´ / æœ­å¹Œæœ¬åº— / å¤šå®¶è—¥å¦åº—éƒ½æœ‰"></textarea>
      </div>
      <div class="form-group">
        <label>èª°è¦è²·ï¼Ÿ</label>
        <select id="shoppingOwner">
          <option value="Luna">Luna</option>
          <option value="Jen">Jen</option>
        </select>
      </div>

      <div class="form-group">
        <label>åœ–ç‰‡ç¶²å€ï¼ˆé¸å¡«ï¼Œå¯æ”¾ GitHub / Google Driveï¼‰</label>
        <input type="text" id="shoppingImageUrl"
               placeholder='ä¾‹ï¼šimages/buttercheesesand.jpg æˆ– https://drive.google.com/uc?export=view&id=xxxx' />
        <div style="margin-top:4px;font-size:11px;color:#666;">
          GitHub åœ–ç‰‡å»ºè­°ç”¨ <b>images/xxx.jpg</b>ï¼›Drive å¿…é ˆæ˜¯å¯ç›´æ¥é¡¯ç¤ºçš„åœ–ç‰‡ç¶²å€æ‰æœƒå‡ºç¾
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" id="shoppingCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="shoppingSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="expenseModal">
    <div class="modal">
      <div class="modal-title">æ–°å¢è²»ç”¨ç´€éŒ„</div>
      <div class="form-group">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="expenseTitle" placeholder="ä¾‹ï¼šç™»åˆ¥æº«æ³‰é£¯åº—" />
      </div>
      <div class="form-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="expenseDate" />
      </div>
      <div class="form-group">
        <label>ä»˜æ¬¾æ–¹å¼ï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="expenseMethod" placeholder="ä¾‹ï¼šä¿¡ç”¨å¡ / ç¾é‡‘ / ç·šä¸Šä»˜æ¬¾" />
      </div>
      <div class="form-group">
        <label>ä»˜æ¬¾äºº</label>
        <div class="pill-group" id="expensePayerGroup">
          <button type="button" class="pill-btn active" data-payer="Luna">Luna</button>
          <button type="button" class="pill-btn" data-payer="Jen">Jen</button>
          <button type="button" class="pill-btn" data-payer="å…¬åŸºé‡‘">å…¬åŸºé‡‘</button>
        </div>
      </div>
      <div class="form-group">
        <label>é‡‘é¡ + å¹£åˆ¥ï¼ˆè¨˜ã€Œç¸½é¡ã€ï¼Œç³»çµ±æœƒå¹«å¿™å¹³åˆ†ï¼‰</label>
        <div style="display:flex;gap:8px;">
          <input type="number" id="expenseAmount" placeholder="é‡‘é¡" />
          <select id="expenseCurrency">
            <option value="JPY">JPY</option>
            <option value="TWD">TWD</option>
          </select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="expenseCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="expenseSave">æ–°å¢</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="weatherModal">
    <div class="modal">
      <div class="modal-title">ç·¨è¼¯ä»Šæ—¥å¤©æ°£æ–‡å­—</div>
      <div class="form-group">
        <label>å¤©æ°£ç‹€æ…‹ï¼ˆå³ä¸Šé‚£è¡Œï¼‰</label>
        <input type="text" id="weatherStatus" placeholder="ä¾‹ï¼šå¸‚å€æ—¥ & æ›é£¯åº—" />
      </div>
      <div class="form-group">
        <label>è£œå……èªªæ˜ï¼ˆå³ä¸‹é‚£è¡Œï¼‰</label>
        <textarea id="weatherNote" rows="2" placeholder="ä¾‹ï¼šç™½å¤©æœ­å¹Œå¸‚å€ & ä½ç›¸éµè–„é‡"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="weatherCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="weatherSave">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- âœ… æ–°å¢ï¼šä»Šæ—¥è¡Œç¨‹ç·¨è¼¯ Modal -->
  <div class="modal-overlay" id="todayModal">
    <div class="modal">
      <div class="modal-title">ç·¨è¼¯ä»Šæ—¥è¡Œç¨‹ï¼ˆ${/* æ–‡å­—åœ¨ JS æœƒè¦†è“‹ */""}ï¼‰</div>

      <div class="form-group">
        <label>é¸æ“‡è¦ç·¨è¼¯çš„è¡Œç¨‹</label>
        <select id="todayItemSelect"></select>
      </div>

      <div class="form-group">
        <label>æ™‚é–“ï¼ˆä¾‹ï¼š09:30ï¼‰</label>
        <input type="text" id="todayTime" placeholder="09:30" />
      </div>

      <div class="form-group">
        <label>æ¨™ç±¤ï¼ˆtagï¼‰</label>
        <input type="text" id="todayTag" placeholder="ä¾‹ï¼šæ™¯é» / åˆé¤ / å›ç¨‹" />
      </div>

      <div class="form-group">
        <label>æ¨™é¡Œï¼ˆtitleï¼‰</label>
        <input type="text" id="todayTitle" placeholder="ä¾‹ï¼šå°æ¨½é‹æ²³" />
      </div>

      <div class="form-group">
        <label>å‰¯æ¨™ï¼ˆsubï¼‰</label>
        <input type="text" id="todaySub" placeholder="ä¾‹ï¼šæ•£æ­¥ Â· æ‹ç…§ Â· è‡ªç”±æ´»å‹•" />
      </div>

      <div class="form-group">
        <label>å‚™è¨»ï¼ˆnoteï¼‰</label>
        <textarea id="todayNote" rows="2" placeholder="ä¾‹ï¼šç”œç”œåœˆæ’å¤ªé•·å¯ç•¥"></textarea>
      </div>

      <div class="form-group">
        <label>åœ°åœ–é€£çµï¼ˆmapï¼Œå¯ç©ºç™½ï¼‰</label>
        <input type="text" id="todayMap" placeholder="https://maps.app.goo.gl/..." />
      </div>

      <div class="form-group">
        <label>åœ–ç‰‡ï¼ˆimageï¼Œå¯ç©ºç™½ï¼›æ”¯æ´ images/xxx.jpg æˆ–å¤–éƒ¨ç¶²å€ï¼‰</label>
        <input type="text" id="todayImage" placeholder="images/xxx.jpg æˆ– https://..." />
      </div>

      <div class="modal-actions" style="justify-content:space-between;">
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" id="todayAdd">ï¼‹ æ–°å¢ä¸€ç­†</button>
          <button class="btn btn-danger" id="todayDelete">åˆªé™¤é€™ä¸€ç­†</button>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" id="todayCancel">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="todaySave">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Viewerï¼šå¿…é ˆæ”¾åœ¨ module script å‰é¢ï¼Œæ‰èƒ½ç¢ºä¿ DOM å·²å­˜åœ¨ -->
  <div id="imageViewer">
    <img id="imageViewerImg" alt="">
  </div>

  <!-- JSï¼šFirebase + App é‚è¼¯ -->
  <script type="module">
  // ===== Firebase åˆå§‹åŒ– =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCBHcwkKj7GcC4HVzzbTYe3Qtpi2UNawc8",
    authDomain: "hokkaido-eaeb1.firebaseapp.com",
    databaseURL: "https://hokkaido-eaeb1-default-rtdb.firebaseio.com",
    projectId: "hokkaido-eaeb1",
    storageBucket: "hokkaido-eaeb1.firebasestorage.app",
    messagingSenderId: "977559624676",
    appId: "1:977559624676:web:65437df8bfa11f895005f1",
    measurementId: "G-QPHE9JZ8HS"
  };

  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  const TRIP_DOC_ID = "hokkaido-2025-main";
  const tripDocRef = doc(db, "trips", TRIP_DOC_ID);

  // âœ… ç‰ˆæœ¬å‡ç´šï¼šå¼·åˆ¶è®“ä½ æœ¬æ©Ÿæ–°è¡Œç¨‹è¦†è“‹èˆŠé›²ç«¯
  const CLOUD_VERSION = 3;

  const cloudStatusTextEl = document.getElementById("cloudStatusText");
  function setCloudStatus(state, text) {
    if (!cloudStatusTextEl) return;
    cloudStatusTextEl.textContent = text;
    const colorMap = { loading: "#666", saving: "#1a73e8", ok: "#137333", error: "#d93025" };
    cloudStatusTextEl.style.color = colorMap[state] || "#555";
  }

  let isSavingCloud = false;
  let unsubscribeSnapshot = null;

  // ===== 1. é è¨­æ—…éŠè³‡æ–™ =====
  const defaultTripData = {
    days: [
      {
        id: "2025-12-24",
        label: "Day1 12/24",
        weather: { temp: -1, low: -6, feels: -8, status: "æŠµé”æ—¥", note: "é…·èˆª TR892 Â· æŠµé”æœ­å¹Œ & ä½ VESSEL" },
        schedule: [
          { time: "09:30", tag: "å»ç¨‹", title: "æ¡ƒåœ’æ©Ÿå ´å ±åˆ°", sub: "TPE Â· é…·èˆª TR892", note: "å»ºè­°èµ·é£›å‰ 3 å°æ™‚åˆ°æ©Ÿå ´", map: "", image: "" },
          { time: "12:30", tag: "å»ç¨‹", title: "TR892 TPE â†’ CTS", sub: "é…·èˆª TR892 12:30 èµ·é£›ï¼Œé è¨ˆ 17:20 æŠµé”", note: "", map: "", image: "" },
          { time: "17:20", tag: "æŠµé”", title: "æ–°åƒæ­²æ©Ÿå ´ (CTS)", sub: "å…¥å¢ƒã€é ˜è¡Œæã€å‰å¾€æœ­å¹Œ", note: "", map: "https://maps.app.goo.gl/", image: "" },
          { time: "19:00", tag: "å…¥ä½", title: "VESSEL HOTEL ä¸­å³¶å…¬åœ’", sub: "12/24â€“12/26 Â· 14:00 å…¥ä½ / 11:00 é€€æˆ¿", note: "", map: "", image: "" },
          { time: "19:15", tag: "è²·è²·è²·", title: "æœ­å¹Œæ±æ€¥ç™¾è²¨", sub: "20:00 7F Uniqloï¼GUï¼Bic Cameraï¼è—¥å¦", note: "", map: "", image: "" },
          { time: "20:50", tag: "æ™šé¤", title: "å¤§é€šå…¬åœ’ è–èª•å¸‚é›†", sub: "", note: "", map: "", image: "" }
        ]
      },
      {
        id: "2025-12-25",
        label: "Day2 12/25",
        weather: { temp: -5, low: -10, feels: -12, status: "Klook ä¸€æ—¥éŠ", note: "æ—­å±±å‹•ç‰©åœ’ + é’æ±  + ç™½é¬šç€‘å¸ƒ + ç²¾éˆéœ²è‡º" },
        schedule: [
          { time: "07:50", tag: "å»ç¨‹", title: "é›†åˆå‡ºç™¼", sub: "æœ­å¹Œ â†’ æ—­å·æ–¹å‘ï¼ˆä¾æ†‘è­‰é›†åˆé»ï¼‰", note: "", map: "", image: "" },
          { time: "10:30", tag: "æ™¯é»", title: "æ—­å±±å‹•ç‰©åœ’", sub: "ç´„ 1 å°æ™‚ 40 åˆ† Â· è‡ªç”±æ´»å‹•", note: "è¡Œç¨‹åŒ…å«æ—­å±±å‹•ç‰©åœ’é–€ç¥¨", map: "", image: "" },
          { time: "13:10", tag: "æ™¯é»", title: "ç™½é‡‘é’æ± ", sub: "ç´„ 15 åˆ†é˜ Â· è‡ªç”±æ´»å‹•", note: "", map: "", image: "" },
          { time: "13:30", tag: "æ™¯é»", title: "ç™½é¬šç€‘å¸ƒ", sub: "ç´„ 25 åˆ†é˜ Â· è‡ªç”±æ´»å‹•", note: "", map: "", image: "" },
          { time: "15:00", tag: "æ™¯é»", title: "æ£®æ—ç²¾éˆéœ²è‡º", sub: "ç´„ 1 å°æ™‚ 20 åˆ† Â· è‡ªç”±æ´»å‹•", note: "", map: "", image: "" },
          { time: "18:30", tag: "å›ç¨‹", title: "è¿”å›æœ­å¹Œ", sub: "å›åˆ°é›†åˆåœ°é»é™„è¿‘è§£æ•£", note: "", map: "", image: "" },
          { time: "21:30", tag: "æ™šé¤", title: "ã‚«ã‚­å°å±‹/å‘³åœ’ç‡’è‚‰", sub: "", note: "æ™šé¤ / å¤œæ™šè¡Œç¨‹ TBD", map: "", image: "" }
        ]
      },
      {
        id: "2025-12-26",
        label: "Day3 12/26",
        weather: { temp: -3, low: -8, feels: -10, status: "å¸‚å€æ—¥ & æ›é£¯åº—", note: "ç™½å¤©æœ­å¹Œå¸‚å€ & ä½ç›¸éµè–„é‡" },
        schedule: [
          // âœ… å»ºè­°ï¼šæ™‚é–“æ¬„ä½è«‹ç”¨ã€ŒHH:MMã€ï¼Œä¸è¦æ··å…¥å€é–“å­—ï¼ˆä¸ç„¶æ’åºæœƒè¢«ä¸Ÿåˆ°æœ€å¾Œï¼‰
          { time: "06:45", tag: "æ—©é¤", title: "è±ç››çš„æ—©é¤", sub: "", note: "", map: "", image: "" },
          { time: "07:50", tag: "æ›é£¯åº—", title: "å‰å¾€ç›¸éµ FRESA INN è–„é‡", sub: "12/26â€“12/29 Â· 15:00 å…¥ä½ / 11:00 é€€æˆ¿", note: "æ­¥è¡Œç´„ 15 åˆ†é˜ï¼ˆå¯å…ˆå¯„æ”¾è¡Œæï¼‰", map: "", image: "" },
          { time: "08:35", tag: "æ™¯é»", title: "åŒ—æµ·é“ç¥å®®", sub: "æ•£æ­¥ Â· åƒç¦é¤…", note: "", map: "", image: "" },
          { time: "09:30", tag: "å’–å•¡", title: "æ£®å½¥å’–å•¡", sub: "", note: "", map: "", image: "" },
          { time: "10:00", tag: "æ™¯é»", title: "åŒ—æµ·é“å»³æœ¬å»³èˆ", sub: "ç´…ç£šå»ºç¯‰ Â· æ‹ç…§æ•£æ­¥", note: "", map: "", image: "" },
          { time: "10:30", tag: "è²·è²·è²·", title: "Montbell", sub: "", note: "", map: "", image: "" },
          { time: "11:00", tag: "åˆé¤", title: "å¥§èŠå•†åº—", sub: "", note: "", map: "", image: "" },
          { time: "11:50", tag: "é»å¿ƒ", title: "Kinotoya å†°æ·‡æ·‹", sub: "", note: "", map: "", image: "" },
          { time: "13:30", tag: "å‡ºç™¼", title: "æœ­å¹Œ â†’ å°æ¨½ï¼ˆJRï¼‰", sub: "", note: "", map: "", image: "" },
          { time: "14:00", tag: "æ™¯é»", title: "å°æ¨½é‹æ²³", sub: "", note: "", map: "", image: "" },
          { time: "14:20", tag: "æ™¯é»", title: "å ºç”ºé€šæ•£ç­–", sub: "", note: "å…­èŠ±äº­å·§å…‹åŠ›ã€LeTAOã€ã‹ã¾æ „ã€æµ…è‰æ©‹ç”œç”œåœˆï¼ˆæ’å¤ªé•·å¯ç•¥ï¼‰", map: "", image: "" },
          { time: "14:30", tag: "æ™¯é»", title: "åŒ—ä¸€ç¡å­ä¸‰è™Ÿé¤¨ï¼‹åŒ—ä¸€ãƒ›ãƒ¼ãƒ«", sub: "", note: "", map: "", image: "" },
          { time: "14:40", tag: "æ™¯é»", title: "éŸ³æ¨‚ç›’å ‚", sub: "", note: "", map: "", image: "" },
          { time: "14:50", tag: "æ™¯é»", title: "èˆ¹è¦‹å‚ï¼ˆæ—¥è½å‰ï¼‰", sub: "", note: "å¾é‹æ²³ä¸€å¸¶æ­è¨ˆç¨‹è»Šç´„ Â¥700", map: "", image: "" },
          { time: "15:30", tag: "æ™šé¤", title: "Cafe BAAL ç‰›æ’é£¯", sub: "", note: "", map: "", image: "" },
          { time: "16:00", tag: "å›ç¨‹", title: "å°æ¨½ â†’ æœ­å¹Œ", sub: "", note: "", map: "", image: "" }
        ]
      },
      {
        id: "2025-12-27",
        label: "Day4 12/27",
        weather: { temp: -6, low: -12, feels: -15, status: "æ»‘é›ªæ—¥", note: "é›ªé•·å§ Â· æ‰‹ç¨»æ»‘é›ªå ´" },
        schedule: [
          { time: "07:00", tag: "å‡ºç™¼", title: "æœ­å¹Œ â†’ æ‰‹ç¨»æ»‘é›ªå ´", sub: "æ­ JR / å·´å£«ï¼ˆä¾å¯¦éš›å®‰æ’ï¼‰", note: "å‰ä¸€å¤©å…ˆç¢ºèªè»Šç­æ™‚é–“", map: "", image: "" },
          { time: "09:00", tag: "æ»‘é›ª", title: "é›†åˆ & ç§Ÿè£å‚™", sub: "æ‰‹ç¨»æ»‘é›ªå ´ Â· èˆ‡æ•™ç·´æœƒåˆ", note: "", map: "", image: "" },
          { time: "10:00", tag: "æ»‘é›ª", title: "æ»‘é›ªæ•™å­¸ & è‡ªç”±æ»‘", sub: "ä¸­åˆé›ªå ´ç”¨é¤", note: "", map: "", image: "" },
          { time: "17:30", tag: "æ™šé¤", title: "NAGOYAKAäº­", sub: "å£½å¸", note: "", map: "", image: "" },
          { time: "18:30", tag: "è²·è²·è²·", title: "Alpen", sub: "", note: "", map: "", image: "" },
          { time: "20:00", tag: "é»å¿ƒ", title: "GELATERIA La Giostra", sub: "é‡‘ã€åœŸ 20:00â€“00:00", note: "", map: "", image: "" }
        ]
      },
      {
        id: "2025-12-28",
        label: "Day5 12/28",
        weather: { temp: -6, low: -12, feels: -15, status: "è‡ªç”±æ»‘é›ª / è‡ªç”±è¡Œ", note: "çœ‹ç‹€æ³å†æ±ºå®šè¦å»å“ªè£¡ç©é›ªæˆ–å¸‚å€é€›è¡—" },
        schedule: [{ time: "09:00", tag: "TBD", title: "è‡ªç”±æ»‘é›ª or å¸‚å€è¡Œç¨‹", sub: "ä¹‹å¾Œå†æ±ºå®šç´°ç¯€", note: "", map: "", image: "" }]
      },
      {
        id: "2025-12-29",
        label: "Day6 12/29",
        weather: { temp: -3, low: -8, feels: -10, status: "å›ç¨‹æ—¥", note: "æ”¶æ‹¾è¡Œæ + æ©Ÿå ´æ¡è²·" },
        schedule: [
          { time: "11:00", tag: "é€€æˆ¿", title: "é€€æˆ¿ Â· ç›¸éµ FRESA INN è–„é‡", sub: "æœ€æ™š 11:00 é€€æˆ¿", note: "", map: "", image: "" },
          { time: "12:00", tag: "å‰å¾€æ©Ÿå ´", title: "æœ­å¹Œ â†’ æ–°åƒæ­²æ©Ÿå ´", sub: "æ­ JR / å·´å£«å‰å¾€ CTS", note: "é ç•™æ™‚é–“é€›æ©Ÿå ´ & è²·ä¼´æ‰‹ç¦®", map: "", image: "" },
          { time: "13:55", tag: "å›ç¨‹", title: "FD243 CTS â†’ TPE", sub: "Airasia FD243 13:55 èµ·é£›ï¼Œé è¨ˆ 17:55 æŠµé”", note: "", map: "", image: "" }
        ]
      }
    ],
    fx: { rate: 0.215 },

    defaultShopping: [
      { id: "s-muji-01", owner: "Luna", store: "ç„¡å°è‰¯å“", name: "ç¦å‰èŒ¶", note: "" },
      { id: "s-daiso-01", owner: "Luna", store: "å¤§å‰µ", name: "æŠ˜ç–Šæ¢³å­", note: "" },
      { id: "s-airport-01", owner: "Luna", store: "æ©Ÿå ´/ä¼´æ‰‹ç¦®", name: "Butter Cheese Sand", note: "", image: "images/buttercheesesand.jpg" },
      { id: "s-3c-01", owner: "Luna", store: "3COINS", name: "æ—…è¡Œæ”¶ç´è¢‹", note: "" },
      { id: "s-3c-02", owner: "Luna", store: "3COINS", name: "å¤šåŠŸèƒ½å¾®æ³¢èª¿ç†çƒ¤ç›¤", note: "" },
      { id: "s-3c-03", owner: "Luna", store: "3COINS", name: "æ¯›æ¯›æ‰‹å¥—", note: "" },
      { id: "s-3c-04", owner: "Luna", store: "3COINS", name: "ç‹—ç‹—è£", note: "" },
      { id: "s-cosmestic-01", owner: "Luna", store: "è—¥å¦åº—", name: "EXLIR", note: "" },
      { id: "s-Family-04", owner: "Luna", store: "å…¨å®¶", name: "å¥é”å‡ºå¥‡è›‹çš®å…‹æ•", note: "" },
      { id: "s-711-01", owner: "Luna", store: "7-11", name: "å¸¶çš®è–¯æ¢", note: "" },
      { id: "s-711-02", owner: "Luna", store: "7-11", name: "è˜­å§†è‘¡è„é¤…ä¹¾", note: "" },
      { id: "s-lawson-01", owner: "Luna", store: "Lawson", name: "é»ƒè±†ç²‰ç¶œåˆå …æœ", note: "" },
      { id: "s-family-01", owner: "Luna", store: "å…¨å®¶", name: "Calbeeå¥¶æ²¹æ´‹èŠ‹ç‰‡", note: "" },
      { id: "s-family-02", owner: "Luna", store: "å…¨å®¶", name: "åŠç”Ÿæ°´èœœæ¡ƒä¹¾", note: "" },
      { id: "s-cosmestic-02", owner: "Luna", store: "è—¥å¦åº—", name: "lululun", note: "" },
      { id: "s-cosmestic-03", owner: "Luna", store: "è—¥å¦åº—", name: "é«®æ²¹", note: "" },
      { id: "s-cosmestic-04", owner: "Luna", store: "è—¥å¦åº—", name: "canmakeç«æ¯›åˆ·", note: "" },
      { id: "s-cosmestic-05", owner: "Luna", store: "è—¥å¦åº—", name: "canmakeç€æµ·èœœç²‰", note: "" },
      { id: "s-cosmestic-06", owner: "Luna", store: "è—¥å¦åº—", name: "å£ç½©", note: "æ¾æœ¬æ¸…only" },
      { id: "s-cosmestic-07", owner: "Luna", store: "è—¥å¦åº—", name: "E+Bå˜´çš°ç–¹", note: "" },
      { id: "s-cosmestic-08", owner: "Luna", store: "è—¥å¦åº—", name: "è­·æ‰‹éœœ", note: "" },
      { id: "s-cosmestic-09", owner: "Luna", store: "è—¥å¦åº—", name: "ç¾ç™½éŒ ", note: "" },
      { id: "s-cosmestic-10", owner: "Luna", store: "è—¥å¦åº—", name: "è¶³åº•", note: "" },
      { id: "s-cosmestic-11", owner: "Luna", store: "è—¥å¦åº—", name: "æ‰‹ä¹¾è£‚", note: "" },
      { id: "s-cosmestic-12", owner: "Luna", store: "è—¥å¦åº—", name: "æ¶²é«”è…®ç´…", note: "" },
      { id: "s-airport-02", owner: "Luna", store: "æ©Ÿå ´/ä¼´æ‰‹ç¦®", name: "Royce", note: "é–‹å¿ƒæœç”¢å“" },
      { id:"s-cosmetic-13", owner:"Luna", store:"è—¥å¦åº—", name:"è¶³åº•èˆ’ç·©ï¼ˆä¹¾ï¼‰", note:"", image:"images/footdry.jpg" },
      { id:"s-cosmetic-14", owner:"Luna", store:"è—¥å¦åº—", name:"è¶³åº•èˆ’ç·©ï¼ˆæ”¾é¬†ï¼‰", note:"", image:"images/footrelease.jpg" },
      { id:"s-cosmetic-15", owner:"Luna", store:"è—¥å¦åº—", name:"äº®ç™½ä¿é¤Š", note:"", image:"images/brightskin.jpg" },
      { id:"s-cosmetic-16", owner:"Luna", store:"è—¥å¦åº—", name:"ä¿æ¿•é¢è†œ", note:"", image:"images/moistmask1.jpg" },
      { id:"s-cosmetic-17", owner:"Luna", store:"è—¥å¦åº—", name:"é«˜ä¿æ¿•ä¿®è­·", note:"", image:"images/keepmoist2.jpg" },
      { id:"s-snack-01", owner:"Luna", store:"è¶…å•†", name:"å¥¶æ²¹æ´‹èŠ‹ç‰‡", note:"", image:"images/chipsshrimp.jpg" },
      { id:"s-uncat-01", owner:"Luna", store:"æœªé¸åˆ†é¡", name:"è³‡ç”Ÿå ‚ç²‰åº•æ¶²", note:"", image:"images/shlseidofoundation.jpg" },
      { id:"s-uncat-03", owner:"Luna", store:"æœªé¸åˆ†é¡", name:"Chanel å”‡é‡‰", note:"", image:"images/channellip.jpg" },
      { id:"s-cosmetic-18", owner:"Luna", store:"è—¥å¦åº—", name:"ç€æµ·æ•‘æ˜Ÿ", note:"", image:"images/dryband.jpg" },
      { id:"s-cosmetic-19", owner:"Luna", store:"è—¥å¦åº—", name:"è­·æ‰‹éœœï¼ˆå¤šæ¬¾ï¼‰", note:"", image:"images/allkindshand.jpg" },
      { id:"s-cosmetic-20", owner:"Luna", store:"è—¥å¦åº—", name:"è­·æ‰‹éœœ Aesopå‘³!", note:"", image:"images/likeAesop.jpg" },

      { id: "s-family-03", owner: "Luna", store: "å…¨å®¶", name: "é®­é­šè‚‰ä¹¾", note: "" },

      // âš ï¸ å»ºè­°ä½ æŠŠæœ‰ç©ºç™½çš„æª”åæ”¹æ‰ï¼šle labo.jpg â†’ le-labo.jpg
      { id:"s-uncat-02", owner:"Luna", store:"æœªé¸åˆ†é¡", name:"Le Labo è­·æ‰‹éœœ", note:"", image:"images/le-labo.jpg" }
    ],

    defaultExpenses: [
      { id: "e-flight", title: "æ©Ÿç¥¨", date: "2025-09-01", method: "Luna å…ˆä»˜ NT$28,296", amount: 28296, currency: "TWD", payer: "Luna" }
    ]
  };

  // ===== 2. localStorage å·¥å…· =====
  const TRIP_KEY = "hk_trip_data_v3";
  const SHOP_KEY = "hk_shopping_v3";
  const EXP_KEY  = "hk_expenses_v4";
  const HERO_BG_KEY = "hk_hero_bg_v2";

  const safeParse = str => { try { return JSON.parse(str); } catch { return null; } };

  function loadTripData() { const data = localStorage.getItem(TRIP_KEY); return data ? safeParse(data) : null; }
  function loadShopping() {
    const data = localStorage.getItem(SHOP_KEY);
    if (data) return safeParse(data) || defaultTripData.defaultShopping;
    return defaultTripData.defaultShopping;
  }
  function loadExpenses() {
    const data = localStorage.getItem(EXP_KEY);
    if (data) return safeParse(data) || defaultTripData.defaultExpenses;
    return defaultTripData.defaultExpenses;
  }

  let tripData = loadTripData() || defaultTripData;
  let shoppingList = loadShopping();
  let expenseList = loadExpenses();

  function buildCloudPayload() {
    const cleanShopping = (shoppingList || []).map(item => {
      const { imageData, ...rest } = item;
      return rest;
    });
    return { v: CLOUD_VERSION, tripData, shoppingList: cleanShopping, expenseList };
  }

  let cloudSaveTimer = null;
  function scheduleSaveToCloud() {
    if (cloudSaveTimer) clearTimeout(cloudSaveTimer);
    cloudSaveTimer = setTimeout(saveToCloudNow, 1500);
  }

  async function saveToCloudNow() {
    try {
      isSavingCloud = true;
      setCloudStatus("saving", "å„²å­˜åˆ°é›²ç«¯ä¸­â€¦");
      await setDoc(tripDocRef, buildCloudPayload(), { merge: true });
      isSavingCloud = false;
      setCloudStatus("ok", "å·²èˆ‡é›²ç«¯åŒæ­¥");
    } catch (err) {
      console.error("saveToCloud error", err);
      isSavingCloud = false;
      setCloudStatus("error", "é›²ç«¯å„²å­˜å¤±æ•—ï¼Œä»¥æœ¬æ©Ÿè³‡æ–™ç‚ºä¸»");
    }
  }

  // âœ… ç‰ˆæœ¬ä¸åŒï¼šç›´æ¥ç”¨æœ¬æ©Ÿè¦†è“‹é›²ç«¯ï¼ˆè§£æ±ºï¼šä½ æ”¹äº† defaultTripData ä½†ç•«é¢ä¸è®Šï¼‰
  async function initCloudSync() {
    setCloudStatus("loading", "é›²ç«¯è®€å–ä¸­â€¦");
    try {
      const snap = await getDoc(tripDocRef);
      if (snap.exists()) {
        const data = snap.data();

        if (data.v === CLOUD_VERSION) {
          if (data.tripData) tripData = data.tripData;
          if (data.shoppingList) shoppingList = data.shoppingList;
          if (data.expenseList) expenseList = data.expenseList;

          localStorage.setItem(TRIP_KEY, JSON.stringify(tripData));
          localStorage.setItem(SHOP_KEY, JSON.stringify(shoppingList));
          localStorage.setItem(EXP_KEY, JSON.stringify(expenseList));

          renderTabs(); renderDayContent(); renderShopping(); renderExpenses();
          setCloudStatus("ok", "å·²å¾é›²ç«¯è¼‰å…¥æœ€æ–°è³‡æ–™");
        } else {
          // âœ… é—œéµï¼šé›²ç«¯ç‰ˆæœ¬èˆŠ â†’ ä»¥æœ¬æ©Ÿ(ä½ é€™ä»½ code)ç‚ºä¸»ï¼Œç›´æ¥è¦†è“‹é›²ç«¯
          setCloudStatus("ok", "åµæ¸¬åˆ°é›²ç«¯ç‰ˆæœ¬èˆŠï¼Œå·²æ”¹ç”¨æœ¬æ©Ÿè³‡æ–™è¦†è“‹é›²ç«¯");
          await saveToCloudNow();
          renderTabs(); renderDayContent(); renderShopping(); renderExpenses();
        }
      } else {
        await saveToCloudNow();
        setCloudStatus("ok", "å·²å»ºç«‹æ–°çš„é›²ç«¯è³‡æ–™");
      }

      if (unsubscribeSnapshot) unsubscribeSnapshot();
      unsubscribeSnapshot = onSnapshot(tripDocRef, snap2 => {
        if (!snap2.exists()) return;
        if (isSavingCloud) return;

        const data2 = snap2.data();
        if (data2.v !== CLOUD_VERSION) return;

        tripData     = data2.tripData     || tripData;
        shoppingList = data2.shoppingList || shoppingList;
        expenseList  = data2.expenseList  || expenseList;

        localStorage.setItem(TRIP_KEY, JSON.stringify(tripData));
        localStorage.setItem(SHOP_KEY, JSON.stringify(shoppingList));
        localStorage.setItem(EXP_KEY, JSON.stringify(expenseList));

        renderTabs(); renderDayContent(); renderShopping(); renderExpenses();
        setCloudStatus("ok", "å·²èˆ‡é›²ç«¯åŒæ­¥ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰");
      });

    } catch (err) {
      console.error("initCloudSync error", err);
      setCloudStatus("error", "é›²ç«¯è®€å–å¤±æ•—ï¼Œä»¥æœ¬æ©Ÿè³‡æ–™ç‚ºä¸»");
    }
  }

  function saveTripData() { localStorage.setItem(TRIP_KEY, JSON.stringify(tripData)); scheduleSaveToCloud(); }
  function saveShopping() { localStorage.setItem(SHOP_KEY, JSON.stringify(shoppingList)); scheduleSaveToCloud(); }
  function saveExpenses() { localStorage.setItem(EXP_KEY, JSON.stringify(expenseList)); scheduleSaveToCloud(); }

  // ===== 3. è¡Œç¨‹ & Tabs =====
  const dayTabsEl = document.getElementById("dayTabs");
  const dayContentEl = document.getElementById("dayContent");
  let currentDayIndex = 0;

  function getTimeValue(t) {
    if (!t) return 24 * 60 + 59;
    const m = /^(\d{1,2}):(\d{2})$/.exec(t.trim());
    if (!m) return 24 * 60 + 59;
    const h = parseInt(m[1], 10), min = parseInt(m[2], 10);
    if (h < 0 || h > 23 || min < 0 || min > 59) return 24 * 60 + 59;
    return h * 60 + min;
  }

  function sortScheduleForDay(dayIdx) {
    const day = tripData.days[dayIdx];
    if (!day || !day.schedule) return;
    day.schedule.sort((a, b) => getTimeValue(a.time) - getTimeValue(b.time));
  }

  function renderTabs() {
    dayTabsEl.innerHTML = "";
    tripData.days.forEach((day, idx) => {
      const tab = document.createElement("div");
      tab.className = "day-tab" + (idx === currentDayIndex ? " active" : "");
      tab.textContent = day.label;
      tab.onclick = () => { currentDayIndex = idx; renderTabs(); renderDayContent(); };
      dayTabsEl.appendChild(tab);
    });
  }

  function renderDayContent() {
    const day = tripData.days[currentDayIndex];
    if (!day) return;
    sortScheduleForDay(currentDayIndex);

    let html = `
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="icon">â„ï¸</span>
            ${day.weather.temp}â„ƒ / ${day.weather.low}â„ƒ
          </div>
          <div style="text-align:right;">
            <div class="card-subtitle">${day.weather.status}</div>
            <span class="timeline-edit weather-edit" data-day="${currentDayIndex}">âœï¸</span>
          </div>
        </div>
        <div class="weather-main">
          <div class="weather-temp">
            <span>${day.weather.temp}Â°</span>
            <span>é«”æ„Ÿ ${day.weather.feels}Â°C</span>
          </div>
          <div class="weather-extra">
            <div>${day.weather.status}</div>
            <div>${day.weather.note}</div>
          </div>
        </div>
      </section>
    `;

    html += `
      <section class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ—“</span>ä»Šæ—¥è¡Œç¨‹</div>
          <div class="card-subtitle">${day.label}</div>
        </div>
        ${day.schedule.map((item) => {
          const imgSrc = (item.image || "").trim();
          const safeImg = imgSrc ? encodeURI(imgSrc) : "";
          return `
            <div class="timeline-item">
              <div class="timeline-time">${item.time}</div>
              <div class="timeline-body">
                <div><span class="tag">${item.tag}</span></div>
                <div class="timeline-title">${item.title}</div>
                <div class="timeline-sub">${item.sub || ""}</div>
                ${item.note ? `<div class="timeline-note">${item.note}</div>` : ""}
                ${item.map ? `<a href="${item.map}" target="_blank" class="timeline-map-link">ğŸ—ºï¸ Google åœ°åœ–</a>` : ""}
                ${safeImg ? `<img class="timeline-img" src="${safeImg}" data-full="${safeImg}" alt="" onerror="this.style.display='none'">` : ""}
              </div>
            </div>
          `;
        }).join("")}
      </section>
    `;

    dayContentEl.innerHTML = html;

    document.querySelectorAll(".weather-edit").forEach(btn => {
      btn.addEventListener("click", () => {
        const d = parseInt(btn.dataset.day, 10);
        openWeatherModal(d);
      });
    });
  }

  // ===== 4. åŒ¯ç‡ =====
  const jpyInput = document.getElementById("jpyInput");
  const twdInput = document.getElementById("twdInput");
  const rateText = document.getElementById("rateText");

  function updateFromJPY() {
    const jpy = parseFloat(jpyInput.value || "0");
    const twd = Math.round(jpy * tripData.fx.rate);
    twdInput.value = twd;
  }
  function updateFromTWD() {
    const twd = parseFloat(twdInput.value || "0");
    const jpy = Math.round(twd / tripData.fx.rate);
    jpyInput.value = jpy;
  }
  if (jpyInput && twdInput) {
    jpyInput.addEventListener("input", updateFromJPY);
    twdInput.addEventListener("input", updateFromTWD);
  }
  function initRate() {
    if (!rateText) return;
    rateText.textContent = `ç¤ºæ„åŒ¯ç‡ï¼š1 JPY â‰ˆ ${tripData.fx.rate} TWD`;
    updateFromJPY();
  }

  // ===== 5. è³¼ç‰©æ¸…å–®ï¼ˆåœ–ç‰‡å¤±æ•—å°±éš±è—ï¼Œé¿å…å•è™Ÿï¼‰ =====
  const shoppingGridAllEl = document.getElementById("shoppingGridAll");
  const shoppingStoreFilter = document.getElementById("shoppingStoreFilter");
  let editingShoppingId = null;

  function renderShopping() {
    if (!shoppingGridAllEl) return;

    const storeFilter = shoppingStoreFilter ? shoppingStoreFilter.value : "ALL";
    let items = shoppingList || [];
    if (storeFilter !== "ALL") items = items.filter(i => i.store === storeFilter);

    shoppingGridAllEl.innerHTML = items.map(item => {
      const rawSrc = (item.image || item.imageUrl || "").trim();
      const imgSrc = rawSrc ? encodeURI(rawSrc) : "";
      return `
        <div class="shopping-card">
          <div class="shopping-name-row">
            <div class="shopping-name">${item.name || ""}</div>
            <span class="shopping-edit" data-id="${item.id}">âœï¸</span>
          </div>
          <div class="shopping-note">
            ${item.store ? `ğŸª ${item.store}` : ""}${item.owner ? ` Â· ğŸ‘¤ ${item.owner}` : ""}
          </div>
          ${item.note ? `<div class="shopping-note">${item.note}</div>` : ""}
          ${imgSrc ? `<img class="shopping-img" src="${imgSrc}" alt="" data-full="${imgSrc}" onerror="this.style.display='none'">` : ""}
        </div>
      `;
    }).join("");

    document.querySelectorAll(".shopping-edit").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const item = shoppingList.find(i => i.id === id);
        if (!item) return;

        editingShoppingId = id;
        shoppingName.value = item.name || "";
        shoppingNote.value = item.note || "";
        shoppingOwner.value = item.owner || "Luna";
        shoppingStore.value = item.store || "";
        shoppingImageUrl.value = item.imageUrl || item.image || "";
        openModal(shoppingModal);
      });
    });
  }

  // ===== 6. è²»ç”¨ç´€éŒ„ =====
  const expenseListEl = document.getElementById("expenseList");
  const totalJPYEl = document.getElementById("totalJPY");
  const totalTWDEl = document.getElementById("totalTWD");

  function payerColor(p) {
    switch (p) {
      case "Luna": return "#ffb6c1";
      case "Jen": return "#90caf9";
      case "å…¬åŸºé‡‘": return "#a5d6a7";
      default: return "#78909c";
    }
  }

  function calcTotalsAndSettlement() {
    let totalJPY = 0;
    const rate = tripData.fx.rate;
    const people = ["Luna", "Jen"];
    const balances = { Luna: { paid: 0, should: 0 }, Jen: { paid: 0, should: 0 } };

    expenseList.forEach(item => {
      let amountTWD = item.currency === "JPY" ? item.amount * rate : item.amount;
      if (item.currency === "JPY") totalJPY += item.amount;
      else totalJPY += amountTWD / rate;

      const share = amountTWD / people.length;
      people.forEach(p => { balances[p].should += share; });

      if (item.payer === "Luna") balances.Luna.paid += amountTWD;
      else if (item.payer === "Jen") balances.Jen.paid += amountTWD;
    });

    const totalTWD = Math.round(totalJPY * rate);
    totalJPYEl.textContent = "Â¥" + Math.round(totalJPY).toLocaleString();
    totalTWDEl.textContent = "ç´„ NT$" + totalTWD.toLocaleString();

    const settleEl = document.getElementById("settleSummary");
    if (!settleEl) return;

    const lText = `Lunaï¼šå¯¦ä»˜ NT$${Math.round(balances.Luna.paid).toLocaleString()} / æ‡‰ä»˜ NT$${Math.round(balances.Luna.should).toLocaleString()}`;
    const jText = `Jenï¼šå¯¦ä»˜ NT$${Math.round(balances.Jen.paid).toLocaleString()} / æ‡‰ä»˜ NT$${Math.round(balances.Jen.should).toLocaleString()}`;

    const netLuna = balances.Luna.paid - balances.Luna.should;
    const diff = Math.round(netLuna);

    let settleLine = "";
    if (Math.abs(diff) < 10) settleLine = "ç›®å‰å¹¾ä¹å¹³æ‰‹ï¼Œä¸ç”¨äº’ç›¸è½‰å¸³ï½";
    else if (diff > 0) settleLine = `Jen å¤§ç´„éœ€è¦çµ¦ Luna NT$${diff.toLocaleString()}`;
    else settleLine = `Luna å¤§ç´„éœ€è¦çµ¦ Jen NT$${Math.abs(diff).toLocaleString()}`;

    settleEl.innerHTML = `${lText}<br>${jText}<br><b>${settleLine}</b>`;
  }

  function renderExpenses() {
    if (!expenseListEl) return;
    expenseListEl.innerHTML = expenseList.map(item => `
      <div class="expense-item">
        <div class="expense-left">
          <div class="expense-icon" style="background:${payerColor(item.payer)};">
            ${item.payer || ""}
          </div>
          <div>
            <div class="expense-text-main">${item.title}</div>
            <div class="expense-text-sub">
              ${item.date || ""}${item.method ? " Â· " + item.method : ""}${item.payer ? " Â· " + item.payer : ""}
            </div>
          </div>
        </div>
        <div class="expense-right">
          <div>${item.currency === "JPY" ? "Â¥" : "NT$"}${item.amount.toLocaleString()}</div>
          <span class="expense-delete" data-id="${item.id}">âœ•</span>
        </div>
      </div>
    `).join("");

    document.querySelectorAll(".expense-delete").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        expenseList = expenseList.filter(e => e.id !== id);
        saveExpenses();
        renderExpenses();
      });
    });

    calcTotalsAndSettlement();
  }

  // ===== 7. Hero èƒŒæ™¯ï¼ˆåªåœ¨æœ¬æ©Ÿï¼‰ =====
  const heroEl = document.getElementById("hero");
  const changeBgBtn = document.getElementById("changeBgBtn");
  const bgFileInput = document.getElementById("bgFileInput");

  function loadHeroBg() {
    const bg = localStorage.getItem(HERO_BG_KEY);
    if (bg && heroEl) heroEl.style.backgroundImage = `url(${bg})`;
  }
  if (changeBgBtn && bgFileInput) {
    changeBgBtn.addEventListener("click", () => bgFileInput.click());
    bgFileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const dataUrl = ev.target.result;
        heroEl.style.backgroundImage = `url(${dataUrl})`;
        localStorage.setItem(HERO_BG_KEY, dataUrl);
      };
      reader.readAsDataURL(file);
    });
  }

  // ===== 8. View åˆ‡æ› =====
  const viewPlan = document.getElementById("view-plan");
  const viewFx = document.getElementById("view-fx");
  const viewShopping = document.getElementById("view-shopping");
  const viewExpense = document.getElementById("view-expense");
  const heroNavButtons = document.querySelectorAll(".hero-nav-btn");

  const viewMap = { plan: viewPlan, fx: viewFx, shopping: viewShopping, expense: viewExpense };

  function setView(view) {
    Object.entries(viewMap).forEach(([key, el]) => {
      if (!el) return;
      el.style.display = key === view ? "block" : "none";
    });
    heroNavButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.view === view));
  }
  heroNavButtons.forEach(btn => btn.addEventListener("click", () => setView(btn.dataset.view)));

  // ===== 9. Modal & æ–°å¢ =====
  const fabBtn = document.getElementById("fabBtn");
  const typeModal = document.getElementById("typeModal");
  const typeCancel = document.getElementById("typeCancel");
  const addShoppingBtn = document.getElementById("addShoppingBtn");
  const addExpenseBtn = document.getElementById("addExpenseBtn");

  const shoppingModal = document.getElementById("shoppingModal");
  const shoppingCancel = document.getElementById("shoppingCancel");
  const shoppingSave = document.getElementById("shoppingSave");
  const shoppingName = document.getElementById("shoppingName");
  const shoppingNote = document.getElementById("shoppingNote");
  const shoppingOwner = document.getElementById("shoppingOwner");
  const shoppingStore = document.getElementById("shoppingStore");
  const shoppingImageUrl = document.getElementById("shoppingImageUrl");

  const expenseModal = document.getElementById("expenseModal");
  const expenseCancel = document.getElementById("expenseCancel");
  const expenseSave = document.getElementById("expenseSave");
  const expenseTitle = document.getElementById("expenseTitle");
  const expenseDate = document.getElementById("expenseDate");
  const expenseMethod = document.getElementById("expenseMethod");
  const expenseAmount = document.getElementById("expenseAmount");
  const expenseCurrency = document.getElementById("expenseCurrency");
  const expensePayerGroup = document.getElementById("expensePayerGroup");
  let currentExpensePayer = "Luna";

  const weatherModal = document.getElementById("weatherModal");
  const weatherCancel = document.getElementById("weatherCancel");
  const weatherSave = document.getElementById("weatherSave");
  const weatherStatusInput = document.getElementById("weatherStatus");
  const weatherNoteInput = document.getElementById("weatherNote");
  let editingWeatherDayIndex = null;

  const syncBtn = document.getElementById("syncBtn");

  let lastScrollY = 0;
  const openModal = m => {
    if (!m) return;
    lastScrollY = window.scrollY || window.pageYOffset || 0;
    m.classList.add("show");
    document.body.style.overflow = "hidden";
  };
  const closeModal = m => {
    if (!m) return;
    m.classList.remove("show");
    document.body.style.overflow = "";
    window.scrollTo({ top: lastScrollY, behavior: "auto" });
  };

  if (fabBtn) fabBtn.addEventListener("click", () => openModal(typeModal));
  if (typeCancel) typeCancel.addEventListener("click", () => closeModal(typeModal));

  if (addShoppingBtn) {
    addShoppingBtn.addEventListener("click", () => {
      closeModal(typeModal);
      editingShoppingId = null;
      shoppingName.value = "";
      shoppingNote.value = "";
      shoppingOwner.value = "Luna";
      shoppingStore.value = "";
      shoppingImageUrl.value = "";
      openModal(shoppingModal);
    });
  }

  if (addExpenseBtn) {
    addExpenseBtn.addEventListener("click", () => {
      closeModal(typeModal);
      expenseTitle.value = "";
      expenseMethod.value = "";
      expenseAmount.value = "";
      expenseCurrency.value = "JPY";
      currentExpensePayer = "Luna";
      const today = new Date().toISOString().slice(0,10);
      expenseDate.value = today;
      Array.from(expensePayerGroup.querySelectorAll(".pill-btn")).forEach(btn => {
        btn.classList.toggle("active", btn.dataset.payer === "Luna");
      });
      openModal(expenseModal);
    });
  }

  if (shoppingCancel) shoppingCancel.addEventListener("click", () => closeModal(shoppingModal));
  if (expenseCancel) expenseCancel.addEventListener("click", () => closeModal(expenseModal));
  if (weatherCancel) weatherCancel.addEventListener("click", () => closeModal(weatherModal));

  if (expensePayerGroup) {
    expensePayerGroup.addEventListener("click", e => {
      const btn = e.target.closest(".pill-btn");
      if (!btn) return;
      currentExpensePayer = btn.dataset.payer;
      Array.from(expensePayerGroup.querySelectorAll(".pill-btn")).forEach(b => b.classList.toggle("active", b === btn));
    });
  }

  if (shoppingSave) {
    shoppingSave.addEventListener("click", () => {
      const name = shoppingName.value.trim();
      if (!name) { alert("è«‹è¼¸å…¥å•†å“åç¨±"); return; }

      const note = shoppingNote.value.trim();
      const owner = shoppingOwner.value || "Luna";
      const store = shoppingStore.value || "";
      const inputUrl = shoppingImageUrl.value.trim();

      const existingItem = editingShoppingId ? shoppingList.find(i => i.id === editingShoppingId) : null;

      const isLocalImage = /^images\//i.test(inputUrl);
      const nextImage = isLocalImage ? inputUrl : "";
      const nextImageUrl = isLocalImage ? "" : inputUrl;

      if (editingShoppingId && existingItem) {
        existingItem.name = name;
        existingItem.note = note;
        existingItem.owner = owner;
        existingItem.store = store;
        if (inputUrl) {
          existingItem.image = nextImage;
          existingItem.imageUrl = nextImageUrl;
        }
      } else {
        shoppingList.push({
          id: "s" + Date.now(),
          owner,
          store,
          name,
          note,
          image: nextImage,
          imageUrl: nextImageUrl
        });
      }

      saveShopping();
      renderShopping();
      editingShoppingId = null;
      closeModal(shoppingModal);
    });
  }

  if (expenseSave) {
    expenseSave.addEventListener("click", () => {
      const title = expenseTitle.value.trim();
      if (!title) { alert("è«‹è¼¸å…¥é …ç›®åç¨±"); return; }
      const amount = parseFloat(expenseAmount.value || "0");
      if (!amount || amount <= 0) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; }

      expenseList.push({
        id: "e" + Date.now(),
        title,
        date: expenseDate.value,
        method: expenseMethod.value.trim(),
        amount,
        currency: expenseCurrency.value,
        payer: currentExpensePayer
      });

      saveExpenses();
      renderExpenses();
      closeModal(expenseModal);
    });
  }

  function openWeatherModal(dayIdx) {
    editingWeatherDayIndex = dayIdx;
    const w = tripData.days[dayIdx].weather;
    weatherStatusInput.value = w.status || "";
    weatherNoteInput.value = w.note || "";
    openModal(weatherModal);
  }

  if (weatherSave) {
    weatherSave.addEventListener("click", () => {
      if (editingWeatherDayIndex === null) { closeModal(weatherModal); return; }
      const w = tripData.days[editingWeatherDayIndex].weather;
      w.status = weatherStatusInput.value.trim() || w.status;
      w.note = weatherNoteInput.value.trim() || w.note;
      saveTripData();
      renderDayContent();
      closeModal(weatherModal);
    });
  }

  if (syncBtn) syncBtn.addEventListener("click", () => saveToCloudNow());

  // ===== é»åœ–ç‰‡ => æ”¾å¤§ï¼›é»é»‘åº• / ESC => é—œé–‰ï¼ˆè³¼ç‰© + è¡Œç¨‹éƒ½æ”¯æ´ï¼‰ =====
  const imageViewer = document.getElementById("imageViewer");
  const imageViewerImg = document.getElementById("imageViewerImg");

  function openImageViewer(src) {
    if (!imageViewer || !imageViewerImg) return;
    imageViewerImg.src = src;
    imageViewer.classList.add("show");
  }
  function closeImageViewer() {
    if (!imageViewer || !imageViewerImg) return;
    imageViewer.classList.remove("show");
    imageViewerImg.src = "";
  }

  if (imageViewer) {
    imageViewer.addEventListener("click", closeImageViewer);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeImageViewer();
    });
  }

  // è³¼ç‰©åœ–ç‰‡
  if (shoppingGridAllEl) {
    shoppingGridAllEl.addEventListener("click", (e) => {
      const img = e.target.closest(".shopping-img");
      if (!img) return;
      openImageViewer(img.dataset.full || img.src);
    });
  }

  // è¡Œç¨‹åœ–ç‰‡
  if (dayContentEl) {
    dayContentEl.addEventListener("click", (e) => {
      const img = e.target.closest(".timeline-img");
      if (!img) return;
      openImageViewer(img.dataset.full || img.src);
    });
  }

  // ===== 12. åˆå§‹åŒ– =====
  function init() {
    tripData.days.forEach((_, idx) => sortScheduleForDay(idx));
    renderTabs();
    renderDayContent();
    initRate();
    renderShopping();
    renderExpenses();
    loadHeroBg();
    setView("plan");
    initCloudSync();
  }
  init();
  </script>
</body>
</html>
